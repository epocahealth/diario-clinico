<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diario Clinico Pro</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --cream:#f5f0e8;--warm:#faf8f4;--teal:#2d7a6e;--teal-l:#3d9b8c;--teal-p:#e8f4f2;
  --rust:#c0522a;--rust-l:#f0ede8;--ink:#1a1a2e;--ink-m:#3a3a5c;--ink-li:#7a7a9a;
  --gold:#d4a843;--green:#4caf7d;--purple:#6b5b95;--border:#e0dbd0;
  --shadow:0 2px 20px rgba(26,26,46,.08);--shadow-d:0 8px 40px rgba(26,26,46,.14);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;}

/* HEADER */
header{background:var(--ink);color:var(--cream);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 24px rgba(26,26,46,.3);position:sticky;top:0;z-index:50;}
header h1{font-family:'DM Serif Display',serif;font-size:1.5rem;letter-spacing:-.02em;}
.header-accent{color:#3d9b8c;}
.header-right{display:flex;gap:10px;align-items:center;}
.btn-export-all{padding:7px 16px;background:var(--gold);color:var(--ink);border:none;border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;transition:all .2s;}
.btn-export-all:hover{background:#c49030;color:white;}

/* TABS NAV */
.app-tabs{display:flex;background:var(--ink-m);border-bottom:2px solid rgba(255,255,255,.1);}
.tab-btn{padding:11px 20px;background:none;border:none;color:rgba(255,255,255,.6);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:500;transition:all .2s;border-bottom:2px solid transparent;margin-bottom:-2px;}
.tab-btn.active{color:var(--teal-l);border-bottom-color:var(--teal-l);background:rgba(61,155,140,.08);}
.tab-btn:hover:not(.active){color:white;}

/* LAYOUT */
.container{max-width:1300px;margin:0 auto;padding:24px 20px;display:grid;grid-template-columns:280px 1fr;gap:20px;align-items:start;}
.tab-content{display:none;}.tab-content.active{display:block;}

/* SIDEBAR */
.sidebar{background:var(--warm);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;position:sticky;top:88px;}
.sidebar-header{background:var(--teal);color:white;padding:15px 18px;font-size:.85rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;}
.sidebar-search{padding:10px 14px;border-bottom:1px solid var(--border);}
.sidebar-search input{width:100%;padding:7px 11px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.85rem;background:var(--cream);outline:none;transition:border-color .2s;}
.sidebar-search input:focus{border-color:var(--teal);}
.patient-list{max-height:420px;overflow-y:auto;}
.patient-item{padding:12px 18px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;display:flex;align-items:center;gap:10px;}
.patient-item:hover{background:var(--teal-p);}
.patient-item.active{background:var(--teal-p);border-left:3px solid var(--teal);}
.patient-avatar{width:34px;height:34px;border-radius:50%;background:var(--teal);color:white;font-weight:600;font-size:.8rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.patient-info{min-width:0;}
.patient-name{font-weight:500;font-size:.875rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.patient-meta{font-size:.72rem;color:var(--ink-li);}
.btn-add-patient{width:calc(100% - 28px);margin:10px 14px;padding:9px;background:var(--ink);color:white;border:none;border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:500;transition:background .2s;display:flex;align-items:center;justify-content:center;gap:5px;}
.btn-add-patient:hover{background:var(--ink-m);}

/* MAIN */
.main-panel{display:flex;flex-direction:column;gap:16px;}
.card{background:var(--warm);border-radius:14px;box-shadow:var(--shadow);overflow:hidden;}
.card-header{padding:16px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
.card-header h2{font-family:'DM Serif Display',serif;font-size:1.1rem;}
.card-body{padding:20px 22px;}

/* PATIENT HEADER */
.patient-hdr .card-header{background:linear-gradient(135deg,var(--ink) 0%,var(--ink-m) 100%);color:white;}
.patient-hdr .card-header h2{color:white;font-size:1.3rem;}
.ptags{display:flex;gap:6px;flex-wrap:wrap;margin-top:3px;}
.ptag{font-size:.7rem;padding:2px 9px;border-radius:20px;font-weight:500;background:rgba(255,255,255,.15);color:rgba(255,255,255,.85);}

/* TREATMENT BUTTONS */
.treat-title{font-size:.75rem;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-li);margin-bottom:12px;font-weight:600;}
.treat-btns{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px;}
.treat-btn{padding:14px 24px;border-radius:10px;border:2px solid var(--border);background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:500;color:var(--ink-m);transition:all .2s;display:flex;align-items:center;gap:8px;min-width:140px;}
.treat-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-p);}
.treat-btn.selected{border-color:var(--teal);background:var(--teal);color:white;box-shadow:0 4px 14px rgba(45,122,110,.35);}
.treat-btn.selected-pae{border-color:var(--purple);background:var(--purple);color:white;box-shadow:0 4px 14px rgba(107,91,149,.35);}
.treat-btn.pae:hover{border-color:var(--purple);color:var(--purple);background:#f0edf7;}

/* EXPANDABLE PANEL */
.expand-panel{display:none;animation:slideDown .25s ease;margin-top:4px;}
.expand-panel.visible{display:block;}
@keyframes slideDown{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

/* PRODUCT GRID */
.prod-section-title{font-size:.78rem;font-weight:600;color:var(--ink-m);margin:14px 0 8px;padding:4px 10px;background:var(--cream);border-radius:6px;display:flex;align-items:center;gap:6px;}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-bottom:4px;}
.product-item{display:flex;align-items:center;gap:9px;padding:10px 12px;border-radius:9px;border:2px solid var(--border);background:white;cursor:pointer;transition:all .15s;user-select:none;}
.product-item:hover{border-color:var(--teal-l);background:var(--teal-p);}
.product-item.checked{border-color:var(--teal);background:var(--teal-p);}
.product-item.checked .check-box{background:var(--teal);border-color:var(--teal);}
.product-item.checked .check-box::after{content:'‚úì';color:white;}
.check-box{width:20px;height:20px;border-radius:5px;border:2px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;transition:all .15s;}
.prod-label{font-size:.82rem;font-weight:500;color:var(--ink);line-height:1.3;}
.prod-dose{font-size:.68rem;color:var(--ink-li);margin-top:1px;}
.product-manage-btn{margin-top:12px;padding:7px 14px;background:none;border:1px dashed var(--border);border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.78rem;color:var(--ink-li);transition:all .2s;display:flex;align-items:center;gap:5px;}
.product-manage-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-p);}

/* NOTES */
.notes-area{width:100%;min-height:70px;padding:10px 12px;border:1px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.875rem;color:var(--ink);background:var(--cream);resize:vertical;outline:none;transition:border-color .2s;}
.notes-area:focus{border-color:var(--teal);}
.divider{height:1px;background:var(--border);margin:16px 0;}

/* SAVE */
.btn-save{padding:12px 28px;background:var(--teal);color:white;border:none;border-radius:9px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:600;transition:all .2s;box-shadow:0 4px 14px rgba(45,122,110,.3);display:flex;align-items:center;gap:6px;}
.btn-save:hover{background:var(--teal-l);transform:translateY(-1px);}
.actions-row{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-top:14px;}

/* HISTORY */
.history-item{padding:14px 18px;border-radius:10px;border:1px solid var(--border);background:white;display:flex;gap:14px;align-items:flex-start;margin-bottom:10px;transition:box-shadow .2s;}
.history-item:hover{box-shadow:var(--shadow);}
.history-date{min-width:85px;font-size:.75rem;font-weight:600;color:var(--teal);padding-top:2px;}
.history-content{flex:1;}
.history-badges{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:5px;}
.badge{font-size:.7rem;padding:2px 8px;border-radius:16px;font-weight:600;}
.badge-gae{background:#e8f4f2;color:var(--teal);border:1px solid var(--teal);}
.badge-flebo{background:#fdf0e8;color:var(--rust);border:1px solid var(--rust);}
.badge-pae{background:#f0edf7;color:var(--purple);border:1px solid var(--purple);}
.badge-prod{background:#f5f5ff;color:#5555aa;border:1px solid #aaaadd;font-size:.65rem;}
.badge-pain{background:#fff3e0;color:#e65100;border:1px solid #e65100;}
.history-notes{font-size:.78rem;color:var(--ink-li);margin-top:3px;font-style:italic;}
.history-del{background:none;border:none;cursor:pointer;color:var(--ink-li);font-size:.9rem;padding:2px 5px;border-radius:4px;transition:color .15s,background .15s;}
.history-del:hover{color:var(--rust);background:var(--rust-l);}

/* EMPTY */
.empty-state{text-align:center;padding:50px 24px;color:var(--ink-li);}
.empty-state .emoji{font-size:2.5rem;margin-bottom:10px;}
.empty-state p{font-size:.875rem;}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,26,46,.55);backdrop-filter:blur(4px);z-index:200;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--warm);border-radius:14px;padding:28px;width:500px;max-width:96vw;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-d);animation:popIn .2s ease;}
@keyframes popIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
.modal h3{font-family:'DM Serif Display',serif;font-size:1.2rem;margin-bottom:18px;}
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:.82rem;font-weight:500;color:var(--ink-m);margin-bottom:5px;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.875rem;background:var(--cream);color:var(--ink);outline:none;transition:border-color .2s;}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--teal);}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}
.btn-cancel{padding:9px 18px;background:none;border:1px solid var(--border);border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.875rem;color:var(--ink-m);transition:all .15s;}
.btn-cancel:hover{background:var(--cream);}
.btn-confirm{padding:9px 22px;background:var(--teal);color:white;border:none;border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.875rem;font-weight:600;transition:all .2s;}
.btn-confirm:hover{background:var(--teal-l);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--ink);color:white;padding:11px 18px;border-radius:9px;font-size:.85rem;font-weight:500;box-shadow:var(--shadow-d);opacity:0;transform:translateY(10px);transition:all .3s;z-index:300;display:flex;align-items:center;gap:7px;}
.toast.show{opacity:1;transform:translateY(0);}
.toast.success{background:var(--teal);}
.toast.warning{background:var(--gold);color:var(--ink);}

/* ===================== LONGEVITY SCREENING ===================== */
.longevity-container{padding:20px 22px;}
.longevity-section{margin-bottom:24px;}
.longevity-section-title{font-family:'DM Serif Display',serif;font-size:1rem;color:var(--teal);margin-bottom:14px;padding-bottom:6px;border-bottom:2px solid var(--teal-p);}
.question-group{margin-bottom:14px;}
.question-label{font-size:.85rem;font-weight:500;color:var(--ink-m);margin-bottom:8px;display:flex;align-items:flex-start;gap:6px;}
.question-label .q-code{font-size:.7rem;background:var(--teal-p);color:var(--teal);padding:2px 7px;border-radius:10px;font-weight:600;flex-shrink:0;margin-top:1px;}
.scale-btns{display:flex;gap:5px;flex-wrap:wrap;}
.scale-btn{padding:6px 12px;border:2px solid var(--border);border-radius:7px;background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;color:var(--ink-m);transition:all .15s;min-width:44px;text-align:center;}
.scale-btn:hover{border-color:var(--teal);color:var(--teal);}
.scale-btn.sel{border-color:var(--teal);background:var(--teal);color:white;}
.scale-labels{display:flex;justify-content:space-between;font-size:.68rem;color:var(--ink-li);margin-top:4px;padding:0 2px;}
.number-input{width:80px;padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.875rem;background:var(--cream);outline:none;}
.number-input:focus{border-color:var(--teal);}
.select-input{padding:7px 10px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.875rem;background:var(--cream);outline:none;}
.select-input:focus{border-color:var(--teal);}
.yn-btns{display:flex;gap:8px;}
.yn-btn{padding:7px 20px;border:2px solid var(--border);border-radius:7px;background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:500;color:var(--ink-m);transition:all .15s;}
.yn-btn:hover{border-color:var(--teal);}
.yn-btn.sel-yes{border-color:#e74c3c;background:#e74c3c;color:white;}
.yn-btn.sel-no{border-color:var(--green);background:var(--green);color:white;}

/* SCORE DISPLAY */
.score-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin:16px 0;}
.score-card{background:white;border-radius:10px;padding:14px;border:1px solid var(--border);text-align:center;}
.score-card .sc-label{font-size:.72rem;color:var(--ink-li);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px;}
.score-card .sc-value{font-family:'DM Serif Display',serif;font-size:1.8rem;color:var(--teal);}
.score-card .sc-status{font-size:.72rem;font-weight:600;margin-top:4px;padding:2px 8px;border-radius:10px;display:inline-block;}
.st-green{background:#e8f5e9;color:#2e7d32;}
.st-yellow{background:#fff8e1;color:#f57f17;}
.st-orange{background:#fff3e0;color:#e65100;}
.st-red{background:#ffebee;color:#c62828;}
.readiness-bar{height:12px;background:var(--border);border-radius:6px;margin:8px 0;overflow:hidden;}
.readiness-fill{height:100%;border-radius:6px;transition:width .5s ease;background:linear-gradient(90deg,#e74c3c,#f39c12,#2ecc71);}

/* ===================== PAIN SCALE ===================== */
.pain-container{padding:20px 22px;}
.pain-section-title{font-family:'DM Serif Display',serif;font-size:1rem;color:var(--rust);margin-bottom:14px;padding-bottom:6px;border-bottom:2px solid #f5e6e0;}
.pain-nrs{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.pain-btn{width:52px;height:52px;border-radius:10px;border:2px solid var(--border);background:white;cursor:pointer;font-family:'DM Serif Display',serif;font-size:1.1rem;font-weight:600;color:var(--ink-m);transition:all .15s;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.pain-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1);}
.pain-btn.sel{color:white;border-color:transparent;}
.pain-0{background:#e8f5e9;color:#2e7d32 !important;}
.pain-0.sel{background:#2e7d32;color:white !important;}
.pain-1,.pain-2{background:#f1f8e9;}
.pain-1.sel,.pain-2.sel{background:#7cb342;color:white !important;}
.pain-3,.pain-4{background:#fff8e1;}
.pain-3.sel,.pain-4.sel{background:#fbc02d;color:white !important;}
.pain-5,.pain-6{background:#fff3e0;}
.pain-5.sel,.pain-6.sel{background:#fb8c00;color:white !important;}
.pain-7,.pain-8{background:#fce4ec;}
.pain-7.sel,.pain-8.sel{background:#e53935;color:white !important;}
.pain-9,.pain-10{background:#ffebee;}
.pain-9.sel,.pain-10.sel{background:#b71c1c;color:white !important;}
.pain-labels{display:flex;justify-content:space-between;font-size:.68rem;color:var(--ink-li);margin-bottom:16px;}
.pain-qualitative{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px;margin-bottom:16px;}
.pain-qual-item{padding:9px 12px;border-radius:8px;border:2px solid var(--border);background:white;cursor:pointer;transition:all .15s;}
.pain-qual-item:hover{border-color:var(--rust);background:var(--rust-l);}
.pain-qual-item.checked{border-color:var(--rust);background:var(--rust-l);}
.pain-qual-item.checked .check-box{background:var(--rust);border-color:var(--rust);}
.pain-qual-item.checked .check-box::after{content:'‚úì';color:white;}
.pain-qual-label{font-size:.82rem;font-weight:500;}
.pain-qual-desc{font-size:.7rem;color:var(--ink-li);margin-top:2px;}
.pain-timing{display:flex;gap:8px;flex-wrap:wrap;}
.timing-btn{padding:6px 14px;border:2px solid var(--border);border-radius:7px;background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;color:var(--ink-m);transition:all .15s;}
.timing-btn:hover{border-color:var(--rust);}
.timing-btn.sel{border-color:var(--rust);background:var(--rust);color:white;}

/* Lead Intent section */
.lead-section{background:linear-gradient(135deg,#f8f4ff 0%,#ede8f8 100%);border-radius:10px;padding:16px;margin-top:16px;border:1px solid #d5ccf0;}
.lead-title{font-size:.78rem;font-weight:600;color:var(--purple);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;}

/* Export buttons */
.btn-export{padding:9px 18px;background:var(--gold);color:var(--ink);border:none;border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;transition:all .2s;display:flex;align-items:center;gap:5px;}
.btn-export:hover{background:#c49030;color:white;}

/* Date bar */
.date-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.date-bar label{font-size:.82rem;color:var(--ink-li);font-weight:500;}
.date-bar input[type="date"]{padding:6px 11px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.85rem;background:var(--cream);color:var(--ink);outline:none;}
.date-bar input[type="date"]:focus{border-color:var(--teal);}
.btn-today{padding:6px 13px;background:var(--teal-p);color:var(--teal);border:1px solid var(--teal);border-radius:7px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;transition:all .2s;}
.btn-today:hover{background:var(--teal);color:white;}

/* ===================== SCHEDA DEL GIORNO ===================== */
.scheda-page { display: flex; flex-direction: column; gap: 16px; }
.scheda-header-card { background: linear-gradient(135deg, var(--ink) 0%, var(--ink-m) 100%); border-radius: 14px; padding: 24px 28px; color: white; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; box-shadow: var(--shadow-d); }
.scheda-patient-name { font-family: 'DM Serif Display', serif; font-size: 1.8rem; margin-bottom: 6px; }
.scheda-date-line { font-size: .9rem; color: rgba(255,255,255,.7); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.scheda-date-line input[type="date"] { background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.3); border-radius: 7px; padding: 5px 10px; color: white; font-family: 'DM Sans', sans-serif; font-size: .85rem; outline: none; cursor: pointer; }
.scheda-date-line input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
.scheda-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
.scheda-meta-item { font-size: .78rem; background: rgba(255,255,255,.12); padding: 4px 12px; border-radius: 20px; }
.scheda-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.btn-scheda-print { padding: 8px 18px; background: rgba(255,255,255,.15); color: white; border: 1px solid rgba(255,255,255,.35); border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: .82rem; font-weight: 500; transition: all .2s; display: flex; align-items: center; gap: 5px; }
.btn-scheda-print:hover { background: rgba(255,255,255,.28); }

.scheda-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.scheda-section { background: var(--warm); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
.scheda-section.full-width { grid-column: 1 / -1; }
.scheda-sec-header { padding: 13px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.scheda-sec-header h3 { font-size: .92rem; font-weight: 600; color: var(--ink); display: flex; align-items: center; gap: 7px; }
.scheda-sec-body { padding: 16px 20px; }
.scheda-empty { color: var(--ink-li); font-size: .82rem; font-style: italic; }

.treat-chips { display: flex; gap: 8px; flex-wrap: wrap; }
.treat-chip { padding: 7px 18px; border-radius: 20px; font-size: .85rem; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.chip-gae { background: var(--teal-p); color: var(--teal); border: 1.5px solid var(--teal); }
.chip-flebo { background: #fdf0e8; color: var(--rust); border: 1.5px solid var(--rust); }
.chip-pae { background: #f0edf7; color: var(--purple); border: 1.5px solid var(--purple); }
.chip-none { background: var(--cream); color: var(--ink-li); border: 1.5px solid var(--border); font-style: italic; font-weight: 400; }

.prod-pill-list { display: flex; flex-wrap: wrap; gap: 6px; }
.prod-pill { background: #f0f0ff; color: #4444aa; border: 1px solid #ccccee; border-radius: 16px; padding: 4px 12px; font-size: .78rem; font-weight: 500; }
.prod-pill-cat { background: var(--cream); color: var(--ink-li); border: 1px solid var(--border); border-radius: 16px; padding: 3px 10px; font-size: .72rem; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; align-self: center; }

.pain-summary-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
.pain-nrs-big { width: 64px; height: 64px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'DM Serif Display', serif; font-size: 2rem; font-weight: 700; flex-shrink: 0; }
.pain-nrs-label { font-size: .82rem; color: var(--ink-li); }
.pain-nrs-desc { font-size: .95rem; font-weight: 600; }

.longevity-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; }
.lv-mini-card { background: var(--cream); border-radius: 9px; padding: 10px 12px; text-align: center; border: 1px solid var(--border); }
.lv-mini-label { font-size: .65rem; color: var(--ink-li); text-transform: uppercase; letter-spacing: .05em; margin-bottom: 4px; }
.lv-mini-value { font-family: 'DM Serif Display', serif; font-size: 1.4rem; }
.lv-mini-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 5px; overflow: hidden; }
.lv-mini-fill { height: 100%; border-radius: 2px; }

.notes-display { background: var(--cream); border-radius: 9px; padding: 12px 14px; font-size: .875rem; color: var(--ink); line-height: 1.6; border-left: 3px solid var(--teal); min-height: 40px; }
.notes-display.empty { color: var(--ink-li); font-style: italic; border-left-color: var(--border); }

.scheda-timeline { display: flex; flex-direction: column; gap: 0; }
.timeline-item { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
.timeline-item:last-child { border-bottom: none; }
.timeline-dot { width: 10px; height: 10px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
.timeline-content { flex: 1; font-size: .85rem; }
.timeline-label { font-weight: 600; color: var(--ink); }
.timeline-detail { color: var(--ink-li); font-size: .78rem; margin-top: 2px; }

.no-data-day { text-align: center; padding: 40px 20px; }
.no-data-day .big-icon { font-size: 3rem; margin-bottom: 12px; }
.no-data-day p { color: var(--ink-li); font-size: .9rem; }
.no-data-day .btn-go { margin-top: 14px; padding: 10px 22px; background: var(--teal); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-weight: 600; font-size: .875rem; transition: background .2s; }
.no-data-day .btn-go:hover { background: var(--teal-l); }

@media print {
  header, .app-tabs, .sidebar, .scheda-actions, .btn-scheda-print, .btn-export, .btn-save { display: none !important; }
  .container { grid-template-columns: 1fr !important; padding: 0 !important; }
  .scheda-grid { grid-template-columns: 1fr 1fr; }
  body { background: white; }
  .scheda-header-card { background: var(--ink) !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
}

@media(max-width:700px){ .scheda-grid { grid-template-columns: 1fr; } }

/* ===================== ANDAMENTO / CHARTS ===================== */
.trend-page { display: flex; flex-direction: column; gap: 16px; }
.trend-header { background: linear-gradient(135deg, #1a1a2e 0%, #2d3561 100%); border-radius: 14px; padding: 20px 26px; color: white; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
.trend-header h2 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; }
.trend-header p { font-size: .82rem; color: rgba(255,255,255,.6); margin-top: 3px; }
.trend-controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.trend-range-btn { padding: 5px 13px; border: 1px solid rgba(255,255,255,.3); border-radius: 20px; background: none; color: rgba(255,255,255,.7); cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: .78rem; transition: all .2s; }
.trend-range-btn.active { background: rgba(255,255,255,.2); color: white; border-color: rgba(255,255,255,.6); }

.trend-summary-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; }
.trend-kpi { background: var(--warm); border-radius: 12px; padding: 16px 18px; box-shadow: var(--shadow); border-left: 3px solid var(--teal); }
.trend-kpi .kpi-label { font-size: .72rem; color: var(--ink-li); text-transform: uppercase; letter-spacing: .06em; margin-bottom: 6px; }
.trend-kpi .kpi-value { font-family: 'DM Serif Display', serif; font-size: 1.7rem; color: var(--ink); }
.trend-kpi .kpi-delta { font-size: .75rem; font-weight: 600; margin-top: 3px; }
.kpi-up { color: #2e7d32; } .kpi-down { color: #c62828; } .kpi-same { color: var(--ink-li); }

.charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.chart-card { background: var(--warm); border-radius: 14px; box-shadow: var(--shadow); overflow: hidden; }
.chart-card.wide { grid-column: 1 / -1; }
.chart-header { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.chart-header h3 { font-size: .9rem; font-weight: 600; color: var(--ink); }
.chart-header span { font-size: .72rem; color: var(--ink-li); }
.chart-body { padding: 16px 18px; position: relative; }
.chart-canvas-wrap { position: relative; height: 220px; }
.chart-canvas-wrap.tall { height: 280px; }
.chart-no-data { text-align: center; padding: 40px 20px; color: var(--ink-li); font-size: .85rem; }

/* TREATMENT FREQUENCY DOTS */
.treat-freq-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); gap: 4px; }
.freq-dot { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: .65rem; cursor: default; transition: transform .1s; }
.freq-dot:hover { transform: scale(1.2); z-index: 2; }
.dot-empty { background: var(--cream); border: 1px solid var(--border); }
.dot-gae { background: var(--teal-p); border: 1px solid var(--teal); }
.dot-flebo { background: #fdf0e8; border: 1px solid var(--rust); }
.dot-pae { background: #f0edf7; border: 1px solid var(--purple); }
.dot-multi { background: #fff8e1; border: 1px solid var(--gold); }

/* SHARE MODAL */
.share-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
.share-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
.share-section h4 { font-size: .9rem; font-weight: 600; color: var(--ink); margin-bottom: 10px; }
.share-section p { font-size: .82rem; color: var(--ink-li); margin-bottom: 10px; line-height: 1.5; }
.share-option { display: flex; gap: 10px; align-items: center; padding: 12px 14px; border: 1px solid var(--border); border-radius: 9px; margin-bottom: 8px; cursor: pointer; transition: all .15s; background: white; }
.share-option:hover { border-color: var(--teal); background: var(--teal-p); }
.share-option .so-icon { font-size: 1.4rem; }
.share-option .so-text strong { display: block; font-size: .875rem; }
.share-option .so-text span { font-size: .75rem; color: var(--ink-li); }
.sync-info { background: var(--teal-p); border: 1px solid var(--teal); border-radius: 9px; padding: 12px 14px; font-size: .82rem; color: var(--teal); margin-bottom: 10px; line-height: 1.5; }
.warning-info { background: #fff8e1; border: 1px solid var(--gold); border-radius: 9px; padding: 10px 14px; font-size: .8rem; color: #7a5c00; line-height: 1.5; }

@media(max-width:700px){ .charts-grid { grid-template-columns: 1fr; } }
/* ===================== QUESTIONARI ===================== */
.q-page{padding:24px;}
.q-page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.q-page-header h2{font-family:'DM Serif Display',serif;font-size:1.4rem;color:var(--ink);}
.q-date-label{background:var(--teal-p);color:var(--teal);padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;}
.q-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;}
.q-card{background:var(--warm);border:1.5px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all .2s;}
.q-card:hover{border-color:var(--teal);box-shadow:0 4px 20px rgba(45,122,110,.12);}
.q-card.q-done{border-color:var(--teal);background:#f0faf8;}
.q-card-header{display:flex;align-items:center;gap:10px;}
.q-icon{font-size:1.4rem;width:36px;text-align:center;}
.q-card-title{flex:1;}
.q-card-title strong{display:block;font-size:.9rem;color:var(--ink);}
.q-desc{font-size:.75rem;color:var(--ink-li);}
.q-status{flex-shrink:0;}
.q-badge-done{background:#e8f5e9;color:#2e7d32;padding:3px 10px;border-radius:20px;font-size:.72rem;font-weight:600;}
.q-badge-todo{background:var(--teal-p);color:var(--teal);padding:3px 10px;border-radius:20px;font-size:.72rem;}
.q-score-preview{margin-top:10px;padding-top:10px;border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:6px;}
.q-chip{background:white;border:1px solid var(--border);padding:3px 10px;border-radius:20px;font-size:.75rem;color:var(--ink-m);}
.q-chip-green{background:#e8f5e9;color:#2e7d32;border-color:#c8e6c9;}
.q-chip-yellow{background:#fff8e1;color:#f57f17;border-color:#fff176;}
.q-chip-orange{background:#fff3e0;color:#e65100;border-color:#ffcc80;}
.q-chip-red{background:#ffebee;color:#c62828;border-color:#ffcdd2;}
/* Modal */
.q-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1000;display:flex;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto;}
.q-modal{background:white;border-radius:16px;width:100%;max-width:760px;padding:28px;position:relative;margin:auto;}
.q-modal-close{position:absolute;top:16px;right:16px;background:var(--border);border:none;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;}
.q-form-header h3{font-family:'DM Serif Display',serif;font-size:1.3rem;color:var(--ink);margin-bottom:8px;}
.q-intro{font-size:.83rem;color:var(--ink-m);margin-bottom:18px;line-height:1.5;background:var(--teal-p);padding:10px 14px;border-radius:8px;}
.q-items{display:flex;flex-direction:column;gap:10px;max-height:65vh;overflow-y:auto;padding-right:6px;}
.q-item{display:flex;gap:12px;padding:12px;border-radius:10px;border:1.5px solid var(--border);transition:border-color .2s;}
.q-item.q-item-answered{border-color:var(--teal);background:#f9fffe;}
.q-item-num{width:26px;height:26px;background:var(--teal-p);color:var(--teal);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;flex-shrink:0;}
.q-item-body{flex:1;}
.q-prefix{font-size:.72rem;color:var(--ink-li);text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:2px;}
.q-item-text{font-size:.875rem;color:var(--ink);margin-bottom:8px;line-height:1.4;}
.q-opts-row{display:flex;flex-wrap:wrap;gap:6px;}
.q-opt-btn{padding:5px 12px;border:1.5px solid var(--border);border-radius:20px;background:white;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.78rem;color:var(--ink-m);transition:all .15s;}
.q-opt-btn:hover{border-color:var(--teal);color:var(--teal);}
.q-opt-btn.selected{background:var(--teal);color:white;border-color:var(--teal);}
.q-num-input{width:100px;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none;}
.q-num-input:focus{border-color:var(--teal);}
.q-slider-row{display:flex;align-items:center;gap:8px;}
.q-slider{flex:1;accent-color:var(--teal);}
.q-slider-val{min-width:40px;font-weight:600;color:var(--teal);font-size:.85rem;}
.q-slider-label{font-size:.72rem;color:var(--ink-li);}
.q-form-footer{margin-top:20px;display:flex;gap:10px;justify-content:flex-end;position:sticky;bottom:0;background:white;padding:12px 0 0;}
.q-save-btn{padding:10px 24px;background:var(--teal);color:white;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;}
.q-save-btn:hover{background:var(--teal-l);}
.q-error{background:#ffebee;color:#c62828;padding:12px 16px;border-radius:8px;font-size:.85rem;margin:10px 0;}
/* PhenoAge */
.q-pheno-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:16px 0;}
.q-pheno-field label{display:block;font-size:.78rem;font-weight:600;color:var(--ink-m);margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;}
.q-pheno-input-row{display:flex;align-items:center;gap:8px;}
.q-pheno-input{flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none;}
.q-pheno-input:focus{border-color:var(--teal);}
.q-pheno-unit{font-size:.78rem;color:var(--ink-li);min-width:50px;}
.q-pheno-hint{font-size:.72rem;color:var(--ink-li);}
.pheno-result-card{background:linear-gradient(135deg,var(--ink) 0%,#2d3561 100%);border-radius:12px;padding:20px;margin:16px 0;color:white;}
.pheno-result-main{display:flex;gap:20px;margin-bottom:14px;}
.pheno-result-item{flex:1;text-align:center;}
.pheno-label{display:block;font-size:.72rem;color:rgba(255,255,255,.6);margin-bottom:4px;}
.pheno-value{font-size:1.6rem;font-weight:700;font-family:'DM Serif Display',serif;}
.pheno-value small{font-size:.7rem;font-weight:400;opacity:.7;}
.pheno-interp{background:rgba(255,255,255,.1);border-radius:8px;padding:10px 14px;font-size:.83rem;}
/* Referti */
.upload-area{border:2.5px dashed var(--border);border-radius:14px;padding:32px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:12px;}
.upload-area:hover,.upload-area.drag-over{border-color:var(--teal);background:var(--teal-p);}
.upload-icon{font-size:2rem;margin-bottom:8px;}
.upload-label{font-size:.95rem;font-weight:600;color:var(--ink);margin-bottom:4px;}
.upload-sub{font-size:.78rem;color:var(--ink-li);}
.upload-tip{background:#fff8e1;border-left:3px solid var(--gold);padding:10px 14px;border-radius:0 8px 8px 0;font-size:.82rem;color:#7a5c00;margin-bottom:16px;}
.referti-list{display:flex;flex-direction:column;gap:12px;}
.referti-empty{text-align:center;padding:24px;color:var(--ink-li);font-size:.875rem;}
.refert-card{background:var(--warm);border:1.5px solid var(--border);border-radius:12px;overflow:hidden;}
.refert-header{display:flex;align-items:center;gap:10px;padding:14px;}
.refert-icon{font-size:1.4rem;}
.refert-info{flex:1;}
.refert-info strong{display:block;font-size:.875rem;color:var(--ink);}
.refert-meta{font-size:.72rem;color:var(--ink-li);}
.refert-actions{display:flex;gap:8px;}
.btn-refert-preview{padding:5px 12px;background:var(--teal-p);color:var(--teal);border:none;border-radius:6px;cursor:pointer;font-size:.78rem;font-family:'DM Sans',sans-serif;}
.btn-refert-del{padding:5px 10px;background:#ffebee;color:var(--rust);border:none;border-radius:6px;cursor:pointer;font-size:.85rem;}
.refert-thumb{width:100%;max-height:200px;object-fit:cover;border-top:1px solid var(--border);cursor:pointer;}
.refert-note-row{padding:8px 14px;border-top:1px solid var(--border);}
.refert-note-input{width:100%;border:none;background:transparent;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--ink-m);outline:none;}
@media(max-width:600px){.q-pheno-grid{grid-template-columns:1fr;}.pheno-result-main{flex-direction:column;}.q-grid{grid-template-columns:1fr;}}

/* ===================== LOGIN SCREEN ===================== */
#loginScreen{position:fixed;inset:0;background:linear-gradient(135deg,var(--ink) 0%,#2d3561 100%);display:flex;align-items:center;justify-content:center;z-index:9999;}
#loginScreen.hidden{display:none;}
.login-box{background:var(--warm);border-radius:18px;padding:40px 36px;width:100%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.4);}
.login-logo{font-family:'DM Serif Display',serif;font-size:1.6rem;color:var(--ink);margin-bottom:6px;}
.login-logo span{color:var(--teal);}
.login-sub{font-size:.82rem;color:var(--ink-li);margin-bottom:28px;}
.login-field{margin-bottom:16px;}
.login-field label{display:block;font-size:.78rem;font-weight:600;color:var(--ink-m);margin-bottom:5px;text-transform:uppercase;letter-spacing:.05em;}
.login-field input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.9rem;outline:none;transition:border-color .2s;background:white;}
.login-field input:focus{border-color:var(--teal);}
.login-btn{width:100%;padding:13px;background:var(--teal);color:white;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:600;cursor:pointer;transition:background .2s;margin-top:4px;}
.login-btn:hover{background:var(--teal-l);}
.login-btn:disabled{opacity:.6;cursor:not-allowed;}
.login-error{background:#ffebee;color:#c62828;border-radius:8px;padding:10px 13px;font-size:.82rem;margin-bottom:14px;display:none;}
.login-toggle{text-align:center;margin-top:16px;font-size:.82rem;color:var(--ink-li);}
.login-toggle a{color:var(--teal);cursor:pointer;font-weight:500;}
.login-toggle a:hover{text-decoration:underline;}
.user-badge{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.12);border-radius:20px;padding:5px 12px 5px 6px;}
.user-avatar-sm{width:26px;height:26px;border-radius:50%;background:var(--teal);color:white;font-size:.72rem;font-weight:700;display:flex;align-items:center;justify-content:center;}
.user-name-sm{font-size:.78rem;color:rgba(255,255,255,.85);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-logout{background:none;border:1px solid rgba(255,255,255,.25);color:rgba(255,255,255,.6);border-radius:6px;padding:4px 10px;font-family:'DM Sans',sans-serif;font-size:.72rem;cursor:pointer;transition:all .2s;}
.btn-logout:hover{background:rgba(255,255,255,.1);color:white;}
.sync-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;}
.sync-dot.ok{background:#4caf7d;}
.sync-dot.syncing{background:#fbc02d;animation:blink 1s infinite;}
.sync-dot.err{background:#e53935;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.sync-status{font-size:.72rem;color:rgba(255,255,255,.5);display:flex;align-items:center;gap:4px;}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Diario <span>Clinico Pro</span></div>
    <div class="login-sub" id="loginSubtitle">Accedi al tuo account</div>
    <div class="login-error" id="loginError"></div>
    <div class="login-field">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="email@studio.it" autocomplete="email">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <div class="login-field" id="loginNameField" style="display:none;">
      <label>Nome visualizzato</label>
      <input type="text" id="loginDisplayName" placeholder="Dr. Rossi">
    </div>
    <button class="login-btn" id="loginBtn" onclick="handleAuth()">Accedi</button>
    <div class="login-toggle">
      <span id="loginToggleText">Non hai un account?</span>
      <a onclick="toggleAuthMode()"> <span id="loginToggleLink">Registrati</span></a>
    </div>
  </div>
</div>

<header>
  <h1>Diario <span class="header-accent">Clinico Pro</span></h1>
  <div class="header-right">
    <div class="sync-status"><span class="sync-dot ok" id="syncDot"></span><span id="syncLabel">Connesso</span></div>
    <div class="user-badge" id="userBadge" style="display:none;">
      <div class="user-avatar-sm" id="userAvatar">?</div>
      <span class="user-name-sm" id="userNameLabel"></span>
      <button class="btn-logout" onclick="handleLogout()">Esci</button>
    </div>
    <span id="currentDate" style="font-size:.8rem;color:rgba(255,255,255,.6);"></span>
    <button class="btn-export-all" style="background:rgba(255,255,255,.15);color:white;" onclick="openShareModal()">üîó Condividi</button>
    <button class="btn-export-all" onclick="exportAllData()">üìä Esporta Excel</button>
  </div>
</header>

<div class="app-tabs">
  <button class="tab-btn active" onclick="switchTab('visits')">üìã Visita</button>
  <button class="tab-btn" onclick="switchTab('scheda')">üóÇ Scheda del Giorno</button>
  <button class="tab-btn" onclick="switchTab('trend')">üìà Andamento</button>
  <button class="tab-btn" onclick="switchTab('longevity')">üß¨ Longevity</button>
  <button class="tab-btn" onclick="switchTab('pain')">üìç Dolore</button>
  <button class="tab-btn" onclick="switchTab('questionari')">üìù Questionari</button>
  <button class="tab-btn" onclick="switchTab('referti')">üìé Referti</button>
  <button class="tab-btn" onclick="switchTab('history')">üìÖ Storico</button>
</div>

<div class="container">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">Pazienti <span id="patCount">0</span></div>
    <div class="sidebar-search"><input type="text" id="searchInput" placeholder="Cerca paziente..." oninput="renderPatList()"></div>
    <div class="patient-list" id="patList"></div>
    <button class="btn-add-patient" onclick="openAddPat()">Ôºã Nuovo Paziente</button>
  </div>

  <!-- MAIN -->
  <div class="main-panel" id="mainPanel">
    <div class="empty-state"><div class="emoji">üè•</div><p>Seleziona un paziente o aggiungine uno nuovo.</p></div>
  </div>
</div>

<!-- ====== MODALS ====== -->
<!-- Patient Modal -->
<div class="modal-overlay" id="patModal">
  <div class="modal">
    <h3 id="patModalTitle">Nuovo Paziente</h3>
    <div class="form-group"><label>Nome e Cognome *</label><input type="text" id="patName" placeholder="Es. Mario Rossi"></div>
    <div class="form-group"><label>Data di nascita</label><input type="date" id="patDob"></div>
    <div class="form-group"><label>Sesso</label><select id="patSex"><option value="">--</option><option value="M">Maschile</option><option value="F">Femminile</option></select></div>
    <div class="form-group"><label>Diagnosi / Note generali</label><input type="text" id="patDiag" placeholder="Es. Insufficienza venosa cronica"></div>
    <div class="form-group"><label>Contatto</label><input type="text" id="patContact" placeholder="Email o telefono"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal('patModal')">Annulla</button>
      <button class="btn-confirm" onclick="savePat()">Salva</button>
    </div>
  </div>
</div>

<!-- Products Modal -->
<div class="modal-overlay" id="prodsModal">
  <div class="modal">
    <h3>Gestione Prodotti Flebo</h3>
    <div id="prodsEditList" style="max-height:300px;overflow-y:auto;margin-bottom:12px;"></div>
    <div style="display:grid;grid-template-columns:1fr auto auto;gap:7px;align-items:center;">
      <input type="text" id="newProdName" placeholder="Nome prodotto..." style="padding:8px 11px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.85rem;background:var(--cream);outline:none;">
      <input type="text" id="newProdDose" placeholder="Dosaggio..." style="width:110px;padding:8px 11px;border:1px solid var(--border);border-radius:7px;font-family:'DM Sans',sans-serif;font-size:.85rem;background:var(--cream);outline:none;">
      <button class="btn-confirm" onclick="addCustomProd()" style="padding:8px 14px;">Aggiungi</button>
    </div>
    <div class="modal-actions"><button class="btn-confirm" onclick="closeModal('prodsModal')">Chiudi</button></div>
  </div>
</div>

<!-- Share Modal -->
<div class="modal-overlay" id="shareModal">
  <div class="modal" style="width:520px;">
    <h3>üîó Condivisione & Sincronizzazione</h3>

    <div class="share-section">
      <h4>üì§ Esporta database</h4>
      <p>Scarica tutti i dati come file JSON. Puoi inviarlo a un collaboratore che lo importer√† nella propria copia dell'app.</p>
      <div class="share-option" onclick="exportJSON()">
        <span class="so-icon">üíæ</span>
        <div class="so-text"><strong>Scarica backup JSON</strong><span>Tutti i pazienti, visite, score, dati di ricerca</span></div>
      </div>
    </div>

    <div class="share-section">
      <h4>üì• Importa / Unisci database</h4>
      <p>Importa un file JSON ricevuto da un collega. Puoi scegliere di <strong>unire</strong> (merge) o <strong>sostituire</strong> i dati esistenti.</p>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:10px;">
        <input type="file" id="importFileInput" accept=".json" style="font-size:.82rem;flex:1;" onchange="previewImport(this)">
      </div>
      <div id="importPreview" style="display:none;margin-bottom:10px;"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-confirm" onclick="importJSON('merge')" id="btnMerge" disabled style="flex:1;opacity:.5;">üîÄ Unisci (merge)</button>
        <button class="btn-cancel" onclick="importJSON('replace')" id="btnReplace" disabled style="flex:1;opacity:.5;">üîÑ Sostituisci tutto</button>
      </div>
    </div>

    <div class="share-section">
      <h4>‚òÅÔ∏è Condivisione multi-collaboratore</h4>
      <div class="sync-info">
        <strong>Come funziona il lavoro in team:</strong><br>
        Questa app salva i dati <em>localmente</em> nel browser. Per condividerla tra pi√π collaboratori hai 3 opzioni:
      </div>
      <div class="share-option" onclick="copyHostingInstructions()">
        <span class="so-icon">üåê</span>
        <div class="so-text"><strong>Opzione 1 ‚Äî File condiviso su rete locale</strong><span>Salva il file HTML su una cartella di rete (NAS/server) ‚Äî tutti aprono lo stesso file</span></div>
      </div>
      <div class="share-option" onclick="showNotionOption()">
        <span class="so-icon">‚òÅÔ∏è</span>
        <div class="so-text"><strong>Opzione 2 ‚Äî Sync JSON via Google Drive / Dropbox</strong><span>Esporta/importa il JSON ogni volta ¬∑ workflow veloce in 2 clic</span></div>
      </div>
      <div class="share-option" onclick="showNetlifyOption()">
        <span class="so-icon">üöÄ</span>
        <div class="so-text"><strong>Opzione 3 ‚Äî Deploy gratuito su Netlify/Vercel</strong><span>Pubblica l'HTML online con accesso protetto da password</span></div>
      </div>
      <div class="warning-info" style="margin-top:10px;">
        ‚ö†Ô∏è Per un database clinico <strong>veramente condiviso e in tempo reale</strong> tra pi√π utenti serve un backend (es. Supabase, Firebase). Richiedilo e lo implementiamo.
      </div>
    </div>

    <div id="shareExtraInfo" style="display:none;margin-bottom:12px;"></div>

    <div class="modal-actions">
      <button class="btn-confirm" onclick="closeModal('shareModal')">Chiudi</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// =====================================================================
// DATA
// =====================================================================

const PRODUCT_CATALOG = [
  // FIALE SINGOLE
  {cat:"Fiale Singole", name:"Acetilcarnitina - L", dose:"125mg/ml"},
  {cat:"Fiale Singole", name:"Acido Alfa Lipoico", dose:"600mg/20ml"},
  {cat:"Fiale Singole", name:"Acido Folico", dose:"15mg/4ml"},
  {cat:"Fiale Singole", name:"Arginina - L", dose:"400mg/4ml"},
  {cat:"Fiale Singole", name:"B-Complex (B1+B2+B3+B5+B6)", dose:"100+2+100+250+100mg/4ml"},
  {cat:"Fiale Singole", name:"Biotina (Vit B8)", dose:"1mg/4ml"},
  {cat:"Fiale Singole", name:"Blu di Metilene", dose:"50mg/5ml"},
  {cat:"Fiale Singole", name:"Calcio D Pantotenato (Vit B5)", dose:"8mg/4ml"},
  {cat:"Fiale Singole", name:"Calcio Gluconato", dose:"300mg/3ml"},
  {cat:"Fiale Singole", name:"Carnitina - L Base", dose:"1g/4ml"},
  {cat:"Fiale Singole", name:"Cianocobalamina (Vit B12)", dose:"1mg/ml"},
  {cat:"Fiale Singole", name:"Coenzima Q10", dose:"100mg/35ml"},
  {cat:"Fiale Singole", name:"Desametasone", dose:"24mg/ml"},
  {cat:"Fiale Singole", name:"EDTA", dose:"2g/10ml"},
  {cat:"Fiale Singole", name:"Fosfatidilcolina", dose:"250mg/5ml"},
  {cat:"Fiale Singole", name:"Gabapentin", dose:"60mg/ml"},
  {cat:"Fiale Singole", name:"Glicina", dose:"150mg/4ml"},
  {cat:"Fiale Singole", name:"Glutammina - L", dose:"100mg/4ml"},
  {cat:"Fiale Singole", name:"Glutatione Ossidato", dose:"600mg/4ml"},
  {cat:"Fiale Singole", name:"Glutatione Ridotto (GSH)", dose:"200mg/4ml"},
  {cat:"Fiale Singole", name:"Glutatione Ridotto Liofilizzato", dose:"200mg/4ml"},
  {cat:"Fiale Singole", name:"Ialuronidasi", dose:"1200UI/4ml"},
  {cat:"Fiale Singole", name:"Idrossicobalamina (Vit B12)", dose:"1mg/4ml"},
  {cat:"Fiale Singole", name:"Inositolo", dose:"100mg/4ml"},
  {cat:"Fiale Singole", name:"Lidocaina", dose:"100mg/ml"},
  {cat:"Fiale Singole", name:"Magnesio Cloruro", dose:"1500mg/4ml"},
  {cat:"Fiale Singole", name:"Metionina - L", dose:"80mg/4ml"},
  {cat:"Fiale Singole", name:"Metilcobalamina (Vit B12)", dose:"1mg/ml"},
  {cat:"Fiale Singole", name:"MIC (Metionina+Inositolo+Colina)", dose:"25+50+50mg/2ml"},
  {cat:"Fiale Singole", name:"N-Acetilcisteina (NAC)", dose:"300mg/3ml"},
  {cat:"Fiale Singole", name:"NAD+ Liquido", dose:"300mg/3ml"},
  {cat:"Fiale Singole", name:"NAD+ Liofilizzato", dose:"300mg/3ml"},
  {cat:"Fiale Singole", name:"Nicotinamide (Vit B3)", dose:"400mg/4ml"},
  {cat:"Fiale Singole", name:"Omeprazolo", dose:"5mg/ml"},
  {cat:"Fiale Singole", name:"Piridossina (Vit B6)", dose:"100mg/4ml"},
  {cat:"Fiale Singole", name:"Rame Gluconato", dose:"2mg/5ml"},
  {cat:"Fiale Singole", name:"Resveratrolo", dose:"100mg/8ml"},
  {cat:"Fiale Singole", name:"Riboflavina (Vit B2)", dose:"2mg/4ml"},
  {cat:"Fiale Singole", name:"Selenio", dose:"100mcg/4ml"},
  {cat:"Fiale Singole", name:"Spermidina", dose:"20mg/10ml"},
  {cat:"Fiale Singole", name:"Taurina", dose:"200mg/4ml"},
  {cat:"Fiale Singole", name:"Tiamina (Vit B1)", dose:"800mg/4ml"},
  {cat:"Fiale Singole", name:"Tirosina - L", dose:"1g/10ml"},
  {cat:"Fiale Singole", name:"Triptofano - L", dose:"100mg/10ml"},
  {cat:"Fiale Singole", name:"Vitamina C", dose:"2,5g/5ml"},
  {cat:"Fiale Singole", name:"Zinco Solfato", dose:"10mg/10ml"},
  // PROTOCOLLI IV
  {cat:"Protocolli IV", name:"DETOX (Vit B1+VitC+Metionina+Carnitina)", dose:"Kit 28‚Ç¨"},
  {cat:"Protocolli IV", name:"ENERGY (B-Complex+Taurina)", dose:"Kit 36‚Ç¨"},
  {cat:"Protocolli IV", name:"FAT BURN (Metionina+Inositolo+B12+B6)", dose:"Kit 28‚Ç¨"},
  {cat:"Protocolli IV", name:"HANGOVER (B1+B2+VitC+Arginina+Taurina)", dose:"Kit 30‚Ç¨"},
  {cat:"Protocolli IV", name:"HER (B6+AcFolico+VitC+B-Complex)", dose:"Kit 29‚Ç¨"},
  {cat:"Protocolli IV", name:"HIM (B5+B8+B12+Zinco+Taurina)", dose:"Kit 32‚Ç¨"},
  {cat:"Protocolli IV", name:"IMMUNE (B-Complex+VitC+Zinco)", dose:"Kit 28‚Ç¨"},
  {cat:"Protocolli IV", name:"MIND (Arginina+Carnitina+Glicina+Magnesio+Taurina)", dose:"Kit 30‚Ç¨"},
  {cat:"Protocolli IV", name:"MUSCLE (Metionina+Carnitina+Biotina+Selenio+Taurina)", dose:"Kit 28‚Ç¨"},
  {cat:"Protocolli IV", name:"MYER'S COCKTAIL (B-Cx+VitC+Magnesio+Ca-Gluconato+B12)", dose:"Kit 35‚Ç¨"},
  {cat:"Protocolli IV", name:"SKIN HAIR (Selenio+B3+B5+B6+Biotina+Zinco)", dose:"Kit 30‚Ç¨"},
  {cat:"Protocolli IV", name:"SUPERMUSCLE (Metionina+Carnitina+Inositolo+Arginina+Biotina+Taurina)", dose:"Kit 35‚Ç¨"},
  // PRODOTTI CLINICI AGGIUNTIVI
  {cat:"Prodotti Clinici", name:"Vitamina B12", dose:"1000mcg/ml"},
  {cat:"Prodotti Clinici", name:"TAD 600 (Glutatione)", dose:"600mg"},
  {cat:"Prodotti Clinici", name:"Carnitene", dose:"1g/5ml"},
  {cat:"Prodotti Clinici", name:"Fluimucil (N-Acetilcisteina)", dose:"300mg/3ml"},
  {cat:"Prodotti Clinici", name:"Epargriseovit", dose:"secondo prescrizione"},
  {cat:"Prodotti Clinici", name:"Samyr (Ademetionina)", dose:"400mg"},
  {cat:"Prodotti Clinici", name:"Liposom Forte", dose:"secondo prescrizione"},
  {cat:"Prodotti Clinici", name:"Adametionina", dose:"400mg"},
];

const PAIN_QUALITIES = [
  {id:"burning", label:"Bruciante", desc:"Sensazione di calore/fuoco"},
  {id:"stabbing", label:"Trafittivo", desc:"Come un pugnale/ago"},
  {id:"pulsating", label:"Pulsante", desc:"Batte a ritmo"},
  {id:"pressing", label:"Pressione", desc:"Peso/schiacciamento"},
  {id:"cramping", label:"Crampiforme", desc:"Contrazione muscolare"},
  {id:"shooting", label:"Irradiante", desc:"Si estende in altre zone"},
  {id:"tingling", label:"Formicolio", desc:"Parestesia/punture di spilli"},
  {id:"aching", label:"Sordo/Pesante", desc:"Dolore continuo ottuso"},
  {id:"cold", label:"Freddo/Ghiacciato", desc:"Sensazione fredda"},
  {id:"electric", label:"Elettrico", desc:"Come scarica elettrica"},
];

const PAIN_TIMING = ["Costante","Intermittente","Al movimento","A riposo","Notturno","Al mattino","Post-attivit√†"];
const PAIN_LOCATIONS = ["Testa","Collo","Spalla Dx","Spalla Sx","Braccio Dx","Braccio Sx","Petto","Addome","Lombare","Sacro","Anca Dx","Anca Sx","Ginocchio Dx","Ginocchio Sx","Piede Dx","Piede Sx","Diffuso"];

let state = {
  patients: [],
  customProducts: [],
  selectedPatient: null,
  selectedDate: todayStr(),
};

function todayStr(){return new Date().toISOString().split('T')[0];}
function fmtDate(s){if(!s)return'';const[y,m,d]=s.split('-');return`${d}/${m}/${y}`;}
function initials(n){return n.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();}


// =====================================================================
// QUESTIONARI CLINICI ‚Äî Dati, Scoring, Rendering
// =====================================================================

// ‚îÄ‚îÄ SF-36 (RAND 36) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SF36_QUESTIONS = [
  {n:1, text:"In generale, direi che la mia salute √®:", opts:["Eccellente","Molto buona","Buona","Discreta","Scarsa"]},
  {n:2, text:"Rispetto a un anno fa, come valuterebbe ora la sua salute in generale?", opts:["Molto migliore","Un po' migliore","Pi√π o meno uguale","Un po' peggiore","Molto peggiore"]},
  // Attivit√† fisiche (3-12)
  {n:3, text:"Attivit√† fisiche impegnative (correre, sollevare pesi, sport intensi)", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:4, text:"Attivit√† fisiche moderate (spostare un tavolo, usare l'aspirapolvere, camminare)", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:5, text:"Sollevare o portare borse della spesa", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:6, text:"Salire pi√π di una rampa di scale", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:7, text:"Salire una rampa di scale", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:8, text:"Piegarsi, inginocchiarsi o chinarsi", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:9, text:"Camminare per pi√π di un chilometro", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:10, text:"Camminare per alcune centinaia di metri", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:11, text:"Camminare per cento metri", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  {n:12, text:"Fare il bagno o vestirsi da solo/a", opts:["S√¨, molto limitato","S√¨, un po' limitato","No, per niente limitato"], prefix:"Limitato da:"},
  // Problemi fisici (13-16)
  {n:13, text:"Ha ridotto il tempo dedicato al lavoro o ad altre attivit√†?", opts:["S√¨","No"], prefix:"A causa della salute fisica:"},
  {n:14, text:"Ha fatto meno di quanto avrebbe voluto?", opts:["S√¨","No"], prefix:"A causa della salute fisica:"},
  {n:15, text:"Ha avuto limitazioni nel tipo di lavoro o altre attivit√†?", opts:["S√¨","No"], prefix:"A causa della salute fisica:"},
  {n:16, text:"Ha avuto difficolt√† ad eseguire il lavoro o altre attivit√†?", opts:["S√¨","No"], prefix:"A causa della salute fisica:"},
  // Problemi emotivi (17-19)
  {n:17, text:"Ha ridotto il tempo dedicato al lavoro o ad altre attivit√†?", opts:["S√¨","No"], prefix:"A causa di problemi emotivi:"},
  {n:18, text:"Ha fatto meno di quanto avrebbe voluto?", opts:["S√¨","No"], prefix:"A causa di problemi emotivi:"},
  {n:19, text:"Ha svolto il lavoro o le altre attivit√† con meno cura del solito?", opts:["S√¨","No"], prefix:"A causa di problemi emotivi:"},
  // Vita sociale, dolore, energia, salute mentale
  {n:20, text:"Nelle ultime 4 settimane, in che misura la sua salute fisica o i problemi emotivi hanno interferito con le normali attivit√† sociali (famiglia, amici, vicini, gruppi)?", opts:["Per niente","Leggermente","Moderatamente","Abbastanza","Moltissimo"]},
  {n:21, text:"Quanto dolore fisico ha provato nelle ultime 4 settimane?", opts:["Nessuno","Molto lieve","Lieve","Moderato","Forte","Molto forte"]},
  {n:22, text:"Nelle ultime 4 settimane, in che misura il dolore ha interferito con il suo lavoro normale (compreso il lavoro fuori casa e in casa)?", opts:["Per niente","Un poco","Moderatamente","Abbastanza","Moltissimo"]},
  {n:23, text:"Si √® sentito/a pieno/a di energia?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:24, text:"Si √® sentito/a molto agitato/a?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:25, text:"Si √® sentito/a cos√¨ gi√π di morale che niente poteva tirarlo/a su?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:26, text:"Si √® sentito/a tranquillo/a e sereno/a?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:27, text:"Ha avuto molta energia?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:28, text:"Si √® sentito/a scoraggiato/a e triste?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:29, text:"Si √® sentito/a esausto/a?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:30, text:"√à stato/a una persona felice?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:31, text:"Si √® sentito/a stanco/a?", opts:["Sempre","Quasi sempre","Spesso","A volte","Raramente","Mai"]},
  {n:32, text:"Nelle ultime 4 settimane, per quanto tempo la sua salute fisica o i problemi emotivi hanno interferito con le sue attivit√† sociali?", opts:["Sempre","Quasi sempre","Qualche volta","Raramente","Mai"]},
  {n:33, text:"Mi sembra di ammalarmi un po' pi√π facilmente degli altri", opts:["Decisamente vero","Per lo pi√π vero","Non so","Per lo pi√π falso","Decisamente falso"]},
  {n:34, text:"Sono in salute come chiunque altro conosco", opts:["Decisamente vero","Per lo pi√π vero","Non so","Per lo pi√π falso","Decisamente falso"]},
  {n:35, text:"Mi aspetto che la mia salute peggiori", opts:["Decisamente vero","Per lo pi√π vero","Non so","Per lo pi√π falso","Decisamente falso"]},
  {n:36, text:"La mia salute √® eccellente", opts:["Decisamente vero","Per lo pi√π vero","Non so","Per lo pi√π falso","Decisamente falso"]},
];

function scoreSF36(resp) {
  // resp: {1: rawVal, 2: rawVal, ...} (1-indexed, 1-based answer)
  const recode = (item, raw) => {
    if(raw===null||raw===undefined) return null;
    const r = parseInt(raw);
    if([1,2,20,22,34,36].includes(item)) return [100,75,50,25,0][r-1]??null;
    if(item>=3&&item<=12) return [0,50,100][r-1]??null;
    if(item>=13&&item<=19) return [0,100][r-1]??null;
    if([21,23,26,27,30].includes(item)) return [100,80,60,40,20,0][r-1]??null;
    if([24,25,28,29,31].includes(item)) return [0,20,40,60,80,100][r-1]??null;
    if([32,33,35].includes(item)) return [0,25,50,75,100][r-1]??null;
    return null;
  };
  const avg = items => { const v=items.map(i=>recode(i,resp[i])).filter(x=>x!==null); return v.length?Math.round(v.reduce((a,b)=>a+b,0)/v.length):null; };
  return {
    PF: avg([3,4,5,6,7,8,9,10,11,12]),
    RP: avg([13,14,15,16]),
    RE: avg([17,18,19]),
    VT: avg([23,27,29,31]),
    MH: avg([24,25,26,28,30]),
    SF: avg([20,32]),
    BP: avg([21,22]),
    GH: avg([1,33,34,35,36]),
    HC: recode(2,resp[2]),
  };
}

// ‚îÄ‚îÄ PHQ-9 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var PHQ9_QUESTIONS = [
  "Scarso interesse o piacere nel fare le cose",
  "Sentirsi gi√π, depresso/a o senza speranza",
  "Difficolt√† ad addormentarsi, restare sveglio/a, o dormire troppo",
  "Sentirsi stanco/a o avere poca energia",
  "Scarso appetito o mangiare troppo",
  "Sentirsi in colpa o essere troppo critico/a con se stesso/a",
  "Difficolt√† a concentrarsi (es. leggere il giornale o guardare la TV)",
  "Muoversi o parlare cos√¨ lentamente che gli altri lo notano; o essere cos√¨ agitato/a da non stare fermo/a",
  "Pensieri di essere meglio morto/a o di farsi del male",
];
var PHQ9_OPTS = ["Mai (0)","Alcuni giorni (1)","Pi√π della met√† dei giorni (2)","Quasi ogni giorno (3)"];
function scorePHQ9(r){ const s=r.reduce((a,v)=>a+(v??0),0); return {total:s, severity:s<=4?'Minima':s<=9?'Lieve':s<=14?'Moderata':s<=19?'Moderatamente grave':'Grave'}; }

// ‚îÄ‚îÄ GAD-7 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var GAD7_QUESTIONS = [
  "Sentirsi nervoso/a, ansioso/a o molto teso/a",
  "Non riuscire a smettere di preoccuparsi o a controllare le preoccupazioni",
  "Preoccuparsi troppo per cose diverse",
  "Difficolt√† a rilassarsi",
  "Essere cos√¨ irrequieto/a da non riuscire a stare seduto/a fermo/a",
  "Irritarsi o arrabbiarsi facilmente",
  "Aver paura che possa accadere qualcosa di brutto",
];
var GAD7_OPTS = ["Mai (0)","Alcuni giorni (1)","Pi√π della met√† dei giorni (2)","Quasi ogni giorno (3)"];
function scoreGAD7(r){ const s=r.reduce((a,v)=>a+(v??0),0); return {total:s, severity:s<=4?'Minima':s<=9?'Lieve':s<=14?'Moderata':'Grave'}; }

// ‚îÄ‚îÄ DASS-21 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var DASS21_QUESTIONS = [
  {text:"Ho avuto difficolt√† a calmarmi", scale:'S'},
  {text:"Ho avvertito la secchezza della bocca", scale:'A'},
  {text:"Non riuscivo a provare nessun sentimento positivo", scale:'D'},
  {text:"Ho avuto difficolt√† a respirare (es. respiro affannoso, mancanza di fiato senza sforzo fisico)", scale:'A'},
  {text:"Ho trovato difficile prendere iniziative per fare le cose", scale:'D'},
  {text:"Ho reagito in modo eccessivo alle situazioni", scale:'S'},
  {text:"Ho avuto tremori (es. alle mani)", scale:'A'},
  {text:"Mi sono sentito/a molto nervoso/a", scale:'S'},
  {text:"Ero preoccupato/a per situazioni in cui potevo farmi prendere dal panico o rendermi ridicolo/a", scale:'A'},
  {text:"Sentivo di non avere nulla da aspettarmi", scale:'D'},
  {text:"Mi sono sentito/a agitato/a", scale:'S'},
  {text:"Ho trovato difficile rilassarmi", scale:'S'},
  {text:"Mi sono sentito/a abbattuto/a e triste", scale:'D'},
  {text:"Ero intollerante verso tutto ci√≤ che mi impediva di continuare quello che stavo facendo", scale:'S'},
  {text:"Sentivo di essere sul punto di farmi prendere dal panico", scale:'A'},
  {text:"Non riuscivo a entusiasmarmi per nulla", scale:'D'},
  {text:"Sentivo di non valere molto come persona", scale:'D'},
  {text:"Ero piuttosto irritabile", scale:'S'},
  {text:"Ero consapevole del battito del mio cuore senza sforzo fisico", scale:'A'},
  {text:"Ero spaventato/a senza un valido motivo", scale:'A'},
  {text:"Sentivo che la vita non aveva senso", scale:'D'},
];
var DASS21_OPTS = ["Mai (0)","A volte (1)","Spesso (2)","Quasi sempre (3)"];
function scoreDASS21(r){
  const D=r.filter((_,i)=>DASS21_QUESTIONS[i].scale==='D').reduce((a,v)=>a+(v??0),0)*2;
  const A=r.filter((_,i)=>DASS21_QUESTIONS[i].scale==='A').reduce((a,v)=>a+(v??0),0)*2;
  const S=r.filter((_,i)=>DASS21_QUESTIONS[i].scale==='S').reduce((a,v)=>a+(v??0),0)*2;
  const sevD=D<=9?'Normale':D<=13?'Lieve':D<=20?'Moderata':D<=27?'Grave':'Estremamente grave';
  const sevA=A<=7?'Normale':A<=9?'Lieve':A<=14?'Moderata':A<=19?'Grave':'Estremamente grave';
  const sevS=S<=14?'Normale':S<=18?'Lieve':S<=25?'Moderata':S<=33?'Grave':'Estremamente grave';
  return {D,A,S,sevD,sevA,sevS};
}

// ‚îÄ‚îÄ MIDAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var MIDAS_QUESTIONS = [
  "Quanti giorni negli ultimi 3 mesi ha perso il lavoro o la scuola a causa dell'emicrania? (giorni)",
  "Quanti giorni negli ultimi 3 mesi la sua produttivit√† al lavoro o a scuola era ridotta della met√† o pi√π a causa dell'emicrania? (escludi i giorni contati nella domanda 1) (giorni)",
  "Quanti giorni negli ultimi 3 mesi non ha svolto i lavori domestici a causa dell'emicrania? (giorni)",
  "Quanti giorni negli ultimi 3 mesi la sua produttivit√† nei lavori domestici era ridotta della met√† o pi√π? (escludi i giorni contati nella domanda 3) (giorni)",
  "Quanti giorni negli ultimi 3 mesi ha perso attivit√† familiari, sociali o del tempo libero a causa dell'emicrania? (giorni)",
];
function scoreMIDAS(r){
  const total=r.reduce((a,v)=>a+(parseInt(v)||0),0);
  const grade=total<=5?'I (lieve)':total<=10?'II (moderata)':total<=20?'III (grave)':'IV (molto grave)';
  return {total, grade};
}

// ‚îÄ‚îÄ HIT-6 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var HIT6_QUESTIONS = [
  "Quando hai mal di testa, quanto √® intenso il dolore?",
  "Quanto spesso il tuo mal di testa limita la tua capacit√† di svolgere le attivit√† quotidiane (include le faccende domestiche, il lavoro, la scuola o le attivit√† sociali)?",
  "Quando hai mal di testa, quanto spesso vorresti poter andare a letto?",
  "Nelle ultime 4 settimane, quanto spesso il mal di testa ha limitato la tua capacit√† di concentrarti sul lavoro o sulle attivit√† quotidiane?",
  "Nelle ultime 4 settimane, quanto spesso ti sei sentito/a stanco/a, esausto/a o a corto di energie a causa del tuo mal di testa?",
  "Nelle ultime 4 settimane, quanto spesso ti sei sentito/a infastidito/a, irritato/a o frustrato/a a causa del tuo mal di testa?",
];
var HIT6_OPTS = ["Mai (6)","Raramente (8)","A volte (10)","Molto spesso (11)","Sempre (13)"];
var HIT6_VALS = [6,8,10,11,13];
function scoreHIT6(r){
  const total=r.reduce((a,v)=>a+(HIT6_VALS[v]??0),0);
  const impact=total<=49?'Poco o nessun impatto':total<=55?'Qualche impatto':total<=59?'Impatto sostanziale':'Impatto molto grave';
  return {total, impact};
}

// ‚îÄ‚îÄ DHI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var DHI_QUESTIONS = [
  {text:"Guardare verso l'alto aggrava il suo problema?", sub:'F'},
  {text:"Si sente frustrato/a a causa del suo problema?", sub:'E'},
  {text:"A causa del suo problema limita i viaggi di lavoro o di piacere?", sub:'F'},
  {text:"Camminare lungo il corridoio di un supermercato aggrava il suo problema?", sub:'P'},
  {text:"A causa del suo problema ha difficolt√† ad alzarsi dal letto?", sub:'F'},
  {text:"Il suo problema limita significativamente la sua partecipazione ad attivit√† sociali (cene fuori, cinema, danza o feste)?", sub:'F'},
  {text:"A causa del suo problema ha difficolt√† a leggere?", sub:'F'},
  {text:"Svolgere attivit√† pi√π impegnative come sport, ballare, fare i lavori domestici aggrava il suo problema?", sub:'P'},
  {text:"A causa del suo problema ha paura di uscire di casa senza che qualcuno la accompagni?", sub:'E'},
  {text:"Si √® mai sentito/a imbarazzato/a in presenza di altri a causa del suo problema?", sub:'E'},
  {text:"I movimenti rapidi della testa aggravano il suo problema?", sub:'P'},
  {text:"A causa del suo problema evita le altezze?", sub:'F'},
  {text:"Girarsi nel letto aggrava il suo problema?", sub:'P'},
  {text:"A causa del suo problema √® difficile svolgere lavori domestici impegnativi?", sub:'F'},
  {text:"Ha paura che la gente pensi che sia ubriaco/a a causa del suo problema?", sub:'E'},
  {text:"A causa del suo problema √® difficile fare passeggiate da solo/a?", sub:'F'},
  {text:"Camminare lungo il marciapiede aggrava il suo problema?", sub:'P'},
  {text:"A causa del suo problema √® difficile concentrarsi?", sub:'E'},
  {text:"A causa del suo problema √® difficile camminare al buio?", sub:'F'},
  {text:"A causa del suo problema ha paura di restare solo/a in casa?", sub:'E'},
  {text:"A causa del suo problema si sente handicappato/a?", sub:'E'},
  {text:"Il suo problema le ha creato tensioni nei rapporti con i familiari o gli amici?", sub:'E'},
  {text:"A causa del suo problema si √® sentito/a depresso/a?", sub:'E'},
  {text:"Il suo problema interferisce con il suo lavoro o con le sue responsabilit√† domestiche?", sub:'F'},
  {text:"Chinarsi aggrava il suo problema?", sub:'P'},
];
var DHI_OPTS = ["S√¨ (4)","Talvolta (2)","No (0)"];
var DHI_VALS = [4,2,0];
function scoreDHI(r){
  const total=r.reduce((a,v)=>a+(DHI_VALS[v]??0),0);
  const severity=total<=30?'Lieve (0-30)':total<=60?'Moderata (31-60)':'Grave (61-100)';
  const P=DHI_QUESTIONS.reduce((a,q,i)=>q.sub==='P'?a+(DHI_VALS[r[i]]??0):a,0);
  const F=DHI_QUESTIONS.reduce((a,q,i)=>q.sub==='F'?a+(DHI_VALS[r[i]]??0):a,0);
  const E=DHI_QUESTIONS.reduce((a,q,i)=>q.sub==='E'?a+(DHI_VALS[r[i]]??0):a,0);
  return {total, severity, P, F, E};
}

// ‚îÄ‚îÄ ABC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var ABC_QUESTIONS = [
  "Camminare dentro casa",
  "Salire o scendere le scale",
  "Piegarsi a prendere una scarpa dal pavimento",
  "Raggiungere uno scaffale leggermente al di sopra della testa",
  "Stare in punta di piedi per raggiungere qualcosa sopra la testa",
  "Stare su una sedia per raggiungere qualcosa",
  "Spazzare il pavimento",
  "Uscire di casa per camminare vicino all'auto nel parcheggio",
  "Salire o scendere da un'auto",
  "Attraversare un parcheggio",
  "Salire o scendere una rampa di scale",
  "Camminare in un posto affollato",
  "Essere urtato/a dalla folla",
  "Salire o scendere da una scala",
  "Camminare sul ghiaccio o su un marciapiede scivoloso",
  "Camminare su una superficie sdrucciolevole",
];
function scoreABC(r){
  const vals=r.map(v=>parseInt(v)||0);
  const avg=vals.length?Math.round(vals.reduce((a,b)=>a+b,0)/vals.length):0;
  return {avg, risk:avg>=80?'Basso rischio caduta':avg>=50?'Rischio moderato':'Alto rischio caduta'};
}

// ‚îÄ‚îÄ PCS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var PCS_QUESTIONS = [
  {text:"Penso continuamente a quanto fa male", sub:'R'},
  {text:"Mi sento senza speranza e non riesco a migliorare la situazione", sub:'I'},
  {text:"√à terribile e penso che non andr√† mai meglio", sub:'M'},
  {text:"√à orribile e sento che mi sopraff√†", sub:'M'},
  {text:"Sento di non riuscire a sopportare pi√π il dolore", sub:'I'},
  {text:"Ho paura che il dolore peggiorer√†", sub:'R'},
  {text:"Continuo a pensare ad altri eventi dolorosi", sub:'R'},
  {text:"Desidero intensamente che il dolore scompaia", sub:'R'},
  {text:"Non riesco a smettere di pensarci", sub:'R'},
  {text:"Continuo a pensare a quanto fa male", sub:'R'},
  {text:"Continuo a pensare a quanto voglio che cessi il dolore", sub:'R'},
  {text:"Non c'√® niente che posso fare per ridurre l'intensit√† del dolore", sub:'I'},
  {text:"Mi chiedo se potr√† succedermi qualcosa di grave", sub:'M'},
];
var PCS_OPTS = ["Per niente (0)","In minima parte (1)","Moderatamente (2)","Abbastanza (3)","Completamente (4)"];
function scorePCS(r){
  const total=r.reduce((a,v)=>a+(v??0),0);
  const R=PCS_QUESTIONS.reduce((a,q,i)=>q.sub==='R'?a+(r[i]??0):a,0);
  const I=PCS_QUESTIONS.reduce((a,q,i)=>q.sub==='I'?a+(r[i]??0):a,0);
  const M=PCS_QUESTIONS.reduce((a,q,i)=>q.sub==='M'?a+(r[i]??0):a,0);
  const clinical=total>=30;
  return {total,R,I,M,clinical};
}

// ‚îÄ‚îÄ CSI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var CSI_QUESTIONS = [
  "Ho mal di testa","Ho dolore al collo","Ho mal di schiena","Ho dolore alle spalle",
  "Ho dolore alla mascella o alla bocca","Ho dolore agli occhi","Ho dolore alle braccia o alle gambe",
  "Ho mal di pancia","Ho dolori al petto","Ho difficolt√† a dormire bene",
  "Sono spesso stanco/a","Mi sento ansioso/a o in tensione","Mi sento spesso triste o depresso/a",
  "Ho scarse energie","Mi sento instabile (disequilibrio)",
  "Ho fastidio alla luce, ai suoni o agli odori",
  "Ho problemi di concentrazione o di memoria","Ho spesso difficolt√† a masticare",
  "Soffro di secchezza degli occhi o della bocca","Ho frequenti disturbi urinari",
  "Soffro spesso di irregolarit√† intestinale (stitichezza o diarrea)",
  "Ho spesso nausea","Soffro di rigidit√† muscolare","Ho spesso la sensazione di gonfiore",
  "Soffro di dolori mestruali o pelvici intensi",
];
var CSI_OPTS = ["Mai (0)","Raramente (1)","A volte (2)","Spesso (3)","Sempre (4)"];
function scoreCSI(r){
  const total=r.reduce((a,v)=>a+(v??0),0);
  const level=total<30?'Subclinico':total<40?'Lieve':total<50?'Moderato':total<60?'Grave':'Estremo';
  return {total, level, css:total>=40};
}

// ‚îÄ‚îÄ MSIS-29 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var MSIS29_QUESTIONS = [
  // Fisica (1-20)
  {text:"Limitazioni nell'attivit√† fisica pesante", sub:'P'},
  {text:"Difficolt√† a tenere oggetti", sub:'P'},
  {text:"Difficolt√† a scrivere", sub:'P'},
  {text:"Difficolt√† a deglutire", sub:'P'},
  {text:"Difficolt√† di comunicazione (parola)", sub:'P'},
  {text:"Tremori o movimenti incontrollati", sub:'P'},
  {text:"Senso di instabilit√† o problemi di equilibrio", sub:'P'},
  {text:"Difficolt√† a voltarsi nel letto", sub:'P'},
  {text:"Necessit√† di aiuto per i movimenti", sub:'P'},
  {text:"Difficolt√† a camminare", sub:'P'},
  {text:"Problemi con la coordinazione", sub:'P'},
  {text:"Difficolt√† a stare in piedi per lungo tempo", sub:'P'},
  {text:"Difficolt√† a salire le scale", sub:'P'},
  {text:"Difficolt√† nel trasferimento (es. dalla sedia al letto)", sub:'P'},
  {text:"Spasmi o contrazioni muscolari", sub:'P'},
  {text:"Dolore o fastidio fisico", sub:'P'},
  {text:"Stanchezza", sub:'P'},
  {text:"Problemi urinari", sub:'P'},
  {text:"Problemi intestinali", sub:'P'},
  {text:"Mani/piedi freddi o rigidi", sub:'P'},
  // Psicologica (21-29)
  {text:"Limitazioni nell'attivit√† sociale", sub:'PS'},
  {text:"Costrizione a restare a casa pi√π del voluto", sub:'PS'},
  {text:"Dipendenza dagli altri", sub:'PS'},
  {text:"Difficolt√† ad affrontare eventi quotidiani", sub:'PS'},
  {text:"Problemi di concentrazione", sub:'PS'},
  {text:"Mancanza di fiducia in se stesso/a", sub:'PS'},
  {text:"Preoccupazione per la SM", sub:'PS'},
  {text:"Difficolt√† a gestire le emozioni (es. depressione, ansia)", sub:'PS'},
  {text:"Sensazione di isolamento", sub:'PS'},
];
var MSIS29_OPTS = ["Per niente (1)","Un po' (2)","Moderatamente (3)","Abbastanza (4)","Moltissimo (5)"];
function scoreMSIS29(r){
  const phys=r.slice(0,20).reduce((a,v)=>a+(v??1),0);
  const psyc=r.slice(20,29).reduce((a,v)=>a+(v??1),0);
  // Convert to 0-100 scale
  const physPct=Math.round((phys-20)/(100-20)*100);
  const psycPct=Math.round((psyc-9)/(45-9)*100);
  return {phys, psyc, physPct, psycPct};
}

// ‚îÄ‚îÄ SCD-Q ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var SCD_QUESTIONS = [
  "Mi lamento frequentemente di problemi di memoria","La mia memoria √® peggiorata nell'ultimo anno",
  "Ho difficolt√† a ricordare nomi di persone","Ho difficolt√† a ricordare dove metto le cose",
  "Ho difficolt√† a ricordare appuntamenti","Mi dimentico di fare cose importanti",
  "Ho difficolt√† a seguire i discorsi","Ho difficolt√† a trovare le parole giuste",
  "Ho difficolt√† a concentrarmi","Mi stanco mentalmente pi√π facilmente",
  "Ho difficolt√† a fare pi√π cose contemporaneamente","Ho difficolt√† a pianificare attivit√† complesse",
  "Ho difficolt√† a prendere decisioni","Ho difficolt√† ad imparare cose nuove",
  "Ho difficolt√† ad orientarmi in luoghi nuovi","Dimentico episodi recenti",
  "Ho difficolt√† a ricordare ci√≤ che ho letto","Ho difficolt√† con i calcoli",
  "Ho difficolt√† a ricordare notizie recenti","Sento di rallentare mentalmente",
  "Il mio funzionamento cognitivo quotidiano √® peggiorato",
];
var SCD_OPTS = ["No (0)","S√¨ (1)"];
function scoreSCD(r){
  const total=r.reduce((a,v)=>a+(v??0),0);
  return {total, concern:total>=6};
}

// ‚îÄ‚îÄ PHENO AGE (Levine) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Coefficients from Levine et al. 2018
var PHENOAGE_COEF = {
  intercept: -19.9067,
  age:        0.0804,
  albumin:   -0.0336,   // g/L
  creatinine: 0.0095,   // ¬µmol/L
  glucose:    0.1953,   // mmol/L
  lnCRP:      0.0954,   // ln(CRP mg/dL)
  lymph:     -0.0120,   // lymphocyte %
  mcv:        0.0268,   // fL
  rdw:        0.3306,   // %
  alkphos:    0.00190,  // U/L
  wbc:        0.0554,   // 10^3/¬µL
};
var PHENOAGE_GAMMA = 0.0076927;
var PHENOAGE_T = 120; // 10 years in months

function calcPhenoAge(inputs){
  // inputs: {age, albumin_gdl, creatinine_mgdl, glucose_mgdl, crp_mgl, lymph_pct, mcv_fl, rdw_pct, alkphos_ul, wbc_k}
  const alb_gl = inputs.albumin_gdl * 10;
  const crea_umol = inputs.creatinine_mgdl * 88.4;
  const gluc_mmol = inputs.glucose_mgdl / 18;
  const crp_mgdl = inputs.crp_mgl / 10;
  const lnCRP = Math.log(Math.max(crp_mgdl, 0.001));

  const xb = PHENOAGE_COEF.intercept
    + PHENOAGE_COEF.age * inputs.age
    + PHENOAGE_COEF.albumin * alb_gl
    + PHENOAGE_COEF.creatinine * crea_umol
    + PHENOAGE_COEF.glucose * gluc_mmol
    + PHENOAGE_COEF.lnCRP * lnCRP
    + PHENOAGE_COEF.lymph * inputs.lymph_pct
    + PHENOAGE_COEF.mcv * inputs.mcv_fl
    + PHENOAGE_COEF.rdw * inputs.rdw_pct
    + PHENOAGE_COEF.alkphos * inputs.alkphos_ul
    + PHENOAGE_COEF.wbc * inputs.wbc_k;

  const mortality = 1 - Math.exp(-Math.exp(xb) / PHENOAGE_GAMMA * (Math.exp(PHENOAGE_GAMMA * PHENOAGE_T) - 1));
  const phenoAge = Math.log(-Math.log(1 - mortality)) / 0.0076927 + 141.50225;
  const accel = phenoAge - inputs.age;

  return {
    phenoAge: Math.round(phenoAge * 10) / 10,
    accel: Math.round(accel * 10) / 10,
    mortality: Math.round(mortality * 1000) / 10, // % √ó 10 = per mille? no, %
    xb: Math.round(xb * 1000) / 1000,
  };
}

var PHENOAGE_FIELDS = [
  {key:'age',         label:'Et√†',                unit:'anni',    min:20,  max:120, step:1,  hint:''},
  {key:'albumin_gdl', label:'Albumina',            unit:'g/dL',   min:1,   max:6,   step:0.1,hint:'Range normale: 3.5‚Äì5.0'},
  {key:'creatinine_mgdl',label:'Creatinina',       unit:'mg/dL',  min:0.1, max:20,  step:0.01,hint:'Range normale: 0.6‚Äì1.2'},
  {key:'glucose_mgdl',label:'Glucosio (digiuno)',  unit:'mg/dL',  min:50,  max:500, step:1,  hint:'Range normale: 70‚Äì100'},
  {key:'crp_mgl',     label:'PCR (CRP)',           unit:'mg/L',   min:0,   max:200, step:0.1,hint:'Range normale: < 5.0'},
  {key:'lymph_pct',   label:'Linfociti %',         unit:'%',      min:0,   max:100, step:0.1,hint:'Range normale: 20‚Äì40'},
  {key:'mcv_fl',      label:'MCV',                 unit:'fL',     min:50,  max:130, step:0.1,hint:'Range normale: 80‚Äì100'},
  {key:'rdw_pct',     label:'RDW',                 unit:'%',      min:10,  max:30,  step:0.1,hint:'Range normale: 11.5‚Äì14.5'},
  {key:'alkphos_ul',  label:'Fosfatasi alcalina',  unit:'U/L',    min:10,  max:1000,step:1,  hint:'Range normale: 44‚Äì147'},
  {key:'wbc_k',       label:'Globuli bianchi (WBC)',unit:'10¬≥/¬µL', min:1,   max:30,  step:0.1,hint:'Range normale: 4.5‚Äì11.0'},
];


// =====================================================================
// SUPABASE CONFIG ‚Äî REST API DIRETTO (no SDK, no Navigator Lock)
// =====================================================================
const SUPABASE_URL = 'https://ekqvqnhpofxoegjfgznf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrcXZxbmhwb2Z4b2VnamZnem5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NjI1NTgsImV4cCI6MjA4NzMzODU1OH0.PVHjQAycvZs0M72_of9QGKrkVvP9B-IKRCCPsdBnMLE';
const AUTH_URL = SUPABASE_URL + '/auth/v1';
const REST_URL = SUPABASE_URL + '/rest/v1';

let currentUser = null;
let accessToken = null;
let refreshToken = null;
let authMode = 'login';

// ‚îÄ‚îÄ Helpers REST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function authHeaders(){
  return {
    'Content-Type': 'application/json',
    'apikey': SUPABASE_KEY,
    'Authorization': 'Bearer ' + (accessToken || SUPABASE_KEY),
  };
}

async function sbFetch(method, path, body=null, params={}){
  const url = new URL(REST_URL + path);
  Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
  const headers = authHeaders();
  if(method==='POST') headers['Prefer'] = 'return=representation';
  if(method==='PATCH') headers['Prefer'] = 'return=representation';
  const opts = { method, headers };
  if(body) opts.body = JSON.stringify(body);
  const res = await fetch(url.toString(), opts);
  if(!res.ok){
    const err = await res.json().catch(()=>({message:res.statusText}));
    throw new Error(err.message || res.statusText);
  }
  if(res.status===204) return null;
  return res.json();
}

// ‚îÄ‚îÄ Session persistence ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveSession(access, refresh, user){
  accessToken = access;
  refreshToken = refresh;
  currentUser = user;
  localStorage.setItem('dcpro_session', JSON.stringify({access, refresh, user}));
}

function loadSession(){
  try{
    const s = localStorage.getItem('dcpro_session');
    if(!s) return false;
    const {access, refresh, user} = JSON.parse(s);
    accessToken = access;
    refreshToken = refresh;
    currentUser = user;
    return true;
  } catch(e){ return false; }
}

function clearSession(){
  accessToken = null;
  refreshToken = null;
  currentUser = null;
  localStorage.removeItem('dcpro_session');
}

async function refreshAccessToken(){
  if(!refreshToken) return false;
  try{
    const res = await fetch(AUTH_URL + '/token?grant_type=refresh_token', {
      method: 'POST',
      headers: {'Content-Type':'application/json','apikey':SUPABASE_KEY},
      body: JSON.stringify({refresh_token: refreshToken})
    });
    if(!res.ok) return false;
    const data = await res.json();
    saveSession(data.access_token, data.refresh_token, data.user);
    return true;
  } catch(e){ return false; }
}

// ‚îÄ‚îÄ Auth functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleAuthMode(){
  authMode = authMode==='login'?'register':'login';
  document.getElementById('loginSubtitle').textContent = authMode==='login'?'Accedi al tuo account':'Crea un nuovo account';
  document.getElementById('loginBtn').textContent = authMode==='login'?'Accedi':'Registrati';
  document.getElementById('loginToggleText').textContent = authMode==='login'?'Non hai un account?':'Hai gi√† un account?';
  document.getElementById('loginToggleLink').textContent = authMode==='login'?'Registrati':'Accedi';
  document.getElementById('loginNameField').style.display = authMode==='register'?'block':'none';
  document.getElementById('loginError').style.display='none';
}

async function handleAuth(){
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPassword').value;
  const name = document.getElementById('loginDisplayName').value.trim();
  const btn = document.getElementById('loginBtn');
  const errEl = document.getElementById('loginError');
  errEl.style.display='none';
  if(!email||!pass){errEl.textContent='Inserisci email e password.';errEl.style.display='block';return;}
  btn.disabled=true; btn.textContent=authMode==='login'?'Accesso in corso...':'Registrazione...';
  try{
    if(authMode==='register'){
      const res = await fetch(AUTH_URL+'/signup', {
        method:'POST',
        headers:{'Content-Type':'application/json','apikey':SUPABASE_KEY},
        body: JSON.stringify({email, password:pass, data:{display_name:name||email.split('@')[0]}})
      });
      const data = await res.json();
      if(data.error) throw new Error(data.error_description||data.error);
      if(data.access_token){
        saveSession(data.access_token, data.refresh_token, data.user);
        onLoginSuccess();
      } else {
        errEl.style.background='#e8f5e9';errEl.style.color='#2e7d32';
        errEl.textContent='‚úÖ Registrazione completata! Accedi con le tue credenziali.';
        errEl.style.display='block';
        authMode='login';
      }
    } else {
      const res = await fetch(AUTH_URL+'/token?grant_type=password', {
        method:'POST',
        headers:{'Content-Type':'application/json','apikey':SUPABASE_KEY},
        body: JSON.stringify({email, password:pass})
      });
      const data = await res.json();
      if(data.error) throw new Error(data.error_description||data.error);
      saveSession(data.access_token, data.refresh_token, data.user);
      onLoginSuccess();
    }
  } catch(err){
    errEl.textContent = err.message==='Invalid login credentials'?'Email o password errati.':err.message;
    errEl.style.display='block';
  }
  btn.disabled=false; btn.textContent=authMode==='login'?'Accedi':'Registrati';
}

async function onLoginSuccess(){
  const name = currentUser?.user_metadata?.display_name || currentUser?.email?.split('@')[0] || 'Utente';
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('userBadge').style.display='flex';
  document.getElementById('userAvatar').textContent = name.substring(0,2).toUpperCase();
  document.getElementById('userNameLabel').textContent = name;
  setSyncStatus('syncing','Caricamento...');
  await loadData();
  renderPatList();
  renderMain('visits');
}

async function handleLogout(){
  if(!confirm('Vuoi davvero uscire?'))return;
  try{
    await fetch(AUTH_URL+'/logout', {
      method:'POST',
      headers:{...authHeaders(),'Content-Type':'application/json'}
    });
  } catch(e){}
  clearSession();
  currentUser=null;
  state.patients=[];
  state.customProducts=[];
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('userBadge').style.display='none';
  renderPatList();
  setSyncStatus('err','Non connesso');
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('loginPassword')?.addEventListener('keydown',e=>{if(e.key==='Enter')handleAuth();});
  document.getElementById('loginEmail')?.addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPassword').focus();});
});

// =====================================================================
// SYNC STATUS
// =====================================================================
function setSyncStatus(type, label){
  const dot = document.getElementById('syncDot');
  const lbl = document.getElementById('syncLabel');
  dot.className = 'sync-dot '+(type==='ok'?'ok':type==='syncing'?'syncing':'err');
  lbl.textContent = label;
}

// ‚îÄ‚îÄ Init: restore session on page load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async ()=>{
  if(loadSession()){
    // Try to refresh token first
    const ok = await refreshAccessToken();
    if(ok){
      await onLoginSuccess();
      return;
    } else {
      clearSession();
    }
  }
  // No valid session ‚Äî show login
  document.getElementById('loginScreen').classList.remove('hidden');
  setSyncStatus('err','Accedi per continuare');
})();

// =====================================================================
// DATA LAYER ‚Äî REST API diretta
// =====================================================================
async function loadData(){
  if(!currentUser){ loadLocalFallback(); return; }
  try{
    setSyncStatus('syncing','Caricamento...');
    // Load patients
    const pats = await sbFetch('GET', '/patients', null, {'select':'*','order':'name'});
    // Load sessions
    const patIds = pats.map(p=>p.id);
    let sessionsMap = {};
    if(patIds.length){
      const sessions = await sbFetch('GET', '/sessions', null, {
        'select':'*',
        'patient_id': 'in.('+patIds.join(',')+')'
      });
      (sessions||[]).forEach(s=>{
        if(!sessionsMap[s.patient_id]) sessionsMap[s.patient_id]={};
        sessionsMap[s.patient_id][s.session_date]={
          gae:s.gae, flebo:s.flebo, pae:s.pae,
          products:s.products||[], notes:s.notes||'',
          longevity:s.longevity||{}, longevityNotes:s.longevity_notes||'',
          pain:s.pain||{}, questionari:s.questionari||{},
          referti:s.referti||[], savedAt:s.saved_at
        };
      });
    }
    // Load custom products
    const cProds = await sbFetch('GET', '/custom_products', null, {'select':'*','order':'name'});
    // Build state
    state.patients = pats.map(p=>({
      id:p.id, name:p.name, dob:p.dob||'', sex:p.sex||'',
      diag:p.diag||'', contact:p.contact||'',
      sessions: sessionsMap[p.id]||{}
    }));
    state.customProducts = (cProds||[]).map(p=>({name:p.name, dose:p.dose||''}));
    localStorage.setItem('dcpro_v3', JSON.stringify({patients:state.patients, customProducts:state.customProducts}));
    setSyncStatus('ok','Connesso');
  } catch(err){
    console.error('loadData error:', err);
    // Try token refresh
    if(err.message && (err.message.includes('401') || err.message.includes('JWT'))){
      const ok = await refreshAccessToken();
      if(ok){ await loadData(); return; }
      clearSession();
      document.getElementById('loginScreen').classList.remove('hidden');
      setSyncStatus('err','Sessione scaduta ‚Äî accedi di nuovo');
      return;
    }
    setSyncStatus('err','Offline ‚Äî dati locali');
    loadLocalFallback();
  }
}

function loadLocalFallback(){
  const s = localStorage.getItem('dcpro_v3');
  if(s) try{ const d=JSON.parse(s); state.patients=d.patients||[]; state.customProducts=d.customProducts||[]; }catch(e){}
}

function saveData(){
  localStorage.setItem('dcpro_v3', JSON.stringify({patients:state.patients, customProducts:state.customProducts}));
}

async function setSess(pid, date, data){
  const p = state.patients.find(x=>x.id===pid);
  if(!p) return;
  if(!p.sessions) p.sessions={};
  p.sessions[date] = data;
  saveData();
  if(!currentUser) return;
  setSyncStatus('syncing','Salvataggio...');
  try{
    const body = {
      patient_id: pid, session_date: date,
      gae: data.gae||false, flebo: data.flebo||false, pae: data.pae||false,
      products: data.products||[], notes: data.notes||'',
      longevity: data.longevity||{}, longevity_notes: data.longevityNotes||'',
      pain: data.pain||{}, questionari: data.questionari||{},
      referti: data.referti||[], saved_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    // Check if session exists
    const existing = await sbFetch('GET', '/sessions', null, {
      'patient_id': 'eq.'+pid, 'session_date': 'eq.'+date, 'select':'id'
    });
    console.log('setSess existing:', existing, 'for', pid, date);
    if(existing && existing.length){
      await sbFetch('PATCH', '/sessions', body, {'patient_id':'eq.'+pid,'session_date':'eq.'+date});
    } else {
      await sbFetch('POST', '/sessions', body);
    }
    setSyncStatus('ok','Salvato ‚úì');
    setTimeout(()=>setSyncStatus('ok','Connesso'),2000);
  } catch(err){
    console.error('setSess error:', err.message);
    setSyncStatus('err','Errore salvataggio');
    showToast('‚ö†Ô∏è Errore salvataggio ‚Äî dati in locale','warning');
  }
}

async function savePat(){
  const name = document.getElementById('patName').value.trim();
  if(!name){showToast('‚ö†Ô∏è Inserisci il nome','warning');return;}
  const patData = {
    name, dob:document.getElementById('patDob').value,
    sex:document.getElementById('patSex').value,
    diag:document.getElementById('patDiag').value.trim(),
    contact:document.getElementById('patContact').value.trim()
  };
  if(currentUser){
    setSyncStatus('syncing','Salvataggio...');
    try{
      if(editingPat){
        await sbFetch('PATCH', '/patients', {...patData, updated_at:new Date().toISOString()}, {'id':'eq.'+editingPat});
        const p=state.patients.find(x=>x.id===editingPat);
        if(p) Object.assign(p, patData);
      } else {
        const data = await sbFetch('POST', '/patients', {...patData, created_by:currentUser.id});
        const newPat = Array.isArray(data)?data[0]:data;
        state.patients.push({...patData, id:newPat.id, sessions:{}});
      }
      setSyncStatus('ok','Connesso');
    } catch(err){
      console.error('savePat error:', err);
      setSyncStatus('err','Errore');
      showToast('‚ö†Ô∏è Errore salvataggio paziente: '+err.message,'warning');
      return;
    }
  } else {
    if(editingPat){
      const p=state.patients.find(x=>x.id===editingPat);
      if(p) Object.assign(p,patData);
    } else {
      state.patients.push({id:'p_'+Date.now(),...patData,sessions:{}});
    }
  }
  saveData(); closeModal('patModal'); renderPatList();
  showToast('‚úÖ Paziente salvato!','success');
}

async function deletePat(id){
  if(!confirm('Eliminare questo paziente e tutte le sue visite?'))return;
  if(currentUser){
    setSyncStatus('syncing','Eliminazione...');
    try{
      await sbFetch('DELETE', '/sessions', null, {'patient_id':'eq.'+id});
      await sbFetch('DELETE', '/patients', null, {'id':'eq.'+id});
      setSyncStatus('ok','Connesso');
    } catch(err){ setSyncStatus('err','Errore'); showToast('‚ö†Ô∏è Errore eliminazione','warning'); return; }
  }
  state.patients=state.patients.filter(x=>x.id!==id);
  state.selectedPatient=null; saveData(); renderPatList(); renderMain('visits');
}

async function deleteSess(pid, date){
  if(!confirm('Eliminare questa sessione?'))return;
  if(currentUser){
    try{
      await sbFetch('DELETE', '/sessions', null, {'patient_id':'eq.'+pid,'session_date':'eq.'+date});
    } catch(err){ showToast('‚ö†Ô∏è Errore eliminazione sessione','warning'); }
  }
  const p=state.patients.find(x=>x.id===pid);
  if(p&&p.sessions) delete p.sessions[date];
  saveData();
  const t=document.querySelector('.tab-btn.active');
  renderMain(t?['visits','scheda','trend','longevity','pain','questionari','referti','history'][Array.from(document.querySelectorAll('.tab-btn')).indexOf(t)]:'visits');
}

async function saveCustomProd(name, dose){
  if(currentUser){
    try{
      const data = await sbFetch('POST', '/custom_products', {name, dose, created_by:currentUser.id});
    } catch(err){ showToast('‚ö†Ô∏è Errore salvataggio prodotto','warning'); }
  }
  state.customProducts.push({name, dose});
  saveData(); renderProdsEdit();
}

async function removeCustomProd(i){
  const prod = state.customProducts[i];
  if(currentUser && prod){
    try{ await sbFetch('DELETE', '/custom_products', null, {'name':'eq.'+prod.name}); }catch(e){}
  }
  state.customProducts.splice(i,1);
  saveData(); renderProdsEdit();
}

// Realtime ‚Äî polling ogni 30s invece di websocket
let realtimeInterval = null;
function setupRealtime(){
  if(realtimeInterval) clearInterval(realtimeInterval);
  realtimeInterval = setInterval(async ()=>{
    if(!currentUser) return;
    await loadData();
    renderPatList();
    const t=document.querySelector('.tab-btn.active');
    if(t) renderMain(['visits','scheda','trend','longevity','pain','questionari','referti','history'][Array.from(document.querySelectorAll('.tab-btn')).indexOf(t)]);
  }, 30000);
}

// Reload on visibility change
document.addEventListener('visibilitychange', async ()=>{
  if(document.visibilityState==='visible' && currentUser){
    await loadData();
    renderPatList();
  }
});

function getPat(){return state.patients.find(p=>p.id===state.selectedPatient);}
function getSess(pid,date){const p=state.patients.find(x=>x.id===pid);if(!p)return null;if(!p.sessions)p.sessions={};return p.sessions[date]||null;}
function getPat(){return state.patients.find(p=>p.id===state.selectedPatient);}
// =====================================================================
// TAB SWITCHING
// =====================================================================
function switchTab(tab){
  document.querySelectorAll('.tab-btn').forEach((b,i)=>{
    b.classList.toggle('active',['visits','scheda','trend','longevity','pain','questionari','referti','history'][i]===tab);
  });
  renderMain(tab);
}

// =====================================================================
// PATIENT LIST
// =====================================================================
function renderPatList(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const f=state.patients.filter(p=>p.name.toLowerCase().includes(q));
  document.getElementById('patCount').textContent=state.patients.length;
  const list=document.getElementById('patList');
  if(state.patients.length===0){
    list.innerHTML=`
      <div style="padding:18px 14px;text-align:center;">
        <div style="font-size:2rem;margin-bottom:8px;">üìã</div>
        <div style="font-size:.8rem;color:rgba(255,255,255,.45);margin-bottom:12px;line-height:1.5;">Nessun paziente.<br>Clicca "+" per aggiungerne uno.</div>
        <button onclick="reloadFromSupabase()" style="width:100%;padding:8px 10px;background:rgba(61,155,140,.15);color:#3d9b8c;border:1px solid rgba(61,155,140,.3);border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:.75rem;font-weight:500;line-height:1.4;">
          üîÑ Carica pazienti<br><span style="opacity:.7;font-weight:400;">dal database</span>
        </button>
      </div>`;
    return;
  }
  if(!f.length){list.innerHTML=`<div style="padding:18px;text-align:center;color:var(--ink-li);font-size:.85rem;">Nessun paziente trovato</div>`;return;}
  list.innerHTML=f.map(p=>`
    <div class="patient-item ${state.selectedPatient===p.id?'active':''}" onclick="selectPat('${p.id}')">
      <div class="patient-avatar">${initials(p.name)}</div>
      <div class="patient-info">
        <div class="patient-name">${p.name}</div>
        <div class="patient-meta">${p.dob?fmtDate(p.dob):''} ${p.sex?'¬∑ '+p.sex:''}</div>
      </div>
    </div>`).join('');
}
async function reloadFromSupabase(){
  setSyncStatus('syncing','Caricamento...');
  // Try to refresh token
  if(refreshToken) await refreshAccessToken();
  if(currentUser){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('userBadge').style.display='flex';
    const name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
    document.getElementById('userAvatar').textContent = name.substring(0,2).toUpperCase();
    document.getElementById('userNameLabel').textContent = name;
  }
  await loadData();
  renderPatList();
  renderMain('visits');
}

function selectPat(id){state.selectedPatient=id;state.selectedDate=todayStr();renderPatList();const t=document.querySelector('.tab-btn.active');renderMain(t?['visits','scheda','trend','longevity','pain','questionari','referti','history'][Array.from(document.querySelectorAll('.tab-btn')).indexOf(t)]:'visits');}

// =====================================================================
// MAIN RENDER
// =====================================================================
function renderMain(tab='visits'){
  const panel=document.getElementById('mainPanel');
  const pat=getPat();
  if(!pat){panel.innerHTML=`<div class="empty-state"><div class="emoji">üè•</div><p>Seleziona un paziente.</p></div>`;return;}
  if(tab==='visits') panel.innerHTML=renderVisits(pat);
  else if(tab==='scheda') panel.innerHTML=renderScheda(pat);
  else if(tab==='trend'){panel.innerHTML=renderTrend(pat);setTimeout(()=>drawCharts(pat),100);}
  else if(tab==='longevity') panel.innerHTML=renderLongevity(pat);
  else if(tab==='pain') panel.innerHTML=renderPainScale(pat);
  else if(tab==='questionari') panel.innerHTML=renderQuestionari(pat);
  else if(tab==='referti') panel.innerHTML=renderReferti(pat);
  else if(tab==='history') panel.innerHTML=renderHistory(pat);
  attachEvents(tab, pat);
}

// =====================================================================
// TREND / CHARTS TAB
// =====================================================================
let activeCharts = {};
let trendRange = 90;

function renderTrend(pat){
  const sessions = pat.sessions || {};
  const dates = Object.keys(sessions).sort();
  const totalVisits = dates.length;
  const gaeCount = dates.filter(d=>sessions[d].gae).length;
  const fleboCount = dates.filter(d=>sessions[d].flebo).length;
  const paeCount = dates.filter(d=>sessions[d].pae).length;
  const lvDates = dates.filter(d=>sessions[d].longevity&&sessions[d].longevity.readiness!==undefined);
  const painDates = dates.filter(d=>sessions[d].pain&&sessions[d].pain.nrs!==undefined);
  const latestLv = lvDates.length?sessions[lvDates[lvDates.length-1]].longevity:null;
  const prevLv = lvDates.length>1?sessions[lvDates[lvDates.length-2]].longevity:null;
  const latestPain = painDates.length?sessions[painDates[painDates.length-1]].pain.nrs:null;
  const prevPain = painDates.length>1?sessions[painDates[painDates.length-2]].pain.nrs:null;
  const delta=(a,b,inv=false)=>{if(a==null||b==null)return'';const d=Math.round(a-b);if(d===0)return`<span class="kpi-same">‚Üí stabile</span>`;const up=inv?d<0:d>0;return`<span class="${up?'kpi-up':'kpi-down'}">${d>0?'‚ñ≤':'‚ñº'} ${Math.abs(d)}</span>`;};
  return `<div class="trend-page">
    <div class="trend-header">
      <div><h2>üìà Andamento ‚Äî ${pat.name}</h2>
        <p>${totalVisits} visite ¬∑ ${lvDates.length} longevity ¬∑ ${painDates.length} dolore</p></div>
      <div class="trend-controls">
        <span style="font-size:.78rem;color:rgba(255,255,255,.5);">Periodo:</span>
        ${[30,60,90,180,365].map(r=>`<button class="trend-range-btn ${trendRange===r?'active':''}" onclick="setTrendRange(${r},'${pat.id}')">${r}gg</button>`).join('')}
        <button class="trend-range-btn ${trendRange===9999?'active':''}" onclick="setTrendRange(9999,'${pat.id}')">Tutto</button>
      </div>
    </div>
    <div class="trend-summary-bar">
      <div class="trend-kpi" style="border-left-color:var(--teal);">
        <div class="kpi-label">Readiness Score</div>
        <div class="kpi-value">${latestLv?Math.round(latestLv.readiness):'‚Äî'}</div>
        <div class="kpi-delta">${delta(latestLv?.readiness,prevLv?.readiness)}</div>
      </div>
      <div class="trend-kpi" style="border-left-color:var(--rust);">
        <div class="kpi-label">Dolore NRS</div>
        <div class="kpi-value">${latestPain!==null&&latestPain!==undefined?latestPain:'‚Äî'}</div>
        <div class="kpi-delta">${delta(latestPain,prevPain,true)}</div>
      </div>
      <div class="trend-kpi" style="border-left-color:var(--gold);">
        <div class="kpi-label">Aging Gap</div>
        <div class="kpi-value">${latestLv&&latestLv.agingGap!==undefined?Math.round(latestLv.agingGap)+'%':'‚Äî'}</div>
        <div class="kpi-delta">${delta(latestLv?.agingGap,prevLv?.agingGap,true)}</div>
      </div>
      <div class="trend-kpi" style="border-left-color:var(--purple);">
        <div class="kpi-label">Visite totali</div>
        <div class="kpi-value">${totalVisits}</div>
        <div class="kpi-delta" style="font-size:.72rem;color:var(--ink-li);">GAE:${gaeCount} ¬∑ Flebo:${fleboCount} ¬∑ PAE:${paeCount}</div>
      </div>
    </div>
    <div class="charts-grid">
      <div class="chart-card wide">
        <div class="chart-header"><h3>üß¨ Readiness Score nel tempo</h3><span>Longevity Trajectory Score (0‚Äì100)</span></div>
        <div class="chart-body">${lvDates.length<2?`<div class="chart-no-data">üì≠ Servono almeno 2 screening longevity per visualizzare il grafico.</div>`:`<div class="chart-canvas-wrap tall"><canvas id="chartReadiness"></canvas></div>`}</div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><h3>üï∏ Profilo Longevity (ultimo)</h3><span>Radar per dominio</span></div>
        <div class="chart-body">${latestLv?`<div class="chart-canvas-wrap"><canvas id="chartRadar"></canvas></div>`:`<div class="chart-no-data">üì≠ Nessuno screening disponibile.</div>`}</div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><h3>üìç Scala del Dolore NRS</h3><span>Intensit√† nel tempo</span></div>
        <div class="chart-body">${painDates.length<2?`<div class="chart-no-data">üì≠ Servono almeno 2 valutazioni del dolore.</div>`:`<div class="chart-canvas-wrap"><canvas id="chartPain"></canvas></div>`}</div>
      </div>
      <div class="chart-card wide">
        <div class="chart-header"><h3>üóì Frequenza Trattamenti</h3><span>Ultime ${Math.min(totalVisits,60)} visite</span></div>
        <div class="chart-body">
          ${!totalVisits?`<div class="chart-no-data">üì≠ Nessuna visita.</div>`:`
          <div style="display:flex;gap:14px;margin-bottom:10px;flex-wrap:wrap;">
            ${[['dot-gae','GAE'],['dot-flebo','Flebo'],['dot-pae','PAE'],['dot-multi','Multipli']].map(([cls,l])=>`<span style="font-size:.75rem;display:flex;align-items:center;gap:5px;"><span class="freq-dot ${cls}" style="width:14px;height:14px;border-radius:3px;display:inline-block;"></span>${l}</span>`).join('')}
          </div>
          <div class="treat-freq-grid" id="freqGrid"></div>`}
        </div>
      </div>
      ${painDates.length>=2?`
      <div class="chart-card wide">
        <div class="chart-header"><h3>üìä Impatto Funzionale del Dolore</h3><span>BPI adattato ‚Äî 6 dimensioni (0‚Äì10)</span></div>
        <div class="chart-body"><div class="chart-canvas-wrap tall"><canvas id="chartImpact"></canvas></div></div>
      </div>`:''}
    </div>
  </div>`;
}

function setTrendRange(days,pid){trendRange=days;state.selectedPatient=pid;renderMain('trend');}

function drawCharts(pat){
  const sessions=pat.sessions||{};
  const now=new Date();
  const cutoff=new Date(now-trendRange*86400000);
  const filterD=d=>trendRange===9999||new Date(d+'T12:00:00')>=cutoff;
  const lvDates=Object.keys(sessions).sort().filter(d=>filterD(d)&&sessions[d].longevity&&sessions[d].longevity.readiness!==undefined);
  const painDates=Object.keys(sessions).sort().filter(d=>filterD(d)&&sessions[d].pain&&sessions[d].pain.nrs!==undefined);
  const allDates=Object.keys(sessions).sort().filter(filterD);
  Object.values(activeCharts).forEach(c=>{try{c.destroy();}catch(e){}});
  activeCharts={};
  const fmtS=d=>{const[y,m,dd]=d.split('-');return`${dd}/${m}`;};
  const gC='rgba(0,0,0,.06)',ff="'DM Sans',sans-serif";

  // 1 ‚Äî Readiness line
  if(lvDates.length>=2&&document.getElementById('chartReadiness')){
    activeCharts.readiness=new Chart(document.getElementById('chartReadiness').getContext('2d'),{
      type:'line',
      data:{labels:lvDates.map(fmtS),datasets:[
        {label:'Readiness',data:lvDates.map(d=>Math.round(sessions[d].longevity.readiness)),borderColor:'#2d7a6e',backgroundColor:'rgba(45,122,110,.12)',borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#2d7a6e',fill:true,tension:.35},
        {label:'Aging Gap%',data:lvDates.map(d=>sessions[d].longevity.agingGap!=null?Math.round(sessions[d].longevity.agingGap):null),borderColor:'#d4a843',backgroundColor:'rgba(212,168,67,.06)',borderWidth:2,pointRadius:4,pointBackgroundColor:'#d4a843',fill:false,tension:.35,borderDash:[5,4]}
      ]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{labels:{font:{family:ff,size:12}}},tooltip:{mode:'index',intersect:false}},
        scales:{
          y:{min:0,max:100,grid:{color:gC},ticks:{font:{family:ff,size:11}},
            afterDraw:chart=>{
              const{ctx,chartArea:{left,right},scales:{y}}=chart;
              [[70,'#4caf7d','Verde'],[50,'#fbc02d','Giallo'],[35,'#fb8c00','Arancione']].forEach(([v,col,lbl])=>{
                const yp=y.getPixelForValue(v);
                ctx.save();ctx.strokeStyle=col;ctx.lineWidth=1;ctx.setLineDash([3,4]);
                ctx.beginPath();ctx.moveTo(left,yp);ctx.lineTo(right,yp);ctx.stroke();
                ctx.fillStyle=col;ctx.font=`10px ${ff}`;ctx.fillText(lbl,right-50,yp-3);ctx.restore();
              });
            }
          },
          x:{grid:{display:false},ticks:{font:{family:ff,size:11}}}
        }
      }
    });
  }

  // 2 ‚Äî Radar last longevity
  if(lvDates.length&&document.getElementById('chartRadar')){
    const last=sessions[lvDates[lvDates.length-1]].longevity;
    const prev=lvDates.length>1?sessions[lvDates[lvDates.length-2]].longevity:null;
    const labels=['Sonno','Stress','Movimento','Funz. Fisica','Energia','Carico Clin.'];
    const keys=['sleepScore','stressScore','movScore','functionScore','energyScore','burdenScore'];
    const ds=[{label:'Attuale',data:keys.map(k=>last[k]!=null?Math.round(last[k]):null),backgroundColor:'rgba(45,122,110,.2)',borderColor:'#2d7a6e',pointBackgroundColor:'#2d7a6e',borderWidth:2}];
    if(prev)ds.push({label:'Precedente',data:keys.map(k=>prev[k]!=null?Math.round(prev[k]):null),backgroundColor:'rgba(212,168,67,.1)',borderColor:'#d4a843',pointBackgroundColor:'#d4a843',borderWidth:1.5,borderDash:[4,3]});
    activeCharts.radar=new Chart(document.getElementById('chartRadar').getContext('2d'),{
      type:'radar',data:{labels,datasets:ds},
      options:{responsive:true,maintainAspectRatio:false,
        scales:{r:{min:0,max:100,ticks:{stepSize:25,font:{family:ff,size:10},backdropColor:'transparent'},pointLabels:{font:{family:ff,size:11}},grid:{color:gC}}},
        plugins:{legend:{labels:{font:{family:ff,size:11}}}}
      }
    });
  }

  // 3 ‚Äî Pain line
  if(painDates.length>=2&&document.getElementById('chartPain')){
    const vals=painDates.map(d=>sessions[d].pain.nrs);
    activeCharts.pain=new Chart(document.getElementById('chartPain').getContext('2d'),{
      type:'line',
      data:{labels:painDates.map(fmtS),datasets:[{
        label:'NRS Dolore',data:vals,borderColor:'#c0522a',backgroundColor:'rgba(192,82,42,.1)',
        borderWidth:2.5,tension:.3,fill:true,
        pointBackgroundColor:vals.map(v=>v<=3?'#4caf7d':v<=6?'#fbc02d':'#e53935'),
        pointRadius:6
      }]},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`NRS: ${c.parsed.y}/10`}}},
        scales:{y:{min:0,max:10,ticks:{stepSize:1,font:{family:ff,size:11}},grid:{color:gC}},x:{grid:{display:false},ticks:{font:{family:ff,size:11}}}}
      }
    });
  }

  // 4 ‚Äî Impact multi-line
  if(painDates.length>=2&&document.getElementById('chartImpact')){
    const impK=[['painActivity','Attivit√†','#e53935'],['painMood','Umore','#8e24aa'],['painWork','Lavoro','#1e88e5'],['painRelations','Relazioni','#00897b'],['painSleep','Sonno','#f4511e'],['painLifeEnjoy','Piacere vita','#43a047']];
    activeCharts.impact=new Chart(document.getElementById('chartImpact').getContext('2d'),{
      type:'line',
      data:{labels:painDates.map(fmtS),datasets:impK.filter(([k])=>painDates.some(d=>sessions[d].pain[k]!=null)).map(([k,l,col])=>({
        label:l,data:painDates.map(d=>sessions[d].pain[k]!=null?sessions[d].pain[k]:null),
        borderColor:col,backgroundColor:'transparent',borderWidth:2,pointRadius:4,tension:.3,spanGaps:true
      }))},
      options:{responsive:true,maintainAspectRatio:false,
        plugins:{legend:{position:'bottom',labels:{font:{family:ff,size:11},usePointStyle:true}},tooltip:{mode:'index',intersect:false}},
        scales:{y:{min:0,max:10,ticks:{stepSize:2,font:{family:ff,size:11}},grid:{color:gC}},x:{grid:{display:false},ticks:{font:{family:ff,size:11}}}}
      }
    });
  }

  // 5 ‚Äî Freq dots
  const fg=document.getElementById('freqGrid');
  if(fg&&allDates.length){
    fg.innerHTML=allDates.slice(-60).map(d=>{
      const s=sessions[d],count=[s.gae,s.flebo,s.pae].filter(Boolean).length;
      let cls='dot-empty',em='¬∑';
      if(count>1){cls='dot-multi';em='‚ú¶';}
      else if(s.gae){cls='dot-gae';em='üíâ';}
      else if(s.flebo){cls='dot-flebo';em='ü©∏';}
      else if(s.pae){cls='dot-pae';em='üî¨';}
      return`<div class="freq-dot ${cls}" title="${fmtDate(d)}${s.gae?' GAE':''}${s.flebo?' Flebo':''}${s.pae?' PAE':''}">${em}</div>`;
    }).join('');
  }
}

// =====================================================================
// SHARE / IMPORT / EXPORT JSON
// =====================================================================
function openShareModal(){
  document.getElementById('importPreview').style.display='none';
  document.getElementById('importFileInput').value='';
  document.getElementById('btnMerge').disabled=true;document.getElementById('btnMerge').style.opacity='.5';
  document.getElementById('btnReplace').disabled=true;document.getElementById('btnReplace').style.opacity='.5';
  document.getElementById('shareExtraInfo').style.display='none';
  document.getElementById('shareModal').classList.add('open');
}

function exportJSON(){
  const data=JSON.stringify({patients:state.patients,customProducts:state.customProducts,exportedAt:new Date().toISOString(),version:'dcpro_v3'},null,2);
  const blob=new Blob([data],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download=`DiarioClinico_backup_${todayStr()}.json`;a.click();
  showToast('üíæ Backup JSON scaricato!','success');
}

let importedData=null;
function previewImport(input){
  const f=input.files[0];if(!f)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      importedData=JSON.parse(e.target.result);
      const pC=importedData.patients?.length||0;
      const vC=importedData.patients?.reduce((a,p)=>a+Object.keys(p.sessions||{}).length,0)||0;
      document.getElementById('importPreview').style.display='block';
      document.getElementById('importPreview').innerHTML=`<div class="sync-info">‚úÖ File valido ¬∑ <strong>${pC} pazienti</strong> ¬∑ <strong>${vC} visite</strong> ¬∑ Esportato: ${importedData.exportedAt?new Date(importedData.exportedAt).toLocaleDateString('it-IT'):'n.d.'}</div>`;
      document.getElementById('btnMerge').disabled=false;document.getElementById('btnMerge').style.opacity='1';
      document.getElementById('btnReplace').disabled=false;document.getElementById('btnReplace').style.opacity='1';
    }catch(err){
      document.getElementById('importPreview').style.display='block';
      document.getElementById('importPreview').innerHTML=`<div class="warning-info">‚ùå File non valido o corrotto.</div>`;
    }
  };
  reader.readAsText(f);
}

function importJSON(mode){
  if(!importedData)return;
  if(mode==='replace'){
    if(!confirm('Sostituire TUTTI i dati con quelli del file importato? Irreversibile.'))return;
    state.patients=importedData.patients||[];
    state.customProducts=importedData.customProducts||[];
  }else{
    (importedData.patients||[]).forEach(imp=>{
      const ex=state.patients.find(p=>p.id===imp.id);
      if(!ex){state.patients.push(imp);}
      else{Object.keys(imp.sessions||{}).forEach(date=>{ex.sessions=ex.sessions||{};if(!ex.sessions[date])ex.sessions[date]=imp.sessions[date];});}
    });
    (importedData.customProducts||[]).forEach(p=>{if(!state.customProducts.find(x=>x.name===p.name))state.customProducts.push(p);});
  }
  saveData();closeModal('shareModal');renderPatList();
  showToast(`‚úÖ Importazione ${mode==='replace'?'completa':'merge'} riuscita!`,'success');
}

function copyHostingInstructions(){
  document.getElementById('shareExtraInfo').style.display='block';
  document.getElementById('shareExtraInfo').innerHTML=`<div class="sync-info"><strong>üåê File su rete locale / NAS:</strong><br>Salva il file HTML su una cartella condivisa. Ogni collaboratore lo apre col proprio browser.<br>‚ö†Ô∏è Ogni browser ha localStorage separato: usate Export/Import JSON per sincronizzare.<br><strong>Workflow pratico:</strong> un "master" esporta il JSON a fine giornata ‚Üí lo carica su Drive ‚Üí gli altri importano il mattino dopo con merge.</div>`;
}
function showNotionOption(){
  document.getElementById('shareExtraInfo').style.display='block';
  document.getElementById('shareExtraInfo').innerHTML=`<div class="sync-info"><strong>‚òÅÔ∏è Workflow con Google Drive / Dropbox:</strong><br>1. Mattina: Importa JSON dalla cartella Drive (merge)<br>2. Lavori normalmente<br>3. Sera: esporta JSON ‚Üí carica su Drive<br>‚úÖ Funziona su qualsiasi dispositivo. Richiede ~10 sec al giorno.</div>`;
}
function showNetlifyOption(){
  document.getElementById('shareExtraInfo').style.display='block';
  document.getElementById('shareExtraInfo').innerHTML=`<div class="sync-info"><strong>üöÄ Deploy su Netlify (gratuito):</strong><br>1. Crea account su netlify.com<br>2. Trascina il file HTML nella dashboard<br>3. Ottieni URL tipo: <em>diario-clinico.netlify.app</em><br>4. Condividi con i collaboratori<br>‚ö†Ô∏è Ogni browser ha localStorage separato ‚Äî usa Export/Import JSON per sincronizzare i dati.<br>Per un vero database condiviso in tempo reale: contattaci per l'integrazione Supabase.</div>`;
}

// =====================================================================
// SCHEDA DEL GIORNO
// =====================================================================
function renderScheda(pat){
  const sess=getSess(pat.id,state.selectedDate)||{};
  const hasAnything=sess.gae||sess.flebo||sess.pae||(sess.products&&sess.products.length)||(sess.pain&&Object.keys(sess.pain).length)||(sess.longevity&&Object.keys(sess.longevity).length)||sess.notes||sess.longevityNotes;

  const pain=sess.pain||{};
  const lv=sess.longevity||{};
  const prods=sess.products||[];
  const stClass=v=>v>=70?'st-green':v>=50?'st-yellow':v>=35?'st-orange':'st-red';
  const fillColor=v=>v>=70?'#4caf7d':v>=50?'#fbc02d':v>=35?'#fb8c00':'#e53935';
  const nrsColor=v=>v===0?'#e8f5e9;color:#2e7d32':v<=3?'#f1f8e9;color:#558b2f':v<=6?'#fff3e0;color:#e65100':v<=8?'#fce4ec;color:#c62828':'#ffebee;color:#b71c1c';
  const nrsLabel=v=>v===0?'Nessun dolore':v<=3?'Dolore lieve':v<=6?'Dolore moderato':v<=8?'Dolore severo':'Dolore insopportabile';

  return `
  <div class="scheda-page">

    <!-- HEADER -->
    <div class="scheda-header-card">
      <div>
        <div class="scheda-patient-name">${pat.name}</div>
        <div class="scheda-date-line">
          <span>üìÖ</span>
          <input type="date" value="${state.selectedDate}" onchange="changeDate(this.value)">
          <button class="btn-today" onclick="changeDate('${todayStr()}')" style="border-color:rgba(255,255,255,.4);color:rgba(255,255,255,.8);">Oggi</button>
        </div>
        <div class="scheda-meta">
          ${pat.dob?`<span class="scheda-meta-item">üìÖ ${fmtDate(pat.dob)}</span>`:''}
          ${pat.sex?`<span class="scheda-meta-item">${pat.sex==='M'?'‚ôÇ':'‚ôÄ'} ${pat.sex}</span>`:''}
          ${pat.diag?`<span class="scheda-meta-item">ü©∫ ${pat.diag}</span>`:''}
          ${pat.contact?`<span class="scheda-meta-item">üìû ${pat.contact}</span>`:''}
        </div>
      </div>
      <div class="scheda-actions">
        <button class="btn-scheda-print" onclick="window.print()">üñ®Ô∏è Stampa / PDF</button>
        <button class="btn-export btn-scheda-print" onclick="exportPatientData('${pat.id}')">üìä Excel</button>
      </div>
    </div>

    ${!hasAnything?`
    <div class="scheda-section full-width" style="grid-column:1/-1;">
      <div class="no-data-day">
        <div class="big-icon">üìã</div>
        <p>Nessun dato registrato per <strong>${fmtDate(state.selectedDate)||'questa data'}</strong>.</p>
        <p style="margin-top:6px;font-size:.8rem;">Vai alla tab <em>Visita</em>, <em>Longevity</em> o <em>Dolore</em> per inserire dati.</p>
        <button class="btn-go" onclick="switchTab('visits')">‚ûú Vai alla Visita</button>
      </div>
    </div>`:`

    <div class="scheda-grid">

      <!-- TRATTAMENTI -->
      <div class="scheda-section">
        <div class="scheda-sec-header"><h3>üíâ Trattamenti</h3></div>
        <div class="scheda-sec-body">
          ${(!sess.gae&&!sess.flebo&&!sess.pae)?`<div class="scheda-empty">Nessun trattamento registrato</div>`:`
          <div class="treat-chips">
            ${sess.gae?`<div class="treat-chip chip-gae">üíâ GAE</div>`:''}
            ${sess.flebo?`<div class="treat-chip chip-flebo">ü©∏ Flebo</div>`:''}
            ${sess.pae?`<div class="treat-chip chip-pae">üî¨ PAE</div>`:''}
          </div>`}
        </div>
      </div>

      <!-- DOLORE NRS SINTESI -->
      <div class="scheda-section">
        <div class="scheda-sec-header">
          <h3>üìç Dolore</h3>
          ${pain.nrs!==undefined?`<button class="btn-scheda-print" style="font-size:.72rem;padding:4px 10px;" onclick="switchTab('pain')">Modifica</button>`:''}
        </div>
        <div class="scheda-sec-body">
          ${pain.nrs!==undefined?`
          <div class="pain-summary-bar">
            <div class="pain-nrs-big" style="background:${nrsColor(pain.nrs).split(';')[0].split(':')[1]};color:${nrsColor(pain.nrs).split(';')[1]?.split(':')[1]||'#333'};">${pain.nrs}</div>
            <div>
              <div class="pain-nrs-desc">${nrsLabel(pain.nrs)}</div>
              <div class="pain-nrs-label">NRS ${pain.nrs}/10</div>
            </div>
          </div>
          ${(pain.qualities||[]).length?`<div style="margin-bottom:8px;"><div style="font-size:.72rem;color:var(--ink-li);margin-bottom:5px;font-weight:600;text-transform:uppercase;">Qualit√†</div>
          <div class="prod-pill-list">${(pain.qualities||[]).map(q=>{const found=PAIN_QUALITIES.find(x=>x.id===q);return`<span class="prod-pill" style="background:#fce4ec;color:#c62828;border-color:#f48fb1;">${found?found.label:q}</span>`;}).join('')}</div></div>`:''}
          ${(pain.locations||[]).length?`<div><div style="font-size:.72rem;color:var(--ink-li);margin-bottom:5px;font-weight:600;text-transform:uppercase;">Localizzazione</div>
          <div class="prod-pill-list">${(pain.locations||[]).map(l=>`<span class="prod-pill" style="background:#fff3e0;color:#e65100;border-color:#ffcc80;">${l}</span>`).join('')}</div></div>`:''}
          ${(pain.timings||[]).length?`<div style="margin-top:8px;"><div style="font-size:.72rem;color:var(--ink-li);margin-bottom:5px;font-weight:600;text-transform:uppercase;">Andamento</div>
          <div class="prod-pill-list">${(pain.timings||[]).map(t=>`<span class="prod-pill">${t}</span>`).join('')}</div></div>`:''}
          ${['painActivity','painMood','painWork','painRelations','painSleep','painLifeEnjoy'].some(k=>pain[k]!==undefined)?`
          <div style="margin-top:12px;"><div style="font-size:.72rem;color:var(--ink-li);margin-bottom:6px;font-weight:600;text-transform:uppercase;">Impatto funzionale</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;">
            ${[['painActivity','Attivit√†'],['painMood','Umore'],['painWork','Lavoro'],['painRelations','Relazioni'],['painSleep','Sonno'],['painLifeEnjoy','Piacere vita']].filter(([k])=>pain[k]!==undefined).map(([k,l])=>`
            <div style="display:flex;align-items:center;justify-content:space-between;font-size:.78rem;padding:3px 6px;background:var(--cream);border-radius:5px;">
              <span style="color:var(--ink-li);">${l}</span>
              <strong style="color:${pain[k]<=3?'var(--green)':pain[k]<=6?'var(--gold)':'var(--rust)'};">${pain[k]}/10</strong>
            </div>`).join('')}
          </div></div>`:''}
          ${pain.notes?`<div class="notes-display" style="margin-top:10px;border-left-color:var(--rust);">${pain.notes}</div>`:''}
          `:`<div class="scheda-empty">Nessuna valutazione del dolore</div><button class="btn-go" style="margin-top:10px;" onclick="switchTab('pain')">‚ûú Inserisci</button>`}
        </div>
      </div>

      <!-- PRODOTTI FLEBO -->
      ${prods.length?`
      <div class="scheda-section full-width">
        <div class="scheda-sec-header"><h3>ü©∏ Prodotti Flebo somministrati</h3><span style="font-size:.78rem;color:var(--ink-li);">${prods.length} prodott${prods.length===1?'o':'i'}</span></div>
        <div class="scheda-sec-body">
          <div class="prod-pill-list">
            ${prods.map(p=>{
              const found=[...PRODUCT_CATALOG,...state.customProducts].find(x=>x.name===p);
              return `<span class="prod-pill" title="${found?found.dose:''}">${p}${found&&found.dose?` <span style="opacity:.6;font-size:.7em;">${found.dose}</span>`:''}</span>`;
            }).join('')}
          </div>
        </div>
      </div>`:''}

      <!-- LONGEVITY -->
      <div class="scheda-section ${Object.keys(lv).length?'':''}">
        <div class="scheda-sec-header">
          <h3>üß¨ Longevity Score</h3>
          ${lv.readiness!==undefined?`<span class="sc-status ${stClass(lv.readiness)}" style="font-size:.72rem;padding:3px 9px;border-radius:10px;font-weight:600;">${Math.round(lv.readiness)}/100</span>`:''}
        </div>
        <div class="scheda-sec-body">
          ${lv.readiness!==undefined?`
          <div class="longevity-summary">
            ${[['sleepScore','Sonno'],['stressScore','Stress'],['movScore','Movimento'],['functionScore','Funz.Fisica'],['energyScore','Energia'],['burdenScore','Carico Clin.']].map(([k,l])=>lv[k]!==undefined?`
            <div class="lv-mini-card">
              <div class="lv-mini-label">${l}</div>
              <div class="lv-mini-value" style="color:${fillColor(lv[k])};">${Math.round(lv[k])}</div>
              <div class="lv-mini-bar"><div class="lv-mini-fill" style="width:${lv[k]}%;background:${fillColor(lv[k])};"></div></div>
            </div>`:'').join('')}
          </div>
          ${lv.agingGap!==undefined?`<div style="margin-top:12px;padding:10px 14px;background:var(--cream);border-radius:8px;font-size:.82rem;">üîÑ Aging Gap: <strong>${Math.round(lv.agingGap)}%</strong> ${lv.topDrivers&&lv.topDrivers.length?`¬∑ Driver: <strong>${lv.topDrivers.join(', ')}</strong>`:''}</div>`:''}
          ${lv.leadIntent!==undefined?`<div style="margin-top:8px;padding:8px 14px;background:#f0edf7;border-radius:8px;font-size:.82rem;">üéØ Lead Intent: <strong style="color:var(--purple);">${Math.round(lv.leadIntent)}/100</strong></div>`:''}
          ${sess.longevityNotes?`<div class="notes-display" style="margin-top:10px;">${sess.longevityNotes}</div>`:''}
          `:`<div class="scheda-empty">Nessuno screening longevity</div><button class="btn-go" style="margin-top:10px;" onclick="switchTab('longevity')">‚ûú Inserisci</button>`}
        </div>
      </div>

      <!-- NOTE VISITA -->
      <div class="scheda-section">
        <div class="scheda-sec-header"><h3>üìù Note Visita</h3></div>
        <div class="scheda-sec-body">
          ${sess.notes?`<div class="notes-display">${sess.notes}</div>`:`<div class="scheda-empty">Nessuna nota per questa visita.</div>`}
        </div>
      </div>

      <!-- MINI TIMELINE STORICO RECENTE -->
      <div class="scheda-section full-width">
        <div class="scheda-sec-header"><h3>‚è± Ultime 5 visite</h3></div>
        <div class="scheda-sec-body">
          ${(()=>{
            const sessions=pat.sessions||{};
            const dates=Object.keys(sessions).sort((a,b)=>b.localeCompare(a)).slice(0,5);
            if(!dates.length)return`<div class="scheda-empty">Nessuna visita precedente.</div>`;
            return `<div class="scheda-timeline">${dates.map(d=>{
              const s=sessions[d];
              const treats=[];
              if(s.gae)treats.push('GAE');if(s.flebo)treats.push('Flebo');if(s.pae)treats.push('PAE');
              const painVal=s.pain&&s.pain.nrs!==undefined?` ¬∑ NRS: ${s.pain.nrs}/10`:'';
              const lvVal=s.longevity&&s.longevity.readiness!==undefined?` ¬∑ LTS: ${Math.round(s.longevity.readiness)}`:'';
              const dotColor=treats.length?'var(--teal)':s.pain||s.longevity?'var(--purple)':'var(--border)';
              return `<div class="timeline-item">
                <div class="timeline-dot" style="background:${dotColor};"></div>
                <div class="timeline-content">
                  <div class="timeline-label">${fmtDate(d)} ${d===state.selectedDate?'<span style="font-size:.7rem;background:var(--teal);color:white;padding:1px 7px;border-radius:10px;margin-left:4px;">oggi</span>':''}</div>
                  <div class="timeline-detail">${treats.length?treats.join(', '):'‚Äî'}${painVal}${lvVal}${(s.products||[]).length?` ¬∑ ${s.products.length} prodotto/i`:''}</div>
                </div>
              </div>`;
            }).join('')}</div>`;
          })()}
        </div>
      </div>

    </div>`}
  </div>`;
}


function renderVisits(pat){
  const sess=getSess(pat.id,state.selectedDate)||{};
  const gae=sess.gae||false;
  const flebo=sess.flebo||false;
  const pae=sess.pae||false;
  const selProds=sess.products||[];

  const allProds=[...PRODUCT_CATALOG,...state.customProducts.map(p=>({cat:"Personalizzati",...p}))];
  const cats=[...new Set(allProds.map(p=>p.cat))];

  return `
  <div class="card patient-hdr">
    <div class="card-header">
      <div>
        <h2>${pat.name}</h2>
        <div class="ptags">
          ${pat.dob?`<span class="ptag">üìÖ ${fmtDate(pat.dob)}</span>`:''}
          ${pat.sex?`<span class="ptag">${pat.sex==='M'?'‚ôÇ':'‚ôÄ'} ${pat.sex}</span>`:''}
          ${pat.diag?`<span class="ptag">ü©∫ ${pat.diag.substring(0,30)}</span>`:''}
        </div>
      </div>
      <div style="display:flex;gap:8px;">
        <button onclick="exportPatientData('${pat.id}')" class="btn-export">üìä Esporta</button>
        <button onclick="deletePat('${pat.id}')" style="background:rgba(255,255,255,.15);border:none;color:rgba(255,255,255,.7);padding:7px 12px;border-radius:7px;cursor:pointer;font-size:.78rem;" onmouseover="this.style.background='rgba(255,80,80,.25)'" onmouseout="this.style.background='rgba(255,255,255,.15)'">üóë</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2>üìã Visita del giorno</h2>
      <div class="date-bar">
        <label>Data:</label>
        <input type="date" id="visitDate" value="${state.selectedDate}" onchange="changeDate(this.value)">
        <button class="btn-today" onclick="changeDate('${todayStr()}')">Oggi</button>
      </div>
    </div>
    <div class="card-body">
      <div class="treat-title">Tipo di trattamento</div>
      <div class="treat-btns">
        <button class="treat-btn ${gae?'selected':''}" onclick="toggleTreat('gae')"><span>üíâ</span> GAE</button>
        <button class="treat-btn ${flebo?'selected':''}" onclick="toggleTreat('flebo')"><span>ü©∏</span> Flebo</button>
        <button class="treat-btn pae ${pae?'selected-pae':''}" onclick="toggleTreat('pae')"><span>üî¨</span> PAE</button>
      </div>

      <div class="expand-panel ${flebo?'visible':''}" id="fleboPanel">
        <div class="treat-title">Prodotti in flebo</div>
        ${cats.map(cat=>`
          <div class="prod-section-title">üì¶ ${cat}</div>
          <div class="products-grid">
            ${allProds.filter(p=>p.cat===cat).map(p=>`
              <div class="product-item ${selProds.includes(p.name)?'checked':''}" onclick="toggleProd('${p.name.replace(/'/g,"\\'").replace(/"/g,'&quot;')}')">
                <div class="check-box"></div>
                <div><div class="prod-label">${p.name}</div><div class="prod-dose">${p.dose}</div></div>
              </div>`).join('')}
          </div>`).join('')}
        <button class="product-manage-btn" onclick="openProdsModal()">‚öôÔ∏è Gestisci prodotti personalizzati</button>
      </div>

      <div class="divider"></div>
      <div class="treat-title">Note visita</div>
      <textarea class="notes-area" id="visitNotes" placeholder="Note aggiuntive...">${sess.notes||''}</textarea>
      <div class="actions-row">
        <button class="btn-save" onclick="saveVisit()">üíæ Salva Visita</button>
        <span id="saveStatus" style="font-size:.78rem;color:var(--teal);font-weight:500;opacity:0;transition:opacity .3s;"></span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>üìÖ Ultime visite</h2></div>
    <div class="card-body">${renderHistoryMini(pat)}</div>
  </div>`;
}

function renderHistoryMini(pat){
  const sessions=pat.sessions||{};
  const dates=Object.keys(sessions).sort((a,b)=>b.localeCompare(a)).slice(0,5);
  if(!dates.length)return`<div class="empty-state" style="padding:20px"><div class="emoji">üì≠</div><p>Nessuna visita registrata.</p></div>`;
  return dates.map(d=>renderSessionRow(pat,d,'mini')).join('');
}

function renderHistory(pat){
  const sessions=pat.sessions||{};
  const dates=Object.keys(sessions).sort((a,b)=>b.localeCompare(a));
  return `<div class="card"><div class="card-header"><h2>üìÖ Storico Completo</h2><button class="btn-export" onclick="exportPatientData('${pat.id}')">üìä Esporta Excel</button></div><div class="card-body">
    ${!dates.length?`<div class="empty-state"><div class="emoji">üì≠</div><p>Nessuna visita.</p></div>`:dates.map(d=>renderSessionRow(pat,d,'full')).join('')}
  </div></div>`;
}

function renderSessionRow(pat,date,mode){
  const s=pat.sessions[date];
  const prods=s.products||[];
  const painNrs=s.pain&&s.pain.nrs!==undefined?s.pain.nrs:null;
  const longevityScore=s.longevity&&s.longevity.readiness!==undefined?Math.round(s.longevity.readiness):null;
  const qs=s.questionari||{};
  const qKeys=Object.keys(qs).filter(k=>qs[k]&&qs[k].scores);

  // Questionnaire badges
  const qBadges=qKeys.map(k=>{
    const sc=qs[k].scores;
    let label='', color='#e8f5e9', textColor='#2e7d32';
    switch(k){
      case 'phq9':   label=`PHQ-9: ${sc.total} (${sc.severity})`; if(sc.total>=10){color='#fff3e0';textColor='#e65100';} if(sc.total>=15){color='#ffebee';textColor='#c62828';} break;
      case 'gad7':   label=`GAD-7: ${sc.total} (${sc.severity})`; if(sc.total>=10){color='#fff3e0';textColor='#e65100';} if(sc.total>=15){color='#ffebee';textColor='#c62828';} break;
      case 'dass21': label=`DASS-21: D${sc.D}/A${sc.A}/S${sc.S}`; color='#f3e5f5';textColor='#6a1b9a'; break;
      case 'midas':  label=`MIDAS: ${sc.total} (${sc.grade})`; color='#e3f2fd';textColor='#1565c0'; break;
      case 'hit6':   label=`HIT-6: ${sc.total} (${sc.impact})`; if(sc.total>=60){color='#ffebee';textColor='#c62828';} break;
      case 'dhi':    label=`DHI: ${sc.total} (${sc.severity})`; color='#e8eaf6';textColor='#283593'; break;
      case 'abc':    label=`ABC: ${sc.avg}%`; color='#e0f7fa';textColor='#006064'; break;
      case 'pcs':    label=`PCS: ${sc.total}${sc.clinical?' ‚ö†Ô∏è':''}`; if(sc.clinical){color='#ffebee';textColor='#c62828';} break;
      case 'csi':    label=`CSI: ${sc.total} (${sc.level})`; if(sc.total>=40){color='#fff3e0';textColor='#e65100';} break;
      case 'msis29': label=`MSIS-29: F${sc.physPct} P${sc.psycPct}`; color='#f3e5f5';textColor='#6a1b9a'; break;
      case 'scd':    label=`SCD-Q: ${sc.total}${sc.concern?' ‚ö†Ô∏è':''}`; color='#e8f5e9';textColor='#2e7d32'; break;
      case 'sf36':   label=`SF-36: PF${sc.PF??'‚Äî'}/MH${sc.MH??'‚Äî'}`; color='#e3f2fd';textColor='#1565c0'; break;
      case 'phenoage': label=`PhenoAge: ${sc.phenoAge}y (gap ${sc.accel>0?'+':''}${sc.accel})`; if(sc.accel>5){color='#ffebee';textColor='#c62828';} else if(sc.accel>0){color='#fff3e0';textColor='#e65100';} break;
      default: label=k.toUpperCase();
    }
    return `<span class="badge" style="background:${color};color:${textColor};border:1px solid ${textColor}33;cursor:pointer;" onclick="event.stopPropagation();openQuestionnaire('${k}','${pat.id}','${date}')">üìù ${label}</span>`;
  }).join('');

  const clickHandler = `openVisitDetail('${pat.id}','${date}')`;

  return `<div class="history-item" style="cursor:pointer;" onclick="${clickHandler}">
    <div class="history-date">${fmtDate(date)}</div>
    <div class="history-content">
      <div class="history-badges">
        ${s.gae?'<span class="badge badge-gae">üíâ GAE</span>':''}
        ${s.flebo?'<span class="badge badge-flebo">ü©∏ Flebo</span>':''}
        ${s.pae?'<span class="badge badge-pae">üî¨ PAE</span>':''}
        ${painNrs!==null?`<span class="badge badge-pain">üî¥ NRS: ${painNrs}/10</span>`:''}
        ${longevityScore!==null?`<span class="badge" style="background:#f0edf7;color:var(--purple);border:1px solid var(--purple)">üß¨ LTS: ${longevityScore}</span>`:''}
        ${prods.slice(0,mode==='mini'?3:100).map(p=>`<span class="badge badge-prod">${p}</span>`).join('')}
        ${mode==='mini'&&prods.length>3?`<span class="badge badge-prod">+${prods.length-3}</span>`:''}
        ${qBadges}
      </div>
      ${s.notes?`<div class="history-notes">"${s.notes.substring(0,100)}${s.notes.length>100?'‚Ä¶':''}"</div>`:''}
    </div>
    <button class="history-del" onclick="event.stopPropagation();deleteSess('${pat.id}','${date}')">üóë</button>
  </div>`;
}

// =====================================================================
// LONGEVITY SCREENING
// =====================================================================
function renderLongevity(pat){
  const sess=getSess(pat.id,state.selectedDate)||{};
  const lv=sess.longevity||{};

  const q=(code,val)=>val!==undefined?`sel`:'';
  const btn=(code,v,label,cur)=>`<button class="scale-btn ${cur===v?'sel':''}" onclick="setLV('${code}',${v})">${label}</button>`;
  const scale=(code,cur)=>[0,1,2,3,4].map(v=>btn(code,v,v,cur)).join('');

  return `
  <div class="card patient-hdr">
    <div class="card-header">
      <div><h2>üß¨ Longevity Screening ‚Äî ${pat.name}</h2></div>
      <div style="display:flex;gap:8px;">
        <div class="date-bar">
          <input type="date" id="visitDate" value="${state.selectedDate}" onchange="changeDate(this.value)" style="border-radius:7px;padding:6px 11px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:white;font-family:'DM Sans',sans-serif;">
          <button class="btn-today" onclick="changeDate('${todayStr()}')" style="border-color:rgba(255,255,255,.5);color:rgba(255,255,255,.8);">Oggi</button>
        </div>
        <button onclick="exportPatientData('${pat.id}')" class="btn-export">üìä Esporta</button>
      </div>
    </div>
  </div>

  ${lv.readiness!==undefined?renderScoreCards(lv):''}

  <div class="card">
    <div class="card-header"><h2>1 ‚Äî Energia e Recupero</h2></div>
    <div class="card-body longevity-container">
      ${renderQItem('A1','Poca energia durante la giornata',lv.A1,'scale')}
      ${renderQItem('A2','Mi sveglio gi√† stanco/a',lv.A2,'scale')}
      ${renderQItem('A3','Rinuncio ad attivit√† per stanchezza',lv.A3,'scale')}
      <div class="scale-labels"><span>Mai (0)</span><span>Quasi sempre (4)</span></div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>2 ‚Äî Funzione Fisica</h2></div>
    <div class="card-body longevity-container">
      ${renderQItem('B1','Difficolt√† a salire una rampa di scale senza fermarsi',lv.B1,'scale')}
      ${renderQItem('B2','Difficolt√† ad alzarmi da una sedia senza mani',lv.B2,'scale')}
      ${renderQItem('B3','Difficolt√† a portare 2 borse per 50m',lv.B3,'scale')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>3 ‚Äî Sonno</h2></div>
    <div class="card-body longevity-container">
      <div class="question-group">
        <div class="question-label"><span class="q-code">C1</span> Ore di sonno per notte (media)</div>
        <input type="number" class="number-input" min="0" max="14" step="0.5" value="${lv.C1||''}" onchange="setLV('C1',parseFloat(this.value))" placeholder="es. 7">
      </div>
      <div class="question-group">
        <div class="question-label"><span class="q-code">C2</span> Tempo per addormentarsi</div>
        <select class="select-input" onchange="setLV('C2',parseInt(this.value))">
          <option value="">--</option>
          <option value="0" ${lv.C2===0?'selected':''}>< 15 min</option>
          <option value="1" ${lv.C2===1?'selected':''}>15-30 min</option>
          <option value="2" ${lv.C2===2?'selected':''}>30-60 min</option>
          <option value="3" ${lv.C2===3?'selected':''}>60-90 min</option>
          <option value="4" ${lv.C2===4?'selected':''}>> 90 min</option>
        </select>
      </div>
      ${renderQItem('C3','Risvegli notturni frequenti',lv.C3,'scale')}
      ${renderQItem('C4','Sonnolenza diurna che interferisce con attivit√†',lv.C4,'scale')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>4 ‚Äî Stress e Resilienza</h2></div>
    <div class="card-body longevity-container">
      ${renderQItem('D1','Sotto pressione / sovraccarico',lv.D1,'scale')}
      ${renderQItem('D2','Difficolt√† a staccare (rimuginio)',lv.D2,'scale')}
      ${renderQItem('D3','Irritabilit√† / bassa tolleranza',lv.D3,'scale')}
      ${renderQItem('D4','Recupero entro 24-48h dopo giornata stressante',lv.D4,'scale',true)}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>5 ‚Äî Movimento e Attivit√†</h2></div>
    <div class="card-body longevity-container">
      <div class="question-group">
        <div class="question-label"><span class="q-code">E1</span> Giorni/settimana attivit√† moderata</div>
        <input type="number" class="number-input" min="0" max="7" value="${lv.E1!==undefined?lv.E1:''}" onchange="setLV('E1',parseInt(this.value))" placeholder="0-7">
      </div>
      <div class="question-group">
        <div class="question-label"><span class="q-code">E2</span> Minuti medi per giorno moderato</div>
        <input type="number" class="number-input" min="0" max="180" value="${lv.E2!==undefined?lv.E2:''}" onchange="setLV('E2',parseInt(this.value))" placeholder="minuti">
      </div>
      <div class="question-group">
        <div class="question-label"><span class="q-code">E3</span> Giorni/settimana forza (pesi/corpo libero)</div>
        <input type="number" class="number-input" min="0" max="7" value="${lv.E3!==undefined?lv.E3:''}" onchange="setLV('E3',parseInt(this.value))" placeholder="0-7">
      </div>
      <div class="question-group">
        <div class="question-label"><span class="q-code">E4</span> Ore seduto/a al giorno</div>
        <select class="select-input" onchange="setLV('E4',parseInt(this.value))">
          <option value="">--</option>
          <option value="0" ${lv.E4===0?'selected':''}>< 4h</option>
          <option value="1" ${lv.E4===1?'selected':''}>4-6h</option>
          <option value="2" ${lv.E4===2?'selected':''}>6-8h</option>
          <option value="3" ${lv.E4===3?'selected':''}>8-10h</option>
          <option value="4" ${lv.E4===4?'selected':''}>> 10h</option>
        </select>
      </div>
      ${renderQItem('E5','Dolore che limita movimento/allenamento',lv.E5,'scale')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>6 ‚Äî Carico Clinico</h2></div>
    <div class="card-body longevity-container">
      ${['F1:Ipertensione (diagnosi/terapia)','F2:Dislipidemia (diagnosi/terapia)','F3:Diabete o prediabete','F4:Fumo attivo','F5:‚â•2 farmaci cronici (esclusi integratori)','F6:Apnea del sonno (diagnosi o forte sospetto)'].map(item=>{
        const[code,label]=item.split(':');
        return renderQItem(code,label,lv[code],'yn');
      }).join('')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>üìä Lead Intent (uso interno)</h2></div>
    <div class="card-body">
      <div class="lead-section">
        <div class="lead-title">üéØ Priorit√† e intenzione percorso</div>
        ${renderQItem('L1','Quanto √® prioritario iniziare un percorso nei prossimi 30 giorni?',lv.L1,'scale')}
        ${renderQItem('L2','Se suggeriti, saresti disposto/a a fare test avanzati (Levine/Horvath)?',lv.L2,'scale')}
        ${renderQItem('L3','Pronto/a a seguire un piano di 8-12 settimane con follow-up?',lv.L3,'scale')}
        ${renderQItem('L4','Realistico dedicare 60-90 min/settimana a interventi?',lv.L4,'scale')}
        <div class="question-group">
          <div class="question-label"><span class="q-code">L5</span> Disponibilit√† a una call orientamento 15 min entro 7 giorni?</div>
          <div class="scale-btns">
            ${[{v:0,l:'No'},{v:2,l:'Forse'},{v:4,l:'S√¨'}].map(o=>`<button class="scale-btn ${lv.L5===o.v?'sel':''}" onclick="setLV('L5',${o.v})">${o.l}</button>`).join('')}
          </div>
        </div>
        ${renderQItem('L6','Disponibilit√† a investire in test e piano personalizzato?',lv.L6,'scale')}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Note Cliniche</h2></div>
    <div class="card-body">
      <textarea class="notes-area" id="lvNotes" placeholder="Note medico / osservazioni...">${(getSess(pat.id,state.selectedDate)||{}).longevityNotes||''}</textarea>
      <div class="actions-row" style="margin-top:14px;">
        <button class="btn-save" onclick="saveLongevity()">üíæ Calcola e Salva</button>
      </div>
    </div>
  </div>`;
}

function renderQItem(code, label, val, type, isPositive=false){
  if(type==='scale'){
    return `<div class="question-group">
      <div class="question-label"><span class="q-code">${code}</span> ${label}</div>
      <div class="scale-btns">${[0,1,2,3,4].map(v=>`<button class="scale-btn ${val===v?'sel':''}" onclick="setLV('${code}',${v})">${v}</button>`).join('')}</div>
    </div>`;
  }
  if(type==='yn'){
    return `<div class="question-group">
      <div class="question-label"><span class="q-code">${code}</span> ${label}</div>
      <div class="yn-btns">
        <button class="yn-btn ${val===false?'sel-no':''}" onclick="setLV('${code}',false)">No</button>
        <button class="yn-btn ${val===true?'sel-yes':''}" onclick="setLV('${code}',true)">S√¨</button>
      </div>
    </div>`;
  }
  return '';
}

function renderScoreCards(lv){
  const doms=[
    {key:'energyScore',label:'Energia'},
    {key:'functionScore',label:'Funzione Fisica'},
    {key:'sleepScore',label:'Sonno'},
    {key:'stressScore',label:'Stress'},
    {key:'movScore',label:'Movimento'},
    {key:'burdenScore',label:'Carico Clinico'},
    {key:'readiness',label:'Readiness'},
    {key:'leadIntent',label:'Lead Intent'},
  ];
  const stClass=v=>v>=70?'st-green':v>=50?'st-yellow':v>=35?'st-orange':'st-red';
  const stLabel=v=>v>=70?'üü¢ Verde':v>=50?'üü° Giallo':v>=35?'üü† Arancione':'üî¥ Rosso';
  return `<div class="card"><div class="card-header"><h2>üìä Punteggi Calcolati</h2></div><div class="card-body">
    <div class="score-grid">
      ${doms.map(d=>{const v=lv[d.key];if(v===undefined)return'';return`<div class="score-card">
        <div class="sc-label">${d.label}</div>
        <div class="sc-value">${Math.round(v)}</div>
        <div class="readiness-bar"><div class="readiness-fill" style="width:${v}%"></div></div>
        <span class="sc-status ${stClass(v)}">${stLabel(v)}</span>
      </div>`;}).join('')}
    </div>
    ${lv.agingGap!==undefined?`<p style="font-size:.85rem;color:var(--ink-li);margin-top:8px;">üîÑ Aging Gap (driver modificabili): <strong>${Math.round(lv.agingGap)}%</strong></p>`:''}
    ${lv.topDrivers&&lv.topDrivers.length?`<p style="font-size:.85rem;margin-top:6px;">üéØ Driver prioritari: <strong>${lv.topDrivers.join(', ')}</strong></p>`:''}
  </div></div>`;
}

// =====================================================================
// PAIN SCALE
// =====================================================================
function renderPainScale(pat){
  const sess=getSess(pat.id,state.selectedDate)||{};
  const pain=sess.pain||{};
  const nrs=pain.nrs;
  const quals=pain.qualities||[];
  const timings=pain.timings||[];
  const locs=pain.locations||[];

  return `
  <div class="card patient-hdr">
    <div class="card-header">
      <div><h2>üìç Scala del Dolore ‚Äî ${pat.name}</h2></div>
      <div style="display:flex;gap:8px;">
        <div class="date-bar">
          <input type="date" id="visitDate" value="${state.selectedDate}" onchange="changeDate(this.value)" style="border-radius:7px;padding:6px 11px;border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:white;font-family:'DM Sans',sans-serif;">
          <button class="btn-today" onclick="changeDate('${todayStr()}')" style="border-color:rgba(255,255,255,.5);color:rgba(255,255,255,.8);">Oggi</button>
        </div>
        <button onclick="exportPatientData('${pat.id}')" class="btn-export">üìä Esporta</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>NRS ‚Äî Scala Numerica del Dolore (0-10)</h2><span style="font-size:.75rem;color:var(--ink-li)">Numeric Rating Scale ¬∑ Jensen & Karoly 1992</span></div>
    <div class="card-body pain-container">
      <div class="pain-section-title">Intensit√† attuale del dolore</div>
      <div class="pain-nrs">
        ${[0,1,2,3,4,5,6,7,8,9,10].map(v=>`
          <button class="pain-btn pain-${v} ${nrs===v?'sel':''}" onclick="setPain('nrs',${v})">
            ${v}
          </button>`).join('')}
      </div>
      <div class="pain-labels">
        <span>Nessun dolore</span>
        <span>Dolore moderato</span>
        <span>Dolore insopportabile</span>
      </div>
      ${nrs!==undefined?`<div style="padding:10px 14px;background:${nrs<=3?'#e8f5e9':nrs<=6?'#fff8e1':'#ffebee'};border-radius:8px;font-size:.85rem;font-weight:500;color:var(--ink);">
        ${nrs===0?'üòä Nessun dolore':nrs<=3?'üü° Dolore lieve ('+nrs+'/10)':nrs<=6?'üü† Dolore moderato ('+nrs+'/10)':nrs<=8?'üî¥ Dolore severo ('+nrs+'/10)':'üî¥ Dolore insopportabile ('+nrs+'/10)'}
      </div>`:''}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Qualit√† del Dolore</h2><span style="font-size:.75rem;color:var(--ink-li)">McGill Pain Questionnaire ‚Äî adattato</span></div>
    <div class="card-body pain-container">
      <div class="pain-section-title">Seleziona le caratteristiche del dolore (multipla)</div>
      <div class="pain-qualitative">
        ${PAIN_QUALITIES.map(q=>`
          <div class="pain-qual-item ${quals.includes(q.id)?'checked':''}" onclick="togglePainQual('${q.id}')">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="check-box"></div>
              <div><div class="pain-qual-label">${q.label}</div><div class="pain-qual-desc">${q.desc}</div></div>
            </div>
          </div>`).join('')}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Andamento Temporale</h2></div>
    <div class="card-body pain-container">
      <div class="pain-section-title">Quando si manifesta il dolore?</div>
      <div class="pain-timing">
        ${PAIN_TIMING.map(t=>`<button class="timing-btn ${timings.includes(t)?'sel':''}" onclick="togglePainTiming('${t}')">${t}</button>`).join('')}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Localizzazione</h2></div>
    <div class="card-body pain-container">
      <div class="pain-section-title">Dove si trova il dolore?</div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        ${PAIN_LOCATIONS.map(l=>`<button class="timing-btn ${locs.includes(l)?'sel':''}" onclick="togglePainLoc('${l}')">${l}</button>`).join('')}
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Impatto Funzionale</h2><span style="font-size:.75rem;color:var(--ink-li)">Brief Pain Inventory ‚Äî adattato</span></div>
    <div class="card-body pain-container">
      ${['painActivity:Interferenza con attivit√† generali','painMood:Interferenza con umore','painWork:Interferenza con lavoro/scuola','painRelations:Interferenza con relazioni sociali','painSleep:Interferenza con sonno','painLifeEnjoy:Interferenza con piacere di vivere'].map(item=>{
        const[code,label]=item.split(':');
        return `<div class="question-group">
          <div class="question-label"><span class="q-code" style="background:#fce4ec;color:#c62828;">${code.replace('pain','')}</span> ${label}</div>
          <div class="scale-btns">${[0,1,2,3,4,5,6,7,8,9,10].map(v=>`<button class="scale-btn ${(pain[code]===v)?'sel':''}" onclick="setPain('${code}',${v})" style="min-width:36px;padding:5px 8px;">${v}</button>`).join('')}</div>
          <div class="scale-labels"><span>Per nulla</span><span>Completamente</span></div>
        </div>`;
      }).join('')}
    </div>
  </div>

  <div class="card">
    <div class="card-header"><h2>Note Dolore</h2></div>
    <div class="card-body">
      <textarea class="notes-area" id="painNotes" placeholder="Descrizione libera, terapie in corso, durata...">${pain.notes||''}</textarea>
      <div class="actions-row" style="margin-top:14px;">
        <button class="btn-save" onclick="savePain()">üíæ Salva Valutazione</button>
      </div>
    </div>
  </div>`;
}

// =====================================================================
// EVENTS
// =====================================================================
function attachEvents(tab, pat){}

// =====================================================================
// ACTIONS ‚Äî VISITS
// =====================================================================
function changeDate(val){state.selectedDate=val;const t=document.querySelector('.tab-btn.active');renderMain(t?['visits','scheda','trend','longevity','pain','questionari','referti','history'][Array.from(document.querySelectorAll('.tab-btn')).indexOf(t)]:'visits');}

function toggleTreat(type){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  sess[type]=!sess[type];
  if(!sess.flebo)sess.products=[];
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('visits');
}

function toggleProd(name){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{flebo:true};
  if(!sess.products)sess.products=[];
  const idx=sess.products.indexOf(name);
  if(idx>=0)sess.products.splice(idx,1);else sess.products.push(name);
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('visits');
}

function saveVisit(){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  const n=document.getElementById('visitNotes');
  if(n)sess.notes=n.value;
  sess.savedAt=new Date().toISOString();
  setSess(state.selectedPatient,state.selectedDate,sess);
  showToast('‚úÖ Visita salvata!','success');
  renderMain('visits');
}

// =====================================================================
// ACTIONS ‚Äî LONGEVITY
// =====================================================================
function setLV(code, val){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.longevity)sess.longevity={};
  sess.longevity[code]=val;
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('longevity');
}

function saveLongevity(){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.longevity)sess.longevity={};
  const lv=sess.longevity;
  const n=document.getElementById('lvNotes');
  if(n)sess.longevityNotes=n.value;
  // Calculate scores
  const calcDomain=(items,positiveItems=[])=>{
    let sum=0,count=0;
    items.forEach(([code,raw])=>{
      if(raw===undefined||raw===null||raw==='')return;
      let sc=positiveItems.includes(code)?raw:(4-raw);
      sum+=sc;count++;
    });
    return count>=1?(sum/(4*count))*100:undefined;
  };
  // Energy
  lv.energyScore=calcDomain([['A1',lv.A1],['A2',lv.A2],['A3',lv.A3]]);
  // Function
  lv.functionScore=calcDomain([['B1',lv.B1],['B2',lv.B2],['B3',lv.B3]]);
  // Sleep
  const c1raw=lv.C1!==undefined?[7.0,6.0,5.0,4.0,-1].findIndex(t=>lv.C1>=(t||0)):undefined;
  const c1sc=lv.C1!==undefined?(lv.C1>=7?0:lv.C1>=6?1:lv.C1>=5?2:lv.C1>=4?3:4):undefined;
  lv.sleepScore=calcDomain([['C1_',c1sc!==undefined?c1sc:undefined],['C2',lv.C2],['C3',lv.C3],['C4',lv.C4]]);
  // Stress
  lv.stressScore=calcDomain([['D1',lv.D1],['D2',lv.D2],['D3',lv.D3],['D4',lv.D4]],['D4']);
  // Movement
  const e1v=lv.E1!==undefined?lv.E1:undefined;
  const e2v=lv.E2!==undefined?lv.E2:undefined;
  let modMins=undefined;
  if(e1v!==undefined&&e2v!==undefined){const t=e1v*e2v;modMins=t>=150?0:t>=90?1:t>=45?2:t>=1?3:4;}
  const e3sc=lv.E3!==undefined?(lv.E3>=3?0:lv.E3>=2?1:lv.E3>=1?2:4):undefined;
  lv.movScore=calcDomain([['E12',modMins],['E3',e3sc!==undefined?(4-e3sc):undefined],['E4',lv.E4],['E5',lv.E5]]);
  // Burden
  const fItems=[lv.F1,lv.F2,lv.F3,lv.F4,lv.F5,lv.F6].filter(x=>x!==undefined);
  if(fItems.length>0){const n_yes=fItems.filter(x=>x===true).length;lv.burdenScore=(1-n_yes/fItems.length)*100;}
  // Readiness
  const scores=[[.20,lv.sleepScore],[.20,lv.stressScore],[.20,lv.movScore],[.15,lv.functionScore],[.15,lv.energyScore],[.10,lv.burdenScore]];
  const valid=scores.filter(([w,s])=>s!==undefined);
  if(valid.length>=3){
    const totalW=valid.reduce((a,[w])=>a+w,0);
    lv.readiness=valid.reduce((a,[w,s])=>a+w*s,0)/totalW;
    lv.agingGap=100-lv.readiness;
  }
  // Lead Intent
  const lItems=[[lv.L1],[lv.L2],[lv.L3],[lv.L4],[lv.L5],[lv.L6]].filter(([x])=>x!==undefined);
  if(lItems.length>=3){lv.leadIntent=lItems.reduce((a,[x])=>a+x,0)/(4*lItems.length)*100;}
  // Top drivers
  const domScores={Sonno:lv.sleepScore,Stress:lv.stressScore,Movimento:lv.movScore,'Funz.Fisica':lv.functionScore,Energia:lv.energyScore};
  lv.topDrivers=Object.entries(domScores).filter(([k,v])=>v!==undefined).sort((a,b)=>a[1]-b[1]).slice(0,3).map(([k])=>k);
  sess.longevity=lv;
  setSess(state.selectedPatient,state.selectedDate,sess);
  showToast('üß¨ Longevity Score calcolato!','success');
  renderMain('longevity');
}

// =====================================================================
// ACTIONS ‚Äî PAIN
// =====================================================================
function setPain(code, val){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.pain)sess.pain={};
  sess.pain[code]=val;
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('pain');
}

function togglePainQual(id){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.pain)sess.pain={};
  if(!sess.pain.qualities)sess.pain.qualities=[];
  const idx=sess.pain.qualities.indexOf(id);
  if(idx>=0)sess.pain.qualities.splice(idx,1);else sess.pain.qualities.push(id);
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('pain');
}

function togglePainTiming(t){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.pain)sess.pain={};
  if(!sess.pain.timings)sess.pain.timings=[];
  const idx=sess.pain.timings.indexOf(t);
  if(idx>=0)sess.pain.timings.splice(idx,1);else sess.pain.timings.push(t);
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('pain');
}

function togglePainLoc(l){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.pain)sess.pain={};
  if(!sess.pain.locations)sess.pain.locations=[];
  const idx=sess.pain.locations.indexOf(l);
  if(idx>=0)sess.pain.locations.splice(idx,1);else sess.pain.locations.push(l);
  setSess(state.selectedPatient,state.selectedDate,sess);
  renderMain('pain');
}

function savePain(){
  const sess=getSess(state.selectedPatient,state.selectedDate)||{};
  if(!sess.pain)sess.pain={};
  const n=document.getElementById('painNotes');
  if(n)sess.pain.notes=n.value;
  setSess(state.selectedPatient,state.selectedDate,sess);
  showToast('‚úÖ Valutazione dolore salvata!','success');
  renderMain('pain');
}

// =====================================================================
// PATIENTS
// =====================================================================
let editingPat=null;
function openAddPat(){editingPat=null;document.getElementById('patModalTitle').textContent='Nuovo Paziente';['patName','patDob','patDiag','patContact'].forEach(id=>document.getElementById(id).value='');document.getElementById('patSex').value='';document.getElementById('patModal').classList.add('open');setTimeout(()=>document.getElementById('patName').focus(),100);}

// savePat, deletePat, deleteSess defined above as async Supabase functions

// =====================================================================
// PRODUCTS
// =====================================================================
function openProdsModal(){renderProdsEdit();document.getElementById('prodsModal').classList.add('open');}
function renderProdsEdit(){
  document.getElementById('prodsEditList').innerHTML=state.customProducts.map((p,i)=>`
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">
      <span style="flex:1;font-size:.875rem;"><strong>${p.name}</strong> <span style="color:var(--ink-li);font-size:.78rem;">${p.dose}</span></span>
      <button onclick="removeCustomProd(${i})" style="background:none;border:none;cursor:pointer;color:var(--rust);font-size:1rem;">‚úï</button>
    </div>`).join('');
}
function addCustomProd(){
  const name=document.getElementById('newProdName').value.trim();
  const dose=document.getElementById('newProdDose').value.trim();
  if(!name)return;
  document.getElementById('newProdName').value='';document.getElementById('newProdDose').value='';
  saveCustomProd(name, dose||'‚Äî');
}

// =====================================================================
// EXCEL EXPORT
// =====================================================================
function exportPatientData(pid){
  const pat=state.patients.find(p=>p.id===pid);
  if(!pat){showToast('‚ö†Ô∏è Paziente non trovato','warning');return;}
  const wb=XLSX.utils.book_new();
  const sessions=pat.sessions||{};
  const sortedDates=Object.keys(sessions).sort();

  // ‚îÄ‚îÄ helper: valore numerico o '' (mai stringhe descrittive) ‚îÄ‚îÄ
  const n=v=>v!==undefined&&v!==null&&v!==''?Number(v):'';
  // ‚îÄ‚îÄ dicotomico: true/1/'S√¨' ‚Üí 1, false/0/'No'/null ‚Üí 0, undefined/mai risposto ‚Üí '' ‚îÄ‚îÄ
  const bin=v=>v===true||v===1?1:v===false||v===0?0:'';
  // ‚îÄ‚îÄ scala 0-4 (gi√† numerica, restituisce intero o '') ‚îÄ‚îÄ
  const s4=v=>v!==undefined&&v!==null&&v!==''?parseInt(v):'';
  // ‚îÄ‚îÄ tutti i prodotti del catalogo per colonne dicotomiche ‚îÄ‚îÄ
  const ALL_PRODS=[...PRODUCT_CATALOG,...state.customProducts.map(p=>({...p}))].map(p=>p.name);
  // ‚îÄ‚îÄ tutte le qualit√† dolore ‚îÄ‚îÄ
  const ALL_QUALITIES=PAIN_QUALITIES.map(q=>q.id);
  const ALL_TIMINGS=PAIN_TIMING;
  const ALL_LOCATIONS=PAIN_LOCATIONS;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 1 ‚Äî Anagrafica Paziente
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const info=[
    ['Campo','Valore'],
    ['paziente_id',pat.id],
    ['nome',pat.name],
    ['data_nascita',pat.dob||''],
    ['sesso_M1_F0',pat.sex==='M'?1:pat.sex==='F'?0:''],
    ['diagnosi',pat.diag||''],
    ['contatto',pat.contact||''],
    ['n_visite_totali',sortedDates.length],
    ['n_gae',sortedDates.filter(d=>sessions[d].gae).length],
    ['n_flebo',sortedDates.filter(d=>sessions[d].flebo).length],
    ['n_pae',sortedDates.filter(d=>sessions[d].pae).length],
    ['n_longevity_screening',sortedDates.filter(d=>sessions[d].longevity&&sessions[d].longevity.readiness!==undefined).length],
    ['n_valutazioni_dolore',sortedDates.filter(d=>sessions[d].pain&&sessions[d].pain.nrs!==undefined).length],
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(info),'Anagrafica');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 2 ‚Äî Visite (una riga per visita)
  // Colonne dicotomiche per ogni prodotto del catalogo
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const visitHeader=[
    'data',
    'gae_0_1',
    'pae_0_1',
    'flebo_0_1',
    'n_prodotti_flebo',
    ...ALL_PRODS.map(p=>'prod__'+p.replace(/[^a-zA-Z0-9]/g,'_')),
    'nrs_dolore_0_10',
    'readiness_0_100',
    'aging_gap_0_100',
    'note_visita'
  ];
  const visitRows=[visitHeader];
  sortedDates.forEach(d=>{
    const s=sessions[d];
    const prods=s.products||[];
    const pain=s.pain||{};
    const lv=s.longevity||{};
    visitRows.push([
      d,
      bin(s.gae),
      bin(s.pae),
      bin(s.flebo),
      prods.length>0?prods.length:0,
      ...ALL_PRODS.map(p=>prods.includes(p)?1:0),
      pain.nrs!==undefined?n(pain.nrs):'',
      lv.readiness!==undefined?Math.round(lv.readiness):'',
      lv.agingGap!==undefined?Math.round(lv.agingGap):'',
      s.notes||''
    ]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(visitRows),'Visite');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 3 ‚Äî Longevity Scoring (punteggi calcolati)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const lvHeader=[
    'data',
    'readiness_0_100',
    'aging_gap_0_100',
    'score_energia_0_100',
    'score_funz_fisica_0_100',
    'score_sonno_0_100',
    'score_stress_0_100',
    'score_movimento_0_100',
    'score_carico_clinico_0_100',
    'lead_intent_0_100',
    'driver_1',
    'driver_2',
    'driver_3',
    'note_cliniche'
  ];
  const lvRows=[lvHeader];
  sortedDates.forEach(d=>{
    const lv=sessions[d].longevity||{};
    if(Object.keys(lv).length===0)return;
    const dr=lv.topDrivers||[];
    lvRows.push([
      d,
      lv.readiness!==undefined?Math.round(lv.readiness):'',
      lv.agingGap!==undefined?Math.round(lv.agingGap):'',
      lv.energyScore!==undefined?Math.round(lv.energyScore):'',
      lv.functionScore!==undefined?Math.round(lv.functionScore):'',
      lv.sleepScore!==undefined?Math.round(lv.sleepScore):'',
      lv.stressScore!==undefined?Math.round(lv.stressScore):'',
      lv.movScore!==undefined?Math.round(lv.movScore):'',
      lv.burdenScore!==undefined?Math.round(lv.burdenScore):'',
      lv.leadIntent!==undefined?Math.round(lv.leadIntent):'',
      dr[0]||'',dr[1]||'',dr[2]||'',
      sessions[d].longevityNotes||''
    ]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(lvRows),'Longevity_Score');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 4 ‚Äî Longevity Risposte Raw
  // Codifica: A1-A3,B1-B3,C2-C4,D1-D3,E4-E5 ‚Üí scala 0-4 (int)
  //           C1 ‚Üí numerico continuo (ore sonno)
  //           D4 ‚Üí scala 0-4 positiva (pi√π alto = meglio)
  //           E1 ‚Üí 0-7 (giorni/sett)
  //           E2 ‚Üí 0-180 (minuti)
  //           E3 ‚Üí 0-7 (giorni/sett forza)
  //           F1-F6 ‚Üí DICOTOMICI 0/1 (patologia s√¨/no)
  //           L1-L4,L6 ‚Üí scala 0-4
  //           L5 ‚Üí 0/2/4
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const qDefs=[
    // [codice, label, tipo]
    ['A1','A1_poca_energia_0neg4neg','s4'],
    ['A2','A2_sveglio_stanco_0neg4neg','s4'],
    ['A3','A3_rinuncia_stanchezza_0neg4neg','s4'],
    ['B1','B1_diff_scale_0neg4neg','s4'],
    ['B2','B2_diff_sedia_0neg4neg','s4'],
    ['B3','B3_diff_borse_0neg4neg','s4'],
    ['C1','C1_ore_sonno_continuo','num'],
    ['C2','C2_latenza_sonno_0neg4neg','s4'],
    ['C3','C3_risvegli_notturni_0neg4neg','s4'],
    ['C4','C4_sonnolenza_diurna_0neg4neg','s4'],
    ['D1','D1_sotto_pressione_0neg4neg','s4'],
    ['D2','D2_rimuginio_0neg4neg','s4'],
    ['D3','D3_irritabilita_0neg4neg','s4'],
    ['D4','D4_recupero_rapido_0pos4pos','s4'],
    ['E1','E1_gg_settimana_attivita_0_7','num'],
    ['E2','E2_minuti_giorno_attivita_0_180','num'],
    ['E3','E3_gg_settimana_forza_0_7','num'],
    ['E4','E4_ore_seduto_0neg4neg','s4'],
    ['E5','E5_dolore_limita_mvt_0neg4neg','s4'],
    ['F1','F1_ipertensione_0_1','bin'],
    ['F2','F2_dislipidemia_0_1','bin'],
    ['F3','F3_diabete_0_1','bin'],
    ['F4','F4_fumo_0_1','bin'],
    ['F5','F5_farmaci_cronici_0_1','bin'],
    ['F6','F6_apnea_sonno_0_1','bin'],
    ['L1','L1_priorita_percorso_0_4','s4'],
    ['L2','L2_disponibilita_test_0_4','s4'],
    ['L3','L3_pronto_piano_0_4','s4'],
    ['L4','L4_tempo_interventi_0_4','s4'],
    ['L5','L5_call_orientamento_0_2_4','s4'],
    ['L6','L6_investimento_0_4','s4'],
  ];
  const lvRawHeader=['data',...qDefs.map(([,lbl])=>lbl)];
  const lvRawRows=[lvRawHeader];
  sortedDates.forEach(d=>{
    const lv=sessions[d].longevity||{};
    if(Object.keys(lv).length===0)return;
    lvRawRows.push([d,...qDefs.map(([code,,tipo])=>{
      const v=lv[code];
      if(tipo==='bin')return bin(v);
      if(tipo==='num')return v!==undefined&&v!==null&&v!==''?Number(v):'';
      return s4(v); // s4
    })]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(lvRawRows),'Longevity_Raw');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 5 ‚Äî Dolore (NRS + impatto + dicotomici qualit√†/andamento/localizzazione)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const painHeader=[
    'data',
    'nrs_0_10',
    // impatto funzionale 0-10
    'bpi_attivita_0_10',
    'bpi_umore_0_10',
    'bpi_lavoro_0_10',
    'bpi_relazioni_0_10',
    'bpi_sonno_0_10',
    'bpi_piacere_vita_0_10',
    // qualit√† dolore ‚Äî DICOTOMICI 0/1
    ...ALL_QUALITIES.map(q=>'qual__'+q+'_0_1'),
    // andamento ‚Äî DICOTOMICI 0/1
    ...ALL_TIMINGS.map(t=>'timing__'+t.replace(/[^a-zA-Z0-9]/g,'_')+'_0_1'),
    // localizzazione ‚Äî DICOTOMICI 0/1
    ...ALL_LOCATIONS.map(l=>'loc__'+l.replace(/[^a-zA-Z0-9]/g,'_')+'_0_1'),
    'note_dolore'
  ];
  const painRows=[painHeader];
  sortedDates.forEach(d=>{
    const pain=sessions[d].pain||{};
    if(Object.keys(pain).length===0)return;
    const quals=pain.qualities||[];
    const timings=pain.timings||[];
    const locs=pain.locations||[];
    painRows.push([
      d,
      pain.nrs!==undefined?n(pain.nrs):'',
      pain.painActivity!==undefined?n(pain.painActivity):'',
      pain.painMood!==undefined?n(pain.painMood):'',
      pain.painWork!==undefined?n(pain.painWork):'',
      pain.painRelations!==undefined?n(pain.painRelations):'',
      pain.painSleep!==undefined?n(pain.painSleep):'',
      pain.painLifeEnjoy!==undefined?n(pain.painLifeEnjoy):'',
      ...ALL_QUALITIES.map(q=>quals.includes(q)?1:0),
      ...ALL_TIMINGS.map(t=>timings.includes(t)?1:0),
      ...ALL_LOCATIONS.map(l=>locs.includes(l)?1:0),
      pain.notes||''
    ]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(painRows),'Dolore');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 6 ‚Äî Questionari
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const qHeaders = ['data','questionario','punteggio_totale','sottoscala_1','val_1','sottoscala_2','val_2','sottoscala_3','val_3','interpretazione'];
  const qRows = [qHeaders];
  dates.forEach(d=>{
    const sess = pat.sessions[d]||{};
    const qs = sess.questionari||{};
    Object.entries(qs).forEach(([qkey, qdata])=>{
      if(!qdata.scores) return;
      const s = qdata.scores;
      let row = [d, qkey.toUpperCase()];
      switch(qkey){
        case 'phq9':   row.push(s.total,'severit√†',s.severity,'','','','',s.severity); break;
        case 'gad7':   row.push(s.total,'severit√†',s.severity,'','','','',s.severity); break;
        case 'dass21': row.push(''   ,'D',s.D,'A',s.A,'S',s.S,s.sevD+'/'+s.sevA+'/'+s.sevS); break;
        case 'midas':  row.push(s.total,'grado',s.grade,'','','','',s.grade); break;
        case 'hit6':   row.push(s.total,'impatto',s.impact,'','','','',s.impact); break;
        case 'dhi':    row.push(s.total,'fisica',s.P,'funzionale',s.F,'emotiva',s.E,s.severity); break;
        case 'abc':    row.push(s.avg,'rischio',s.risk,'','','','',s.risk); break;
        case 'pcs':    row.push(s.total,'ruminazione',s.R,'impotenza',s.I,'magnificazione',s.M,s.clinical?'Clinicamente significativo':''); break;
        case 'csi':    row.push(s.total,'livello',s.level,'','','','',s.level); break;
        case 'msis29': row.push(''   ,'fisica%',s.physPct,'psicol%',s.psycPct,'','',''); break;
        case 'scd':    row.push(s.total,'concern',s.concern?'S√¨':'No','','','','',s.concern?'SCD concern ‚â•6':''); break;
        case 'sf36':   row.push('','PF',s.PF??'','RP',s.RP??'','RE',s.RE??''); break;
        case 'phenoage': row.push(s.phenoAge,'accelerazione',s.accel,'mortalit√†10y',s.mortality+'%','','',s.accel>5?'Accelerato':s.accel>0?'Lieve accelerazione':'Nella norma'); break;
        default: row.push('','','','','','','','');
      }
      qRows.push(row);
      // SF36 extra row with all domains
      if(qkey==='sf36'){
        qRows.push([d,'SF36-domini','PF:'+s.PF+' RP:'+s.RP+' RE:'+s.RE+' VT:'+s.VT+' MH:'+s.MH+' SF:'+s.SF+' BP:'+s.BP+' GH:'+s.GH,'VT',s.VT??'','MH',s.MH??'','SF36 completo']);
      }
    });
  });
  if(qRows.length>1) XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(qRows),'Questionari');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // SHEET 7 ‚Äî PhenoAge dettaglio
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const phenoRows = [['data','eta_anagrafica','phenoage','accelerazione','mortalita_10y_pct','albumina_gdl','creatinina_mgdl','glucosio_mgdl','crp_mgl','linfociti_pct','mcv_fl','rdw_pct','fosf_alcalina_ul','wbc_k']];
  dates.forEach(d=>{
    const qs = (pat.sessions[d]||{}).questionari||{};
    if(qs.phenoage?.scores){
      const s = qs.phenoage.scores;
      const r = qs.phenoage.responses||{};
      phenoRows.push([d,r.age||'',s.phenoAge,s.accel,s.mortality,r.albumin_gdl||'',r.creatinine_mgdl||'',r.glucose_mgdl||'',r.crp_mgl||'',r.lymph_pct||'',r.mcv_fl||'',r.rdw_pct||'',r.alkphos_ul||'',r.wbc_k||'']);
    }
  });
  if(phenoRows.length>1) XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(phenoRows),'PhenoAge');
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const codebook=[
    ['variabile','descrizione','tipo','valori_possibili','note'],
    ['data','Data della visita/sessione','data','YYYY-MM-DD',''],
    ['gae_0_1','Piccola Autoinfusione GAE effettuata','dicotomico','0=No, 1=S√¨',''],
    ['pae_0_1','Piccola Autoemoinfusione PAE effettuata','dicotomico','0=No, 1=S√¨',''],
    ['flebo_0_1','Flebo endovenosa effettuata','dicotomico','0=No, 1=S√¨',''],
    ['n_prodotti_flebo','Numero prodotti somministrati in flebo','continuo','intero ‚â• 0',''],
    ['prod__*','Singolo prodotto somministrato','dicotomico','0=No, 1=S√¨','Una colonna per prodotto'],
    ['nrs_0_10','Intensit√† dolore NRS','ordinale','0‚Äì10','0=nessun dolore, 10=insopportabile'],
    ['readiness_0_100','Longevity Trajectory Score','continuo','0‚Äì100','Composito pesato dei 6 domini'],
    ['aging_gap_0_100','Quota modificabile nel breve (100-Readiness)','continuo','0‚Äì100',''],
    ['score_*_0_100','Punteggio dominio longevity','continuo','0‚Äì100','Pi√π alto = migliore'],
    ['lead_intent_0_100','Lead Intent Score (uso interno)','continuo','0‚Äì100',''],
    ['A1-A3','Energia e recupero','ordinale','0‚Äì4','0=mai, 4=quasi sempre. NEGATIVO: pi√π alto = peggio'],
    ['B1-B3','Funzione fisica','ordinale','0‚Äì4','0=mai, 4=quasi sempre. NEGATIVO: pi√π alto = peggio'],
    ['C1','Ore di sonno per notte','continuo','0‚Äì14','Media riferita agli ultimi 14 giorni'],
    ['C2','Latenza sonno','ordinale','0‚Äì4','0=<15min, 4=>90min. NEGATIVO'],
    ['C3-C4','Qualit√† sonno','ordinale','0‚Äì4','NEGATIVO: pi√π alto = peggio'],
    ['D1-D3','Stress','ordinale','0‚Äì4','NEGATIVO: pi√π alto = peggio'],
    ['D4','Recupero post-stress','ordinale','0‚Äì4','POSITIVO: pi√π alto = meglio'],
    ['E1','Giorni/settimana attivit√† moderata','continuo','0‚Äì7',''],
    ['E2','Minuti/giorno attivit√† moderata','continuo','0‚Äì180',''],
    ['E3','Giorni/settimana esercizio forza','continuo','0‚Äì7',''],
    ['E4','Ore seduto al giorno','ordinale','0‚Äì4','0=<4h, 4=>10h. NEGATIVO'],
    ['E5','Dolore che limita movimento','ordinale','0‚Äì4','NEGATIVO'],
    ['F1-F6','Carico clinico (patologie/fattori di rischio)','dicotomico','0=No, 1=S√¨','Ogni item √® una condizione clinica presente'],
    ['L1-L6','Lead Intent','ordinale/dicotomico','0‚Äì4 (L5: 0/2/4)','Uso interno. Pi√π alto = maggiore intenzione'],
    ['bpi_*_0_10','Impatto funzionale del dolore (BPI)','ordinale','0‚Äì10','0=nessuna interferenza, 10=interferenza completa'],
    ['qual__*_0_1','Qualit√† del dolore (McGill adattato)','dicotomico','0=assente, 1=presente','Una colonna per qualit√†'],
    ['timing__*_0_1','Andamento temporale del dolore','dicotomico','0=assente, 1=presente',''],
    ['loc__*_0_1','Localizzazione anatomica del dolore','dicotomico','0=assente, 1=presente',''],
    ['sesso_M1_F0','Sesso biologico del paziente','dicotomico','1=M, 0=F',''],
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(codebook),'Codebook');

  XLSX.writeFile(wb,`DiarioClinico_${pat.name.replace(/\s+/g,'_')}_${todayStr()}.xlsx`);
  showToast('üìä Excel esportato!','success');
}

function exportAllData(){
  const wb=XLSX.utils.book_new();
  const bin=v=>v===true||v===1?1:v===false||v===0?0:'';
  const n=v=>v!==undefined&&v!==null&&v!==''?Number(v):'';
  const s4=v=>v!==undefined&&v!==null&&v!==''?parseInt(v):'';
  const ALL_PRODS=[...PRODUCT_CATALOG,...state.customProducts.map(p=>({...p}))].map(p=>p.name);
  const ALL_QUALITIES=PAIN_QUALITIES.map(q=>q.id);
  const ALL_TIMINGS=PAIN_TIMING;
  const ALL_LOCATIONS=PAIN_LOCATIONS;

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 1: Pazienti ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const summary=[['paziente_id','nome','data_nascita','sesso_M1_F0','diagnosi','n_visite','n_gae','n_flebo','n_pae','n_longevity','n_dolore']];
  state.patients.forEach(p=>{
    const dates=Object.keys(p.sessions||{});
    summary.push([
      p.id,p.name,p.dob||'',
      p.sex==='M'?1:p.sex==='F'?0:'',
      p.diag||'',
      dates.length,
      dates.filter(d=>p.sessions[d].gae).length,
      dates.filter(d=>p.sessions[d].flebo).length,
      dates.filter(d=>p.sessions[d].pae).length,
      dates.filter(d=>p.sessions[d].longevity&&p.sessions[d].longevity.readiness!==undefined).length,
      dates.filter(d=>p.sessions[d].pain&&p.sessions[d].pain.nrs!==undefined).length,
    ]);
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(summary),'Pazienti');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 2: Tutte le Visite (wide ‚Äî prodotti dicotomici) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const vH=['paziente_id','paziente_nome','data','gae_0_1','pae_0_1','flebo_0_1','n_prodotti_flebo',
    ...ALL_PRODS.map(p=>'prod__'+p.replace(/[^a-zA-Z0-9]/g,'_')),
    'nrs_0_10','readiness_0_100','aging_gap_0_100','note_visita'];
  const allVisits=[vH];
  state.patients.forEach(p=>{
    Object.keys(p.sessions||{}).sort().forEach(d=>{
      const s=p.sessions[d],prods=s.products||[],pain=s.pain||{},lv=s.longevity||{};
      allVisits.push([
        p.id,p.name,d,
        bin(s.gae),bin(s.pae),bin(s.flebo),
        prods.length,
        ...ALL_PRODS.map(pr=>prods.includes(pr)?1:0),
        pain.nrs!==undefined?n(pain.nrs):'',
        lv.readiness!==undefined?Math.round(lv.readiness):'',
        lv.agingGap!==undefined?Math.round(lv.agingGap):'',
        s.notes||''
      ]);
    });
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allVisits),'Visite');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 3: Longevity Scoring ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const lH=['paziente_id','paziente_nome','data','readiness_0_100','aging_gap_0_100',
    'score_energia','score_funz_fisica','score_sonno','score_stress','score_movimento','score_carico_clinico',
    'lead_intent_0_100','driver_1','driver_2','driver_3'];
  const allLv=[lH];
  state.patients.forEach(p=>{
    Object.keys(p.sessions||{}).sort().forEach(d=>{
      const lv=p.sessions[d].longevity||{};
      if(!Object.keys(lv).length)return;
      const dr=lv.topDrivers||[];
      allLv.push([p.id,p.name,d,
        lv.readiness!==undefined?Math.round(lv.readiness):'',
        lv.agingGap!==undefined?Math.round(lv.agingGap):'',
        lv.energyScore!==undefined?Math.round(lv.energyScore):'',
        lv.functionScore!==undefined?Math.round(lv.functionScore):'',
        lv.sleepScore!==undefined?Math.round(lv.sleepScore):'',
        lv.stressScore!==undefined?Math.round(lv.stressScore):'',
        lv.movScore!==undefined?Math.round(lv.movScore):'',
        lv.burdenScore!==undefined?Math.round(lv.burdenScore):'',
        lv.leadIntent!==undefined?Math.round(lv.leadIntent):'',
        dr[0]||'',dr[1]||'',dr[2]||''
      ]);
    });
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allLv),'Longevity_Score');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 4: Longevity Raw ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const qDefs=[
    ['A1','s4'],['A2','s4'],['A3','s4'],
    ['B1','s4'],['B2','s4'],['B3','s4'],
    ['C1','num'],['C2','s4'],['C3','s4'],['C4','s4'],
    ['D1','s4'],['D2','s4'],['D3','s4'],['D4','s4'],
    ['E1','num'],['E2','num'],['E3','num'],['E4','s4'],['E5','s4'],
    ['F1','bin'],['F2','bin'],['F3','bin'],['F4','bin'],['F5','bin'],['F6','bin'],
    ['L1','s4'],['L2','s4'],['L3','s4'],['L4','s4'],['L5','s4'],['L6','s4'],
  ];
  const rH=['paziente_id','paziente_nome','data',...qDefs.map(([c])=>c)];
  const allRaw=[rH];
  state.patients.forEach(p=>{
    Object.keys(p.sessions||{}).sort().forEach(d=>{
      const lv=p.sessions[d].longevity||{};
      if(!Object.keys(lv).length)return;
      allRaw.push([p.id,p.name,d,...qDefs.map(([code,tipo])=>{
        const v=lv[code];
        if(tipo==='bin')return bin(v);
        if(tipo==='num')return v!==undefined&&v!==null&&v!==''?Number(v):'';
        return s4(v);
      })]);
    });
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allRaw),'Longevity_Raw');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 5: Dolore (wide ‚Äî qualit√†/timing/loc dicotomici) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const pH=['paziente_id','paziente_nome','data',
    'nrs_0_10','bpi_attivita_0_10','bpi_umore_0_10','bpi_lavoro_0_10','bpi_relazioni_0_10','bpi_sonno_0_10','bpi_piacere_vita_0_10',
    ...ALL_QUALITIES.map(q=>'qual__'+q+'_0_1'),
    ...ALL_TIMINGS.map(t=>'timing__'+t.replace(/[^a-zA-Z0-9]/g,'_')+'_0_1'),
    ...ALL_LOCATIONS.map(l=>'loc__'+l.replace(/[^a-zA-Z0-9]/g,'_')+'_0_1'),
    'note_dolore'];
  const allPain=[pH];
  state.patients.forEach(p=>{
    Object.keys(p.sessions||{}).sort().forEach(d=>{
      const pain=p.sessions[d].pain||{};
      if(!Object.keys(pain).length)return;
      const quals=pain.qualities||[],timings=pain.timings||[],locs=pain.locations||[];
      allPain.push([p.id,p.name,d,
        pain.nrs!==undefined?n(pain.nrs):'',
        pain.painActivity!==undefined?n(pain.painActivity):'',
        pain.painMood!==undefined?n(pain.painMood):'',
        pain.painWork!==undefined?n(pain.painWork):'',
        pain.painRelations!==undefined?n(pain.painRelations):'',
        pain.painSleep!==undefined?n(pain.painSleep):'',
        pain.painLifeEnjoy!==undefined?n(pain.painLifeEnjoy):'',
        ...ALL_QUALITIES.map(q=>quals.includes(q)?1:0),
        ...ALL_TIMINGS.map(t=>timings.includes(t)?1:0),
        ...ALL_LOCATIONS.map(l=>locs.includes(l)?1:0),
        pain.notes||''
      ]);
    });
  });
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allPain),'Dolore');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 6: Questionari ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const allQH=['paziente_id','paziente_nome','data','questionario','punteggio_totale','sottoscala_1','val_1','sottoscala_2','val_2','sottoscala_3','val_3','interpretazione'];
  const allQ=[allQH];
  state.patients.forEach(p=>{
    Object.keys(p.sessions||{}).sort().forEach(d=>{
      const qs=(p.sessions[d].questionari)||{};
      Object.entries(qs).forEach(([qkey,qdata])=>{
        if(!qdata.scores) return;
        const s=qdata.scores;
        let row=[p.id,p.name,d,qkey.toUpperCase()];
        switch(qkey){
          case 'phq9':    row.push(s.total,'severit√†',s.severity,'','','','',s.severity); break;
          case 'gad7':    row.push(s.total,'severit√†',s.severity,'','','','',s.severity); break;
          case 'dass21':  row.push('','D',s.D,'A',s.A,'S',s.S,s.sevD+'/'+s.sevA+'/'+s.sevS); break;
          case 'midas':   row.push(s.total,'grado',s.grade,'','','','',s.grade); break;
          case 'hit6':    row.push(s.total,'impatto',s.impact,'','','','',s.impact); break;
          case 'dhi':     row.push(s.total,'fisica',s.P,'funzionale',s.F,'emotiva',s.E,s.severity); break;
          case 'abc':     row.push(s.avg,'rischio',s.risk,'','','','',s.risk); break;
          case 'pcs':     row.push(s.total,'ruminazione',s.R,'impotenza',s.I,'magnificazione',s.M,s.clinical?'Clinicamente significativo':''); break;
          case 'csi':     row.push(s.total,'livello',s.level,'','','','',s.level); break;
          case 'msis29':  row.push('','fisica%',s.physPct,'psicol%',s.psycPct,'','',''); break;
          case 'scd':     row.push(s.total,'concern',s.concern?'S√¨':'No','','','','',s.concern?'SCD concern ‚â•6':''); break;
          case 'sf36':    row.push('','PF',s.PF??'','RP',s.RP??'','RE',s.RE??'','SF36'); break;
          case 'phenoage':row.push(s.phenoAge,'accelerazione',s.accel,'mortalit√†10y',s.mortality+'%','','',s.accel>5?'Accelerato':s.accel>0?'Lieve':'Nella norma'); break;
          default: row.push('','','','','','','','');
        }
        allQ.push(row);
      });
    });
  });
  if(allQ.length>1) XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(allQ),'Questionari');

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê Sheet 6: Codebook ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const cb=[
    ['variabile','descrizione','tipo','valori','note'],
    ['gae_0_1','GAE effettuata','dicotomico','0/1',''],
    ['pae_0_1','PAE effettuata','dicotomico','0/1',''],
    ['flebo_0_1','Flebo effettuata','dicotomico','0/1',''],
    ['n_prodotti_flebo','N. prodotti in flebo','continuo','‚â•0',''],
    ['prod__*','Singolo prodotto (una col per prodotto)','dicotomico','0/1',''],
    ['nrs_0_10','NRS dolore','ordinale','0‚Äì10','0=nessuno, 10=insopportabile'],
    ['readiness_0_100','Longevity Trajectory Score','continuo','0‚Äì100',''],
    ['aging_gap_0_100','100-Readiness','continuo','0‚Äì100',''],
    ['score_*','Punteggio dominio longevity','continuo','0‚Äì100','pi√π alto=migliore'],
    ['lead_intent_0_100','Lead Intent Score','continuo','0‚Äì100','uso interno'],
    ['A1-A3','Energia e recupero','ordinale','0‚Äì4','0=mai, 4=sempre. NEGATIVO (alto=peggio)'],
    ['B1-B3','Funzione fisica','ordinale','0‚Äì4','NEGATIVO'],
    ['C1','Ore sonno/notte','continuo','0‚Äì14',''],
    ['C2','Latenza sonno','ordinale','0‚Äì4','0=<15min, 4=>90min. NEGATIVO'],
    ['C3-C4','Qualit√† sonno','ordinale','0‚Äì4','NEGATIVO'],
    ['D1-D3','Stress','ordinale','0‚Äì4','NEGATIVO'],
    ['D4','Recupero post-stress','ordinale','0‚Äì4','POSITIVO'],
    ['E1','Gg/sett attivit√† moderata','continuo','0‚Äì7',''],
    ['E2','Min/giorno attivit√†','continuo','0‚Äì180',''],
    ['E3','Gg/sett forza','continuo','0‚Äì7',''],
    ['E4','Ore seduto/die','ordinale','0‚Äì4','NEGATIVO'],
    ['E5','Dolore che limita mvt','ordinale','0‚Äì4','NEGATIVO'],
    ['F1-F6','Patologie/rischi clinici','dicotomico','0/1','1=presente'],
    ['L1-L4,L6','Lead Intent','ordinale','0‚Äì4',''],
    ['L5','Disponibilit√† call','ordinale','0/2/4',''],
    ['bpi_*','Impatto funzionale dolore','ordinale','0‚Äì10','0=nessuno, 10=totale'],
    ['qual__*','Qualit√† dolore (McGill)','dicotomico','0/1',''],
    ['timing__*','Andamento temporale','dicotomico','0/1',''],
    ['loc__*','Localizzazione','dicotomico','0/1',''],
    ['sesso_M1_F0','Sesso','dicotomico','1=M, 0=F',''],
  ];
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(cb),'Codebook');

  XLSX.writeFile(wb,`DiarioClinico_RICERCA_${todayStr()}.xlsx`);
  showToast('üìä Export ricerca scaricato!','success');
}

// =====================================================================
// UTILS
// =====================================================================
function closeModal(id){document.getElementById(id).classList.remove('open');}
function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.classList.remove('show'),2800);}

document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.getElementById('patName').addEventListener('keydown',e=>{if(e.key==='Enter')savePat();});
document.getElementById('currentDate').textContent=new Date().toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

// Auto-reload when tab becomes visible again or window gets focus
document.addEventListener('visibilitychange', async ()=>{
  if(document.visibilityState === 'visible' && currentUser){
    await loadData();
    renderPatList();
  }
});

window.addEventListener('focus', async ()=>{
  if(currentUser){
    await loadData();
    renderPatList();
  }
});

// Session handled by IIFE above


// =====================================================================
// QUESTIONARI ‚Äî Modulo dati e scoring
// =====================================================================

// =====================================================================
// QUESTIONARI ‚Äî UI Rendering
// =====================================================================
// =====================================================================
// RENDERING UI QUESTIONARI
// =====================================================================

// ‚îÄ‚îÄ Stato questionari ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
var qState = {}; // {phq9:[...], gad7:[...], ...}
var qActive = null; // quale questionario aperto

function initQState(saved){
  qState = saved || {};
}

// ‚îÄ‚îÄ Tab Questionari main render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderQuestionari(pat){
  if(!pat) return '<div class="empty-state"><div class="empty-icon">üìù</div><p>Seleziona un paziente</p></div>';
  const d = state.selectedDate;
  const sess = pat.sessions?.[d] || {};
  const saved = sess.questionari || {};

  const QUESTIONNAIRES = [
    {key:'sf36',   label:'SF-36',    desc:'Qualit√† di vita (8 domini)', icon:'üèÉ', items:36},
    {key:'phq9',   label:'PHQ-9',    desc:'Depressione',                 icon:'üòî', items:9},
    {key:'gad7',   label:'GAD-7',    desc:'Ansia generalizzata',         icon:'üò∞', items:7},
    {key:'dass21', label:'DASS-21',  desc:'Depressione / Ansia / Stress',icon:'üß†', items:21},
    {key:'midas',  label:'MIDAS',    desc:'Disabilit√† da emicrania',     icon:'ü§ï', items:5},
    {key:'hit6',   label:'HIT-6',    desc:'Impatto cefalea',             icon:'üí¢', items:6},
    {key:'dhi',    label:'DHI',      desc:'Handicap da vertigini',       icon:'üåÄ', items:25},
    {key:'abc',    label:'ABC Scale',desc:'Fiducia nell\'equilibrio',    icon:'‚öñÔ∏è', items:16},
    {key:'pcs',    label:'PCS',      desc:'Catastrofizzazione dolore',   icon:'üìç', items:13},
    {key:'csi',    label:'CSI',      desc:'Sensibilizzazione centrale',  icon:'‚ö°', items:25},
    {key:'msis29', label:'MSIS-29',  desc:'Impatto sclerosi multipla',   icon:'üî¨', items:29},
    {key:'scd',    label:'SCD-Q',    desc:'Declino cognitivo soggettivo',icon:'üß©', items:21},
    {key:'phenoage',label:'PhenoAge','desc':'Et√† biologica (Levine)',    icon:'üß¨', items:10},
  ];

  const cards = QUESTIONNAIRES.map(q => {
    const s = saved[q.key];
    const done = s && s.scores;
    let scoreHtml = '';
    if(done){
      scoreHtml = getScoreSummaryHtml(q.key, s.scores);
    }
    return `
    <div class="q-card ${done?'q-done':''}" onclick="openQuestionnaire('${q.key}','${pat.id}','${d}')">
      <div class="q-card-header">
        <span class="q-icon">${q.icon}</span>
        <div class="q-card-title">
          <strong>${q.label}</strong>
          <span class="q-desc">${q.desc}</span>
        </div>
        <div class="q-status">${done?'<span class="q-badge-done">‚úì Completato</span>':'<span class="q-badge-todo">'+q.items+' item</span>'}</div>
      </div>
      ${done?'<div class="q-score-preview">'+scoreHtml+'</div>':''}
    </div>`;
  }).join('');

  // PhenoAge section separate
  return `
  <div class="q-page">
    <div class="q-page-header">
      <h2>üìù Questionari Clinici</h2>
      <span class="q-date-label">${fmtDate(d)}</span>
    </div>
    <div class="q-grid">${cards}</div>
    <div id="qModalArea"></div>
  </div>`;
}

function getScoreSummaryHtml(key, scores){
  if(!scores) return '';
  switch(key){
    case 'phq9':  return `<span class="q-chip">Totale: <strong>${scores.total}/27</strong></span><span class="q-chip q-chip-${severityColor(scores.severity)}">${scores.severity}</span>`;
    case 'gad7':  return `<span class="q-chip">Totale: <strong>${scores.total}/21</strong></span><span class="q-chip q-chip-${severityColor(scores.severity)}">${scores.severity}</span>`;
    case 'dass21':return `<span class="q-chip">D: <strong>${scores.D}</strong></span><span class="q-chip">A: <strong>${scores.A}</strong></span><span class="q-chip">S: <strong>${scores.S}</strong></span>`;
    case 'midas': return `<span class="q-chip">Totale: <strong>${scores.total} giorni</strong></span><span class="q-chip">Grado: <strong>${scores.grade}</strong></span>`;
    case 'hit6':  return `<span class="q-chip">Totale: <strong>${scores.total}/78</strong></span><span class="q-chip">${scores.impact}</span>`;
    case 'dhi':   return `<span class="q-chip">Totale: <strong>${scores.total}/100</strong></span><span class="q-chip">${scores.severity}</span>`;
    case 'abc':   return `<span class="q-chip">Media: <strong>${scores.avg}/100</strong></span><span class="q-chip">${scores.risk}</span>`;
    case 'pcs':   return `<span class="q-chip">Totale: <strong>${scores.total}/52</strong></span>${scores.clinical?'<span class="q-chip q-chip-red">Clinicamente significativo</span>':''}`;
    case 'csi':   return `<span class="q-chip">Totale: <strong>${scores.total}/100</strong></span><span class="q-chip">${scores.level}</span>`;
    case 'msis29':return `<span class="q-chip">Fisica: <strong>${scores.physPct}%</strong></span><span class="q-chip">Psicol: <strong>${scores.psycPct}%</strong></span>`;
    case 'scd':   return `<span class="q-chip">Totale: <strong>${scores.total}/21</strong></span>${scores.concern?'<span class="q-chip q-chip-orange">Concern ‚â•6</span>':''}`;
    case 'sf36':  return `<span class="q-chip">PF: <strong>${scores.PF??'‚Äî'}</strong></span><span class="q-chip">MH: <strong>${scores.MH??'‚Äî'}</strong></span><span class="q-chip">GH: <strong>${scores.GH??'‚Äî'}</strong></span>`;
    case 'phenoage': return `<span class="q-chip">PhenoAge: <strong>${scores.phenoAge} anni</strong></span><span class="q-chip q-chip-${scores.accel>0?'red':'green'}">Accel: ${scores.accel>0?'+':''}${scores.accel} anni</span>`;
    default: return '';
  }
}

function severityColor(s){
  if(!s) return 'gray';
  if(['Minima','Normale','Basso rischio caduta'].includes(s)) return 'green';
  if(['Lieve','Lieve (0-30)'].includes(s)) return 'yellow';
  if(['Moderata','Moderata (31-60)','Moderato'].includes(s)) return 'orange';
  return 'red';
}

// ‚îÄ‚îÄ Apri questionario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openQuestionnaire(key, pid, date){
  qActive = {key, pid, date};
  const sess = (state.patients.find(p=>p.id===pid)?.sessions||{})[date] || {};
  const saved = (sess.questionari||{})[key] || {};
  initQState(saved.responses ? {...qState, [key]: saved.responses} : qState);

  let html = '';
  if(key==='sf36')        html = renderSF36Form(qState.sf36||{});
  else if(key==='phq9')   html = renderLikertForm('phq9', 'PHQ-9 ‚Äî Depressione', PHQ9_QUESTIONS, PHQ9_OPTS, qState.phq9||[], 'Nelle ultime 2 settimane, con quale frequenza ha avuto i seguenti problemi?');
  else if(key==='gad7')   html = renderLikertForm('gad7', 'GAD-7 ‚Äî Ansia', GAD7_QUESTIONS, GAD7_OPTS, qState.gad7||[], 'Nelle ultime 2 settimane, con quale frequenza ha avuto i seguenti problemi?');
  else if(key==='dass21') html = renderLikertForm('dass21', 'DASS-21', DASS21_QUESTIONS.map(q=>q.text), DASS21_OPTS, qState.dass21||[], 'Nell\'ultima settimana, in che misura le seguenti affermazioni si sono applicate a lei?');
  else if(key==='midas')  html = renderNumericForm('midas', 'MIDAS ‚Äî Disabilit√† da emicrania', MIDAS_QUESTIONS, qState.midas||[]);
  else if(key==='hit6')   html = renderLikertForm('hit6', 'HIT-6 ‚Äî Impatto cefalea', HIT6_QUESTIONS, HIT6_OPTS, qState.hit6||[], '');
  else if(key==='dhi')    html = renderLikertForm('dhi', 'DHI ‚Äî Vertigini', DHI_QUESTIONS.map(q=>q.text), DHI_OPTS, qState.dhi||[], 'Per ciascuna delle seguenti domande, risponda S√¨, Talvolta o No:');
  else if(key==='abc')    html = renderABCForm(qState.abc||[]);
  else if(key==='pcs')    html = renderLikertForm('pcs', 'PCS ‚Äî Catastrofizzazione', PCS_QUESTIONS.map(q=>q.text), PCS_OPTS, qState.pcs||[], 'Quando prova dolore, in che misura ha i seguenti pensieri o sentimenti?');
  else if(key==='csi')    html = renderLikertForm('csi', 'CSI ‚Äî Sensibilizzazione centrale', CSI_QUESTIONS, CSI_OPTS, qState.csi||[], 'Quanto spesso ha avuto i seguenti sintomi nell\'ultimo mese?');
  else if(key==='msis29') html = renderLikertForm('msis29', 'MSIS-29 ‚Äî Sclerosi multipla', MSIS29_QUESTIONS.map(q=>q.text), MSIS29_OPTS, qState.msis29||[], 'Nelle ultime 2 settimane, quanto la SM ha influenzato:');
  else if(key==='scd')    html = renderLikertForm('scd', 'SCD-Q ‚Äî Declino cognitivo soggettivo', SCD_QUESTIONS, SCD_OPTS, qState.scd||[], 'Risponda S√¨ o No a ciascuna affermazione:');
  else if(key==='phenoage') html = renderPhenoAgeForm(qState.phenoage||{});

  let modalArea = document.getElementById('qModalArea');
  if(!modalArea){
    modalArea = document.createElement('div');
    modalArea.id = 'qModalArea';
    document.body.appendChild(modalArea);
  }
  modalArea.innerHTML = `
    <div class="q-modal-overlay" onclick="if(event.target===this)closeQModal()">
      <div class="q-modal">
        <button class="q-modal-close" onclick="closeQModal()">‚úï</button>
        ${html}
      </div>
    </div>`;
}

function closeQModal(){
  document.getElementById('qModalArea').innerHTML = '';
  qActive = null;
}

// ‚îÄ‚îÄ Generic Likert form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLikertForm(key, title, questions, opts, saved, intro){
  const items = questions.map((q,i)=>{
    const buttons = opts.map((o,j)=>`
      <button class="q-opt-btn ${saved[i]===j?'selected':''}" onclick="qSelectLikert('${key}',${i},${j},this)">
        ${o}
      </button>`).join('');
    return `
    <div class="q-item ${saved[i]!==undefined?'q-item-answered':''}">
      <div class="q-item-num">${i+1}</div>
      <div class="q-item-body">
        <div class="q-item-text">${q}</div>
        <div class="q-opts-row">${buttons}</div>
      </div>
    </div>`;
  }).join('');

  return `
  <div class="q-form-header">
    <h3>${title}</h3>
    ${intro?`<p class="q-intro">${intro}</p>`:''}
  </div>
  <div class="q-items">${items}</div>
  <div class="q-form-footer">
    <button class="q-save-btn" onclick="saveQuestionnaire('${key}')">‚úÖ Calcola e Salva</button>
  </div>`;
}

function qSelectLikert(key, itemIdx, val, btn){
  if(!qState[key]) qState[key] = [];
  qState[key][itemIdx] = val;
  // Update UI
  btn.closest('.q-opts-row').querySelectorAll('.q-opt-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  btn.closest('.q-item').classList.add('q-item-answered');
}

// ‚îÄ‚îÄ Numeric form (MIDAS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNumericForm(key, title, questions, saved){
  const items = questions.map((q,i)=>`
    <div class="q-item">
      <div class="q-item-num">${i+1}</div>
      <div class="q-item-body">
        <div class="q-item-text">${q}</div>
        <input type="number" min="0" max="90" value="${saved[i]||0}"
          onchange="qSetNumeric('${key}',${i},this.value)"
          class="q-num-input">
      </div>
    </div>`).join('');
  return `
  <div class="q-form-header"><h3>${title}</h3></div>
  <div class="q-items">${items}</div>
  <div class="q-form-footer"><button class="q-save-btn" onclick="saveQuestionnaire('${key}')">‚úÖ Calcola e Salva</button></div>`;
}

function qSetNumeric(key, idx, val){
  if(!qState[key]) qState[key] = [];
  qState[key][idx] = parseInt(val)||0;
}

// ‚îÄ‚îÄ ABC form (0-100 sliders) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderABCForm(saved){
  const items = ABC_QUESTIONS.map((q,i)=>`
    <div class="q-item">
      <div class="q-item-num">${i+1}</div>
      <div class="q-item-body">
        <div class="q-item-text">${q}</div>
        <div class="q-slider-row">
          <span class="q-slider-label">0%</span>
          <input type="range" min="0" max="100" step="10" value="${saved[i]??50}"
            oninput="qSetABC(${i},this.value);document.getElementById('abc_val_${i}').textContent=this.value+'%'"
            class="q-slider">
          <span id="abc_val_${i}" class="q-slider-val">${saved[i]??50}%</span>
          <span class="q-slider-label">100%</span>
        </div>
      </div>
    </div>`).join('');
  return `
  <div class="q-form-header"><h3>ABC Scale ‚Äî Fiducia nell'equilibrio</h3><p class="q-intro">Per ciascuna attivit√†, indichi quanto si sente sicuro/a nel mantenere l'equilibrio (0% = nessuna sicurezza, 100% = completamente sicuro/a):</p></div>
  <div class="q-items">${items}</div>
  <div class="q-form-footer"><button class="q-save-btn" onclick="saveQuestionnaire('abc')">‚úÖ Calcola e Salva</button></div>`;
}

function qSetABC(idx, val){
  if(!qState.abc) qState.abc = Array(16).fill(50);
  qState.abc[idx] = parseInt(val);
}

// ‚îÄ‚îÄ SF-36 form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSF36Form(saved){
  const items = SF36_QUESTIONS.map(q=>{
    const prefix = q.prefix ? `<span class="q-prefix">${q.prefix}</span>` : '';
    const buttons = q.opts.map((o,j)=>`
      <button class="q-opt-btn ${saved[q.n]===j+1?'selected':''}" onclick="qSelectSF36(${q.n},${j+1},this)">
        ${o}
      </button>`).join('');
    return `
    <div class="q-item ${saved[q.n]!==undefined?'q-item-answered':''}">
      <div class="q-item-num">${q.n}</div>
      <div class="q-item-body">
        ${prefix}
        <div class="q-item-text">${q.text}</div>
        <div class="q-opts-row">${buttons}</div>
      </div>
    </div>`;
  }).join('');
  return `
  <div class="q-form-header">
    <h3>SF-36 ‚Äî Qualit√† di vita</h3>
    <p class="q-intro">Le seguenti domande riguardano la sua salute. La preghiamo di rispondere a ciascuna domanda indicando la risposta che le sembra pi√π adatta.</p>
  </div>
  <div class="q-items">${items}</div>
  <div class="q-form-footer"><button class="q-save-btn" onclick="saveQuestionnaire('sf36')">‚úÖ Calcola e Salva</button></div>`;
}

function qSelectSF36(n, val, btn){
  qState.sf36 = qState.sf36 || {};
  qState.sf36[n] = val;
  btn.closest('.q-opts-row').querySelectorAll('.q-opt-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  btn.closest('.q-item').classList.add('q-item-answered');
}

// ‚îÄ‚îÄ PhenoAge form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPhenoAgeForm(saved){
  const fields = PHENOAGE_FIELDS.map(f=>`
    <div class="q-pheno-field">
      <label>${f.label}</label>
      <div class="q-pheno-input-row">
        <input type="number" min="${f.min}" max="${f.max}" step="${f.step}"
          value="${saved[f.key]||''}"
          placeholder="${f.hint||f.label}"
          onchange="qSetPheno('${f.key}',this.value)"
          class="q-pheno-input" id="pheno_${f.key}">
        <span class="q-pheno-unit">${f.unit}</span>
      </div>
      ${f.hint?`<span class="q-pheno-hint">${f.hint}</span>`:''}
    </div>`).join('');

  return `
  <div class="q-form-header">
    <h3>üß¨ PhenoAge ‚Äî Et√† biologica (Levine 2018)</h3>
    <p class="q-intro">Inserisci i valori degli esami del sangue. L'app calcoler√† l'et√† biologica secondo la formula di Levine et al.</p>
  </div>
  <div class="q-pheno-grid">${fields}</div>
  <div id="phenoAgeResult"></div>
  <div class="q-form-footer">
    <button class="q-save-btn q-calc-btn" onclick="calcAndShowPhenoAge()">üßÆ Calcola PhenoAge</button>
    <button class="q-save-btn" id="phenoSaveBtn" style="display:none" onclick="saveQuestionnaire('phenoage')">‚úÖ Salva</button>
  </div>`;
}

function qSetPheno(key, val){
  if(!qState.phenoage) qState.phenoage = {};
  qState.phenoage[key] = parseFloat(val)||null;
}

function calcAndShowPhenoAge(){
  if(!qState.phenoage) qState.phenoage = {};
  // Read current input values
  PHENOAGE_FIELDS.forEach(f=>{
    const el = document.getElementById('pheno_'+f.key);
    if(el) qState.phenoage[f.key] = parseFloat(el.value)||null;
  });
  const inp = qState.phenoage;
  const missing = PHENOAGE_FIELDS.filter(f=>inp[f.key]===null||inp[f.key]===undefined);
  if(missing.length){
    document.getElementById('phenoAgeResult').innerHTML=`<div class="q-error">‚ö†Ô∏è Inserisci tutti i valori. Mancanti: ${missing.map(f=>f.label).join(', ')}</div>`;
    return;
  }
  const r = calcPhenoAge(inp);
  qState.phenoage._scores = r;
  const accelColor = r.accel > 5 ? 'var(--rust)' : r.accel > 0 ? 'var(--gold)' : 'var(--green)';
  document.getElementById('phenoAgeResult').innerHTML=`
  <div class="pheno-result-card">
    <div class="pheno-result-main">
      <div class="pheno-result-item">
        <span class="pheno-label">Et√† biologica</span>
        <span class="pheno-value">${r.phenoAge} <small>anni</small></span>
      </div>
      <div class="pheno-result-item">
        <span class="pheno-label">Accelerazione</span>
        <span class="pheno-value" style="color:${accelColor}">${r.accel>0?'+':''}${r.accel} <small>anni</small></span>
      </div>
      <div class="pheno-result-item">
        <span class="pheno-label">Mortalit√† 10y</span>
        <span class="pheno-value">${(r.mortality).toFixed(1)} <small>%</small></span>
      </div>
    </div>
    <div class="pheno-interp" style="border-left:3px solid ${accelColor}">
      ${r.accel > 5 ? '‚ö†Ô∏è Invecchiamento accelerato significativo ‚Äî considerare interventi' :
        r.accel > 0 ? 'üü° Lieve accelerazione biologica' :
        r.accel > -3 ? '‚úÖ Et√† biologica in linea con quella anagrafica' :
        'üåü Et√† biologica inferiore a quella anagrafica ‚Äî ottimo profilo'}
    </div>
  </div>`;
  document.getElementById('phenoSaveBtn').style.display='inline-flex';
}

// ‚îÄ‚îÄ Save questionnaire ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveQuestionnaire(key){
  if(!qActive) return;
  const {pid, date} = qActive;
  const pat = state.patients.find(p=>p.id===pid);
  if(!pat) return;

  const responses = qState[key];
  let scores = null;

  switch(key){
    case 'phq9':    scores = scorePHQ9(responses||[]); break;
    case 'gad7':    scores = scoreGAD7(responses||[]); break;
    case 'dass21':  scores = scoreDASS21(responses||[]); break;
    case 'midas':   scores = scoreMIDAS(responses||[]); break;
    case 'hit6':    scores = scoreHIT6(responses||[]); break;
    case 'dhi':     scores = scoreDHI(responses||[]); break;
    case 'abc':     scores = scoreABC(responses||[]); break;
    case 'pcs':     scores = scorePCS(responses||[]); break;
    case 'csi':     scores = scoreCSI(responses||[]); break;
    case 'msis29':  scores = scoreMSIS29(responses||[]); break;
    case 'scd':     scores = scoreSCD(responses||[]); break;
    case 'sf36':    scores = scoreSF36(responses||{}); break;
    case 'phenoage':
      const inp = qState.phenoage||{};
      scores = inp._scores || calcPhenoAge(inp);
      responses = {...inp}; delete responses._scores;
      break;
  }

  // Save to session
  if(!pat.sessions) pat.sessions = {};
  if(!pat.sessions[date]) pat.sessions[date] = {};
  if(!pat.sessions[date].questionari) pat.sessions[date].questionari = {};
  pat.sessions[date].questionari[key] = {responses, scores, savedAt: new Date().toISOString()};

  await setSess(pid, date, pat.sessions[date]);
  showToast(`‚úÖ ${key.toUpperCase()} salvato!`, 'success');
  closeQModal();
  renderMain('questionari');
}

// ‚îÄ‚îÄ FILE UPLOAD (referti) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReferti(pat){
  if(!pat) return '<div class="empty-state"><p>Seleziona un paziente</p></div>';
  const d = state.selectedDate;
  const sess = pat.sessions?.[d] || {};
  const files = sess.referti || [];

  return `
  <div class="q-page">
    <div class="q-page-header">
      <h2>üìé Referti & Analisi</h2>
      <span class="q-date-label">${fmtDate(d)}</span>
    </div>
    <div class="upload-area" onclick="document.getElementById('refUpload').click()" id="uploadArea"
      ondrop="handleFileDrop(event,'${pat.id}','${d}')" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')">
      <div class="upload-icon">üì§</div>
      <div class="upload-label">Clicca o trascina qui i file</div>
      <div class="upload-sub">PDF, immagini (JPG, PNG), max 10MB per file</div>
      <input type="file" id="refUpload" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none"
        onchange="handleFileUpload(event,'${pat.id}','${d}')">
    </div>
    <div class="upload-tip">
      üí° <strong>Come scannerizzare:</strong> usa l'app <strong>Adobe Scan</strong> o <strong>Microsoft Lens</strong> sul telefono ‚Äî scatta foto del referto e salva come PDF, poi caricalo qui.
    </div>
    <div class="referti-list" id="refertiList">
      ${files.length===0?'<div class="referti-empty">Nessun file caricato per questa data</div>':files.map((f,i)=>renderRefertCard(f,i,pat.id,d)).join('')}
    </div>
  </div>`;
}

function renderRefertCard(f, idx, pid, date){
  const icon = f.type?.includes('pdf')?'üìÑ':f.type?.includes('image')?'üñºÔ∏è':'üìé';
  const size = f.size ? (f.size/1024/1024).toFixed(2)+'MB' : '';
  const isImg = f.type?.includes('image');
  return `
  <div class="refert-card">
    <div class="refert-header">
      <span class="refert-icon">${icon}</span>
      <div class="refert-info">
        <strong>${f.name}</strong>
        <span class="refert-meta">${size} ¬∑ ${f.uploadedAt?new Date(f.uploadedAt).toLocaleString('it-IT'):''}</span>
      </div>
      <div class="refert-actions">
        <button onclick="previewReferto(${idx},'${pid}','${date}')" class="btn-refert-preview">üëÅ Visualizza</button>
        <button onclick="deleteReferto(${idx},'${pid}','${date}')" class="btn-refert-del">üóë</button>
      </div>
    </div>
    ${isImg?`<img src="${f.dataUrl}" class="refert-thumb" onclick="previewReferto(${idx},'${pid}','${date}')" alt="${f.name}">` : ''}
    <div class="refert-note-row">
      <input type="text" placeholder="Nota sul referto..." value="${f.note||''}"
        onchange="updateRefertNote(${idx},'${pid}','${date}',this.value)"
        class="refert-note-input">
    </div>
  </div>`;
}

function handleFileUpload(event, pid, date){
  const files = Array.from(event.target.files);
  processFiles(files, pid, date);
}

function handleFileDrop(event, pid, date){
  event.preventDefault();
  document.getElementById('uploadArea')?.classList.remove('drag-over');
  const files = Array.from(event.dataTransfer.files);
  processFiles(files, pid, date);
}

async function processFiles(files, pid, date){
  const pat = state.patients.find(p=>p.id===pid);
  if(!pat) return;
  if(!pat.sessions) pat.sessions={};
  if(!pat.sessions[date]) pat.sessions[date]={};
  if(!pat.sessions[date].referti) pat.sessions[date].referti=[];

  showToast('‚è≥ Caricamento in corso...','');
  for(const file of files){
    if(file.size > 10*1024*1024){showToast('‚ö†Ô∏è '+file.name+' supera 10MB','warning');continue;}
    const dataUrl = await fileToDataUrl(file);
    pat.sessions[date].referti.push({
      name: file.name,
      type: file.type,
      size: file.size,
      dataUrl,
      uploadedAt: new Date().toISOString(),
      note: '',
    });
  }
  await setSess(pid, date, pat.sessions[date]);
  showToast('‚úÖ '+files.length+' file caricato/i','success');
  renderMain('referti');
}

function fileToDataUrl(file){
  return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});
}

async function deleteReferto(idx, pid, date){
  if(!confirm('Eliminare questo file?')) return;
  const pat = state.patients.find(p=>p.id===pid);
  if(!pat?.sessions?.[date]?.referti) return;
  pat.sessions[date].referti.splice(idx,1);
  await setSess(pid, date, pat.sessions[date]);
  renderMain('referti');
}

async function updateRefertNote(idx, pid, date, note){
  const pat = state.patients.find(p=>p.id===pid);
  if(!pat?.sessions?.[date]?.referti?.[idx]) return;
  pat.sessions[date].referti[idx].note = note;
  await setSess(pid, date, pat.sessions[date]);
}

function previewReferto(idx, pid, date){
  const pat = state.patients.find(p=>p.id===pid);
  const f = pat?.sessions?.[date]?.referti?.[idx];
  if(!f) return;
  const w = window.open('','_blank');
  if(f.type?.includes('image')){
    w.document.write(`<html><body style="margin:0;background:#111"><img src="${f.dataUrl}" style="max-width:100%;display:block;margin:auto"></body></html>`);
  } else {
    w.document.write(`<html><body style="margin:0"><embed src="${f.dataUrl}" type="application/pdf" width="100%" height="100%" style="min-height:100vh"></body></html>`);
  }
}


// =====================================================================
// VISIT DETAIL MODAL
// =====================================================================
function openVisitDetail(patId, date){
  const pat = state.patients.find(p=>p.id===patId);
  if(!pat) return;
  const s = pat.sessions[date]||{};
  const prods = s.products||[];
  const pain = s.pain||{};
  const lv = s.longevity||{};
  const qs = s.questionari||{};
  const qKeys = Object.keys(qs).filter(k=>qs[k]&&qs[k].scores);

  function section(title, content){
    return `<div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid #f0f0f0;">
      <div style="font-size:.72rem;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:.07em;margin-bottom:10px;">${title}</div>
      ${content}
    </div>`;
  }

  function row(label, value){
    return `<div style="display:flex;justify-content:space-between;padding:4px 0;font-size:.87rem;">
      <span style="color:#666;">${label}</span>
      <span style="color:#222;font-weight:600;">${value}</span>
    </div>`;
  }

  let sections = '';

  // Trattamenti
  if(s.gae||s.flebo||s.pae){
    const badges = [
      s.gae?'<span style="background:#e3f2fd;color:#1565c0;padding:5px 14px;border-radius:20px;font-size:.85rem;font-weight:600;">üíâ GAE</span>':'',
      s.flebo?'<span style="background:#e8f5e9;color:#2e7d32;padding:5px 14px;border-radius:20px;font-size:.85rem;font-weight:600;">ü©∏ Flebo</span>':'',
      s.pae?'<span style="background:#f3e5f5;color:#6a1b9a;padding:5px 14px;border-radius:20px;font-size:.85rem;font-weight:600;">üî¨ PAE</span>':''
    ].filter(Boolean).join(' ');
    sections += section('Trattamenti', `<div style="display:flex;gap:8px;flex-wrap:wrap;">${badges}</div>`);
  }

  // Prodotti
  if(prods.length){
    const pills = prods.map(p=>`<span style="background:#f5f5f5;color:#333;padding:4px 11px;border-radius:12px;font-size:.82rem;">${p}</span>`).join(' ');
    sections += section('Prodotti in flebo', `<div style="display:flex;gap:6px;flex-wrap:wrap;">${pills}</div>`);
  }

  // Dolore
  if(pain.nrs!==undefined){
    let painContent = '';
    painContent += row('NRS Intensit√†', `${pain.nrs}/10`);
    if(pain.painActivity!==undefined) painContent += row('Interferenza attivit√†', `${pain.painActivity}/10`);
    if(pain.painMood!==undefined) painContent += row('Interferenza umore', `${pain.painMood}/10`);
    if(pain.painWork!==undefined) painContent += row('Interferenza lavoro', `${pain.painWork}/10`);
    if(pain.painRelations!==undefined) painContent += row('Interferenza relazioni', `${pain.painRelations}/10`);
    if(pain.painSleep!==undefined) painContent += row('Interferenza sonno', `${pain.painSleep}/10`);
    if(pain.painLifeEnjoy!==undefined) painContent += row('Interferenza benessere', `${pain.painLifeEnjoy}/10`);
    if((pain.qualities||[]).length) painContent += row('Qualit√† dolore', pain.qualities.join(', '));
    if((pain.timings||[]).length) painContent += row('Andamento temporale', pain.timings.join(', '));
    if((pain.locations||[]).length) painContent += row('Localizzazione', pain.locations.join(', '));
    sections += section('üî¥ Scala del Dolore', painContent);
  }

  // Longevity
  if(lv.readiness!==undefined){
    let lvContent = '';
    lvContent += row('Readiness Score', `${Math.round(lv.readiness)}/100`);
    if(lv.agingGap!==undefined) lvContent += row('Aging Gap', `${Math.round(lv.agingGap)}%`);
    const domainNames = {energy:'Energia',physical:'Funzione fisica',sleep:'Sonno',stress:'Stress/Recupero',movement:'Movimento',clinical:'Carico clinico'};
    const domainKeys = ['energy','physical','sleep','stress','movement','clinical'];
    domainKeys.forEach(d=>{if(lv['score_'+d]!==undefined) lvContent += row(domainNames[d]||d, `${Math.round(lv['score_'+d])}/100`);});
    sections += section('üß¨ Longevity Screening', lvContent);
  }

  // Questionari
  if(qKeys.length){
    const qNames = {phq9:'PHQ-9 Depressione',gad7:'GAD-7 Ansia',dass21:'DASS-21',midas:'MIDAS Emicrania',hit6:'HIT-6 Cefalea',dhi:'DHI Vertigini',abc:'ABC Scale',pcs:'PCS Catastrofizzazione',csi:'CSI Sensibilizzazione',msis29:'MSIS-29 SM',scd:'SCD-Q Cognitivo',sf36:'SF-36 Qualit√† della vita',phenoage:'PhenoAge'};

    qKeys.forEach(k=>{
      const sc = qs[k].scores;
      const resp = qs[k].responses||{};
      let qContent = '';

      switch(k){
        case 'phq9':
          qContent += row('Totale', `${sc.total}/27`);
          qContent += row('Severit√†', sc.severity);
          if(Array.isArray(resp)) PHQ9_QUESTIONS.forEach((q,i)=>{
            if(resp[i]!==undefined) qContent += row(q.substring(0,50)+'‚Ä¶', PHQ9_OPTS[resp[i]]||resp[i]);
          });
          break;
        case 'gad7':
          qContent += row('Totale', `${sc.total}/21`);
          qContent += row('Severit√†', sc.severity);
          if(Array.isArray(resp)) GAD7_QUESTIONS.forEach((q,i)=>{
            if(resp[i]!==undefined) qContent += row(q.substring(0,50)+'‚Ä¶', GAD7_OPTS[resp[i]]||resp[i]);
          });
          break;
        case 'dass21':
          qContent += row('Depressione', `${sc.D} (${sc.sevD})`);
          qContent += row('Ansia', `${sc.A} (${sc.sevA})`);
          qContent += row('Stress', `${sc.S} (${sc.sevS})`);
          break;
        case 'midas':
          qContent += row('Totale giorni', sc.total);
          qContent += row('Grado disabilit√†', sc.grade);
          if(Array.isArray(resp)) MIDAS_QUESTIONS.forEach((q,i)=>{
            if(resp[i]!==undefined&&resp[i]!=='') qContent += row(q.label.substring(0,50), `${resp[i]} giorni`);
          });
          break;
        case 'hit6':
          qContent += row('Totale', `${sc.total}/78`);
          qContent += row('Impatto', sc.impact);
          if(Array.isArray(resp)) HIT6_QUESTIONS.forEach((q,i)=>{
            if(resp[i]!==undefined) qContent += row(q.substring(0,50)+'‚Ä¶', HIT6_OPTS[resp[i]]||resp[i]);
          });
          break;
        case 'dhi':
          qContent += row('Totale', `${sc.total}/100 (${sc.severity})`);
          qContent += row('Fisica', sc.P); qContent += row('Funzionale', sc.F); qContent += row('Emotiva', sc.E);
          break;
        case 'abc':
          qContent += row('Media', `${sc.avg}%`);
          qContent += row('Rischio caduta', sc.risk);
          if(Array.isArray(resp)) ABC_QUESTIONS.forEach((q,i)=>{
            if(resp[i]!==undefined) qContent += row(q.substring(0,50)+'‚Ä¶', `${resp[i]}%`);
          });
          break;
        case 'pcs':
          qContent += row('Totale', `${sc.total}/52${sc.clinical?' ‚ö†Ô∏è':''}`);
          qContent += row('Ruminazione', sc.R); qContent += row('Impotenza', sc.I); qContent += row('Magnificazione', sc.M);
          break;
        case 'csi':
          qContent += row('Totale', `${sc.total}/100`);
          qContent += row('Livello', sc.level);
          break;
        case 'msis29':
          qContent += row('Fisico', `${sc.physPct}%`);
          qContent += row('Psicologico', `${sc.psycPct}%`);
          break;
        case 'scd':
          qContent += row('Totale', `${sc.total}/21`);
          qContent += row('SCD Concern', sc.concern?'S√¨ ‚ö†Ô∏è':'No');
          break;
        case 'sf36':
          ['PF','RP','RE','VT','MH','SF','BP','GH'].forEach(d=>{
            if(sc[d]!==undefined) qContent += row(d, `${sc[d]}/100`);
          });
          break;
        case 'phenoage':
          qContent += row('Et√† anagrafica', `${resp.age} anni`);
          qContent += row('Et√† biologica', `${sc.phenoAge} anni`);
          qContent += row('Gap biologico', `${sc.accel>0?'+':''}${sc.accel} anni`);
          qContent += row('Mortalit√† 10 anni', `${sc.mortality}%`);
          if(resp.albumin_gdl) qContent += row('Albumina', `${resp.albumin_gdl} g/dL`);
          if(resp.creatinine_mgdl) qContent += row('Creatinina', `${resp.creatinine_mgdl} mg/dL`);
          if(resp.glucose_mgdl) qContent += row('Glucosio', `${resp.glucose_mgdl} mg/dL`);
          if(resp.crp_mgl) qContent += row('PCR', `${resp.crp_mgl} mg/L`);
          if(resp.lymph_pct) qContent += row('Linfociti %', `${resp.lymph_pct}%`);
          if(resp.mcv_fl) qContent += row('MCV', `${resp.mcv_fl} fL`);
          if(resp.rdw_pct) qContent += row('RDW', `${resp.rdw_pct}%`);
          if(resp.alkphos_ul) qContent += row('Fosfatasi alc.', `${resp.alkphos_ul} U/L`);
          if(resp.wbc_k) qContent += row('WBC', `${resp.wbc_k} 10¬≥/¬µL`);
          break;
      }

      sections += section(`üìù ${qNames[k]||k}`, qContent);
    });
  }

  // Note
  if(s.notes){
    sections += section('Note visita', `<div style="font-size:.88rem;color:#444;line-height:1.6;background:#f9f9f9;padding:12px 14px;border-radius:8px;">${s.notes}</div>`);
  }

  const html = `
    <div style="background:linear-gradient(135deg,#1a1f4e,#2d3561);color:white;padding:20px 24px;display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div style="font-size:.8rem;opacity:.7;margin-bottom:2px;">${pat.name}</div>
        <div style="font-size:1.3rem;font-weight:700;">${fmtDate(date)}</div>
      </div>
      <button onclick="closeVisitDetail()" style="background:rgba(255,255,255,.15);border:none;color:white;width:32px;height:32px;border-radius:50%;cursor:pointer;font-size:1.1rem;">‚úï</button>
    </div>
    <div style="padding:20px 24px;">
      ${sections||'<p style="color:#999;text-align:center;">Nessun dato registrato per questa visita.</p>'}
      <div style="display:flex;gap:10px;margin-top:8px;">
        <button onclick="closeVisitDetail();changeDate('${date}');switchTab('visits')" style="flex:1;padding:10px;border-radius:8px;border:none;background:#1a1f4e;color:white;cursor:pointer;font-size:.88rem;font-weight:600;">‚úèÔ∏è Modifica visita</button>
        <button onclick="closeVisitDetail()" style="padding:10px 16px;border-radius:8px;border:1px solid #ddd;background:white;cursor:pointer;font-size:.88rem;">Chiudi</button>
      </div>
    </div>`;

  document.getElementById('visitDetailContent').innerHTML = html;
  document.getElementById('visitDetailModal').style.display = 'block';
}

function closeVisitDetail(){
  document.getElementById('visitDetailModal').style.display = 'none';
}

</script>

<!-- Visit Detail Modal -->
<div id="visitDetailModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:8000;overflow-y:auto;padding:20px;" onclick="if(event.target===this)closeVisitDetail()">
  <div style="background:white;border-radius:16px;max-width:680px;margin:0 auto;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.3);">
    <div id="visitDetailContent"></div>
  </div>
</div>

</body>
</html>
